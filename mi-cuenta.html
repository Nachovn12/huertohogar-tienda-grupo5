<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta - HuertoHogar</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/favicon/favicon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="assets/favicon/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="96x96" href="assets/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/favicon/favicon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="assets/favicon/favicon-512x512.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png">
    <link rel="manifest" href="assets/favicon/site.webmanifest">
    <link rel="stylesheet" href="assets/css/normalize.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- OpenStreetMap con Leaflet (Mapa real) -->
    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9dKesKspSmeqK11tkJ74bxB5Er3GhGPY&libraries=places&loading=async&callback=initMap"></script>
    <style>
        /* Layout principal */
        .account-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Sidebar */
        .account-sidebar {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
            height: fit-content;
            position: sticky;
            top: 2rem;
        }

        .sidebar-header {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .sidebar-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2E8B57;
            margin: 0 0 1rem 0;
            font-family: 'Playfair Display', serif;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .user-info span:first-child {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .user-balance {
            color: #2E8B57;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 1rem;
            color: #666;
            position: relative;
        }

        .nav-item:hover {
            background: #f8f9fa;
            color: #2E8B57;
            transform: translateX(5px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #2E8B57, #4CAF50);
            color: white;
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: #FFD700;
            border-radius: 0 4px 4px 0;
        }

        .nav-item i {
            font-size: 1.2rem;
            width: 20px;
            text-align: center;
        }

        .logout-item {
            margin-top: 1rem;
            padding-top: 1.5rem;
            border-top: 1px solid #f0f0f0;
            color: #dc3545;
        }

        .logout-item:hover {
            background: #f8d7da;
            color: #dc3545;
        }

        /* Contenido principal */
        .account-content {
            min-height: 600px;
        }

        /* Estilos para la sección de Datos Personales */
        .user-info-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .user-balance-display {
            font-weight: 600;
            color: #2E8B57;
        }

        .profile-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .profile-form-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .profile-form-section h2 {
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .rut-input-container {
            position: relative;
        }

        .rut-checkmark {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            opacity: 0;
            scale: 0.3;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .rut-checkmark.valid {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            opacity: 1;
            scale: 1;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .rut-checkmark.invalid {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            opacity: 1;
            scale: 1;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
        
        
        .rut-input-container.valid input {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .rut-input-container.invalid input {
            border-color: #f44336;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .rut-input-container input {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding-right: 45px; /* Espacio para el ícono */
        }
        
        .rut-input-container input:focus {
            outline: none;
            border-color: #2E8B57;
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.2);
        }
        
        /* Estilos para campo de email readonly */
        #profile-email {
            color: #6B7280 !important; /* Color plomo más suave */
            background-color: #F9FAFB !important; /* Fondo más claro */
            cursor: not-allowed !important;
            font-style: italic; /* Texto en cursiva para indicar que es informativo */
        }
        
        #profile-email:focus {
            border-color: #D1D5DB !important; /* Borde gris al hacer focus */
            box-shadow: none !important; /* Sin sombra al hacer focus */
        }
        
        /* Mejorar el texto descriptivo del email */
        #profile-email + small {
            color: #9CA3AF;
            font-style: italic;
            font-size: 0.85rem;
        }

        .date-input-container {
            position: relative;
            display: flex;
            align-items: center;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            background: #F3F4F6;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 656px;
            height: 52px;
        }

        .date-input-container:focus-within {
            border-color: #2E8B57;
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
        }

        .date-input-container input {
            border: none !important;
            outline: none !important;
            flex: 1;
            padding: 12px 16px !important;
            background: transparent !important;
            font-size: 0.9rem !important;
            color: #374151 !important;
            font-weight: 400 !important;
            height: 100% !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            margin: 0 !important;
            width: auto !important;
            max-width: none !important;
        }

        .date-input-container input::placeholder {
            color: #9CA3AF;
            font-weight: 400;
        }

        .date-input-container input:focus {
            background: transparent !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .date-input-container .fas {
            color: #6B7280;
            font-size: 1.1rem;
            margin-right: 16px;
            transition: color 0.3s ease;
        }

        .date-input-container:hover .fas {
            color: #2E8B57;
        }

        /* Estilos para el calendario */
        #date-picker button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        #prev-month:hover, #next-month:hover {
            background: #E5E7EB !important;
            color: #2E8B57 !important;
        }

        #clear-date:hover {
            background: #d32f2f !important;
        }

        #close-calendar:hover {
            background: #4B5563 !important;
        }

        /* Estilos para los días del calendario */
        .calendar-day {
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: 500;
        }

        .calendar-day:hover {
            background: #F3F4F6;
            color: #2E8B57;
        }

        .calendar-day.selected {
            background: #2E8B57;
            color: white;
        }

        .calendar-day.other-month {
            color: #9CA3AF;
        }

        .calendar-day.today {
            background: #E5E7EB;
            font-weight: 600;
        }

        /* Estilos para el selector de año */
        #year-selector {
            transition: all 0.2s ease;
        }

        #year-selector:focus {
            outline: none;
            border-color: #2E8B57;
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
        }

        #prev-year:hover, #next-year:hover {
            background: #E5E7EB !important;
            color: #2E8B57 !important;
        }


        .phone-input-container {
            display: flex;
            align-items: stretch;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            overflow: hidden;
            background: #F3F4F6;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: none;
            width: 656px;
            height: 52px;
            position: relative;
        }

        .phone-input-container:focus-within {
            border-color: #2E8B57;
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
        }

        .phone-prefix {
            background: #F3F4F6;
            padding: 12px 8px;
            border-right: 1px solid #D1D5DB;
            color: #4B5563;
            font-weight: 500;
            font-size: 0.9rem;
            width: 60px;
            text-align: center;
            user-select: none;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0;
            flex-shrink: 0;
        }


        .phone-input-container input {
            border: none;
            outline: none;
            flex: 1;
            padding: 12px 16px;
            background: #F3F4F6;
            font-size: 0.9rem;
            color: #374151;
            font-weight: 400;
            height: 100%;
            display: flex;
            align-items: center;
            border-radius: 0;
            box-shadow: none;
        }

        .phone-input-container input::placeholder {
            color: #9CA3AF;
            font-weight: 400;
        }

        .phone-input-container input:focus {
            background: transparent;
            border: none;
            outline: none;
            box-shadow: none;
        }
        
        /* Asegurar que el input no tenga estilos de borde heredados */
        .phone-input-container input[type="tel"] {
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            outline: none !important;
        }

        /* Ícono de validación para teléfono */
        .phone-checkmark {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            opacity: 0;
            scale: 0.3;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .phone-checkmark.valid {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            opacity: 1;
            scale: 1;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .phone-checkmark.invalid {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            opacity: 1;
            scale: 1;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }

        /* Estados de validación para el teléfono */
        .phone-input-container.valid {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .phone-input-container.invalid {
            border-color: #f44336;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.1);
        }

        .household-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .household-section h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .household-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .household-inputs select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .diet-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .diet-section h3 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .diet-subtitle {
            color: #666;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .diet-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .diet-tag {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .diet-tag:hover {
            border-color: #2E8B57;
            background: #f8fff8;
        }

        .diet-tag input[type="checkbox"] {
            display: none;
        }

        .diet-tag input[type="checkbox"]:checked + .tag-text {
            color: #2E8B57;
            font-weight: 600;
        }

        .diet-tag input[type="checkbox"]:checked {
            background: #2E8B57;
        }

        .diet-tag:has(input[type="checkbox"]:checked) {
            border-color: #2E8B57;
            background: #f0f8f0;
        }

        .tag-text {
            font-size: 0.9rem;
            color: #333;
            transition: all 0.3s ease;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .form-actions .btn {
            padding: 12px 24px;
            font-size: 1rem;
        }

        /* Estilos para la sección de Saldo */
        .balance-container {
            max-width: 800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .balance-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .balance-card h3 {
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .balance-input-container {
            margin-bottom: 1.5rem;
        }

        .balance-input {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            background: #f8f9fa;
            margin-bottom: 1rem;
        }

        .currency-symbol {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2E8B57;
            margin-right: 0.5rem;
        }

        .balance-amount-input {
            border: none;
            background: transparent;
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            text-align: center;
            width: 120px;
            outline: none;
        }

        .balance-description {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.4;
        }

        .btn-outline-light {
            background: transparent;
            border: 2px solid #2E8B57;
            color: #2E8B57;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-outline-light:hover {
            background: #2E8B57;
            color: white;
        }

        @media (max-width: 768px) {
            .balance-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }

        /* Estilos para la sección HuertoHogar CLUB */
        .club-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .promo-banner {
            background: #000;
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .promo-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            font-weight: 600;
        }

        .promo-content i {
            font-size: 1.2rem;
        }

        .loyalty-level-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .level-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .level-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #2E8B57, #4CAF50);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .level-info h2 {
            color: #333;
            margin: 0 0 1rem 0;
            font-size: 1.5rem;
        }

        .level-stats {
            display: flex;
            gap: 2rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: 600;
            color: #2E8B57;
        }

        .stat-item i {
            color: #2E8B57;
            font-size: 0.9rem;
        }

        .level-description {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }

        .accumulation-message {
            background: #f8f9fa;
            padding: 1rem 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .accumulation-message p {
            margin: 0;
            color: #2E8B57;
            font-weight: 600;
        }

        .transaction-history {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .transaction-history h3 {
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
        }

        .history-table {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-header {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr 1fr;
            background: #f8f9fa;
            padding: 1rem;
            font-weight: 600;
            color: #333;
        }

        .table-empty {
            padding: 2rem;
            text-align: center;
            color: #666;
        }

        .membership-promo {
            background: #FFD700;
            color: #000;
            padding: 1.5rem 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .membership-promo .promo-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }

        .membership-promo span {
            font-weight: 600;
            flex: 1;
        }

        .btn-premium {
            background: #2E8B57;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-premium:hover {
            background: #4CAF50;
        }

        .benefits-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .benefits-section h3 {
            color: #333;
            margin-bottom: 2rem;
            font-size: 1.5rem;
            text-align: center;
        }

        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .benefit-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .benefit-card:hover {
            border-color: #2E8B57;
            background: #f0f8f0;
        }

        .benefit-card i {
            font-size: 2rem;
            color: #2E8B57;
            margin-bottom: 1rem;
        }

        .benefit-card h4 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .benefit-card p {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .level-stats {
                flex-direction: column;
                gap: 1rem;
            }

            .membership-promo .promo-content {
                flex-direction: column;
                text-align: center;
            }

            .benefits-grid {
                grid-template-columns: 1fr;
            }

            .table-header {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
        }

        /* Estilos para la sección de Direcciones */
        .addresses-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .addresses-header {
            margin-bottom: 2rem;
        }

        .addresses-header h2 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
        }

        .addresses-header p {
            color: #666;
            margin: 0;
        }

        .addresses-list {
            margin-bottom: 2rem;
        }

        .address-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .address-card:hover {
            border-color: #2E8B57;
        }

        .address-card.default {
            border-color: #2E8B57;
            background: #f0f8f0;
        }

        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .address-title {
            font-weight: 600;
            color: #333;
        }

        .address-badge {
            background: #2E8B57;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .address-details {
            color: #666;
            margin-bottom: 1rem;
        }

        .address-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 6px;
        }

        .add-address-section {
            text-align: center;
        }

        /* Estilos para el modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 672px;
            max-width: 672px;
            height: 255px;
            max-height: 255px;
            overflow: visible;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
            margin: 0 auto;
            position: relative;
            transform: translateY(0);
            transition: all 0.3s ease;
            text-align: left;
            align-items: center;
            box-sizing: border-box;
            display: block;
            font-family: "Euclid Circular A", sans-serif;
            font-weight: 300;
            line-height: 24px;
            padding: 24px;
            tab-size: 4;
            text-size-adjust: 100%;
            unicode-bidi: isolate;
            -webkit-tap-highlight-color: transparent;
        }

        /* Modal específico para dirección - tamaño original */
        .address-modal {
            width: 672px;
            max-width: 672px;
            height: 255px;
            max-height: 255px;
        }

        /* Modal de dirección expandido - tamaño aumentado */
        .address-modal.expanded {
            width: 750px;
            max-width: 750px;
            height: 600px;
            max-height: 600px;
            animation: modalExpand 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalExpand {
            from {
                width: 672px;
                height: 255px;
                transform: scale(1);
            }
            to {
                width: 750px;
                height: 600px;
                transform: scale(1);
            }
        }

        /* Modal específico para tienda - tamaño correcto */
        .store-modal {
            width: 672px;
            max-width: 672px;
            height: 455px;
            max-height: 455px;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
            padding: 24px;
        }



        .modal-close {
            position: absolute;
            right: 12px;
            top: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            padding: 8px;
            transition: all 0.3s ease;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #334155;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-close svg {
            width: 20px;
            height: 20px;
        }

        .modal-body {
            padding: 0;
            text-align: left;
            height: calc(255px - 40px); /* Altura inicial menos padding del modal */
            overflow: visible; /* Permitir que el dropdown se vea */
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-top: 0;
            box-sizing: border-box;
            font-family: "Euclid Circular A", sans-serif;
            font-weight: 300;
            line-height: 24px;
        }

        /* Modal body expandido para dirección */
        .address-modal.expanded .modal-body {
            padding: 0;
            height: calc(600px - 40px); /* Altura expandida menos padding del modal */
            min-height: auto;
            overflow: visible; /* Sin scroll */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            margin-top: 0;
            box-sizing: border-box;
            font-family: "Euclid Circular A", sans-serif;
            font-weight: 300;
            line-height: 24px;
        }

        /* Estilos específicos para el modal expandido - Diseño profesional */
        .address-modal.expanded .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            text-align: center;
            margin: 0 0 0.5rem 0;
            line-height: 1.3;
            width: 100%;
        }

        .address-modal.expanded .modal-subtitle {
            font-size: 0.95rem;
            font-weight: 500;
            color: #6b7280;
            text-align: center;
            margin: 0 0 1rem 0;
            line-height: 1.3;
            width: 100%;
        }

        .address-modal.expanded .delivery-options {
            display: flex;
            gap: 10px;
            margin: 0 0 1rem 0;
            justify-content: flex-start;
        }

        .address-modal.expanded .delivery-option {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.7rem;
            padding: 0.9rem 1.2rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #ffffff;
            color: #374151;
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.3;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            flex: 0 0 calc(50% - 5px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
            height: 52px;
        }

        .address-modal.expanded .delivery-option:hover {
            border-color: #10b981;
            background: #f0fdf4;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.15);
        }

        .address-modal.expanded .delivery-option.active {
            border-color: #10b981 !important;
            background: #10b981 !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
            transform: translateY(-1px);
        }

        .address-modal.expanded .delivery-icon {
            width: 22px;
            height: 22px;
            fill: #10b981;
            transition: all 0.3s ease;
        }

        .address-modal.expanded .delivery-option.active .delivery-icon {
            fill: white !important;
        }

        .address-modal.expanded .free-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #10b981;
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 700;
            line-height: 1;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Modal body para tienda - tamaño correcto */
        .store-modal .modal-body {
            padding: 0;
            height: calc(455px - 48px); /* Altura correcta menos padding del modal */
            min-height: auto;
            overflow: visible; /* Sin scroll */
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-top: 0;
            box-sizing: border-box;
            font-family: "Euclid Circular A", sans-serif;
            font-weight: 300;
            line-height: 24px;
        }

        /* Optimización específica para modal de tienda - Diseño profesional */
        .store-modal .modal-title {
            margin: 0 0 0.5rem 0;
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            text-align: center;
            line-height: 1.3;
            width: 100%;
        }

        .store-modal .modal-subtitle {
            margin: 0 0 1rem 0;
            font-size: 0.95rem;
            color: #6b7280;
            font-weight: 500;
            text-align: center;
            line-height: 1.3;
            width: 100%;
        }

        .store-modal .delivery-options {
            display: flex;
            gap: 10px;
            margin: 0 0 1rem 0;
            justify-content: flex-start;
        }

        .store-modal .stores-carousel {
            margin: 0.5rem 0;
        }

        .store-modal .carousel-viewport {
            height: 150px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .store-modal .store-card {
            min-height: 110px;
            padding: 1.25rem;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .store-modal .store-card:hover {
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
            transform: translateY(-1px);
        }

        .store-modal .store-image {
            width: 95px;
            height: 95px;
            border: 2px solid #f3f4f6;
        }

        .store-modal .store-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .store-modal .store-address {
            font-size: 0.75rem;
            color: #4b5563;
            margin-bottom: 0.2rem;
        }

        .store-modal .store-hours {
            font-size: 0.7rem;
            color: #6b7280;
            line-height: 1.4;
        }

        .store-modal .store-status {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            margin-bottom: 0.3rem;
            width: fit-content;
        }

        .store-modal .store-status.open {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .store-modal .store-status.closed {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .store-modal .carousel-controls {
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .store-modal .carousel-prev,
        .store-modal .carousel-next {
            width: 40px;
            height: 40px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .store-modal .carousel-prev:hover,
        .store-modal .carousel-next:hover {
            background: #f9fafb;
            border-color: #10b981;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .store-modal .pagination-bullet {
            width: 8px;
            height: 8px;
            background: #d1d5db;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .store-modal .pagination-bullet.active {
            background: #10b981;
            transform: scale(1.2);
        }

        .store-modal .carousel-actions {
            margin-top: 0.5rem;
        }

        .store-modal .carousel-actions .btn {
            height: 40px;
            background: #6b7280;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .store-modal .carousel-actions .btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        /* Mejoras adicionales para elegancia del modal de tienda */
        .store-modal .delivery-option {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.7rem;
            padding: 0.9rem 1.2rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #ffffff;
            color: #374151;
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.3;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            flex: 0 0 calc(50% - 5px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
            height: 52px;
        }

        .store-modal .delivery-icon {
            width: 22px;
            height: 22px;
            fill: #10b981;
            transition: all 0.3s ease;
        }

        .store-modal .delivery-option:hover {
            border-color: #10b981;
            background: #f0fdf4;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.15);
        }

        .store-modal .delivery-option.active {
            border-color: #10b981 !important;
            background: #10b981 !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
            transform: translateY(-1px);
        }

        .store-modal .delivery-option.active .delivery-icon {
            fill: white !important;
        }

        .store-modal .free-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #10b981;
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.2rem 0.4rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        /* Animaciones suaves para todos los modales - optimizadas */
        .modal-content {
            animation: modalSlideIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .store-modal {
            animation: modalSlideIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .address-modal {
            animation: modalSlideIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Animación de salida - optimizada */
        .modal-content.closing {
            animation: modalSlideOut 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .store-modal.closing {
            animation: modalSlideOut 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .address-modal.closing {
            animation: modalSlideOut 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-30px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes modalSlideOut {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            to {
                opacity: 0;
                transform: scale(0.9) translateY(-30px);
            }
        }

        /* Animación del overlay - optimizada */
        .modal-overlay {
            animation: overlayFadeIn 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.closing {
            animation: overlayFadeOut 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes overlayFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(4px);
            }
        }

        @keyframes overlayFadeOut {
            from {
                opacity: 1;
                backdrop-filter: blur(4px);
            }
            to {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
        }

        /* Mejora del overlay para el modal de tienda */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
        }


        /* Estilos para el nuevo diseño del modal */
        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            text-align: center;
            margin: 0 0 0.5rem 0;
            line-height: 1.3;
            width: 100%;
        }

        .modal-subtitle {
            font-size: 0.95rem;
            font-weight: 500;
            color: #6b7280;
            text-align: center;
            margin: 0 0 1rem 0;
            line-height: 1.3;
            width: 100%;
        }

        /* Opciones de entrega */
        .delivery-options {
            display: flex;
            gap: 10px;
            margin: 0 0 1rem 0;
            justify-content: flex-start;
        }

        .delivery-option {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.7rem;
            padding: 0.9rem 1.2rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #ffffff;
            color: #374151;
            font-weight: 600;
            font-size: 0.95rem;
            line-height: 1.3;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            flex: 0 0 calc(50% - 4px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.08);
            height: 52px;
            animation: buttonSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes buttonSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .delivery-option:hover {
            border-color: #10b981;
            background: #f0fdf4;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.1);
        }

        .delivery-option.active {
            border-color: #10b981 !important;
            background: #10b981 !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
            transform: translateY(-1px);
        }

        .delivery-icon {
            width: 22px;
            height: 22px;
            fill: #10b981;
            transition: all 0.3s ease;
        }

        .delivery-option.active .delivery-icon {
            fill: white !important;
        }

        .free-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #10b981;
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 8px;
            font-size: 0.65rem;
            font-weight: 700;
            line-height: 1;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Campo de dirección */
        .initial-address-field {
            margin: 0.5rem 0 0.8rem 0;
            display: flex;
            justify-content: center;
            width: 100%;
            position: relative;
            z-index: 10;
        }
        
        .initial-address-field input {
            width: 100%;
            max-width: 632px;
            height: 48px;
            padding: 0.7rem 1rem;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background: #fff;
            display: inline-block;
            float: none;
            position: static;
            box-sizing: border-box;
        }
        
        .initial-address-field input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .address-input-container {
            margin: 0.3rem 0;
            width: 100%;
            max-width: 100%;
            position: relative;
            display: none; /* Oculto por defecto */
        }

        /* Mostrar contenedor de dirección solo cuando el modal de dirección esté expandido */
        .address-modal.expanded .address-input-container {
            display: block;
            animation: contentFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) 0.1s both;
        }

        .address-modal.expanded .map-container {
            animation: contentFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) 0.2s both;
        }

        .address-modal.expanded .continue-button-container {
            animation: contentFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) 0.3s both;
        }

        @keyframes contentFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .address-form {
            margin-bottom: 1.25rem;
        }

        .address-input-container .input-with-validation {
            position: relative;
            margin-bottom: 1rem;
        }

        .input-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
        }

        /* Layout horizontal de campos de dirección */
        .campos-direccion {
            display: flex;
            gap: 8px;
            width: 100%;
            margin-bottom: 0.75rem;
            align-items: stretch;
        }
        
        /* Campo principal de dirección - mismo ancho que los botones de entrega */
        .campo-direccion-principal {
            flex: 0 0 calc(50% - 4px);
            min-width: 0;
        }
        
        /* Contenedor para los campos Numero y Depto - mismo ancho que el botón "Retiro en tienda" */
        .campos-secundarios {
            display: flex;
            gap: 8px;
            flex: 0 0 calc(50% - 4px);
            min-width: 0;
        }
        
        /* Campo de número - mitad del ancho del contenedor */
        .campo-numero {
            flex: 1;
            min-width: 0;
        }
        
        /* Campo de depto/casa/ofic - mitad del ancho del contenedor */
        .campo-depto {
            flex: 1;
            min-width: 0;
        }
        
        /* Estilos para todos los inputs de los campos */
        .campos-direccion input {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            background: white;
            color: #111827;
            height: 2.5rem;
            box-sizing: border-box;
        }
        
        .campos-direccion input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        /* Estilos específicos para inputs en campos secundarios */
        .campos-secundarios input {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            background: white;
            color: #111827;
            height: 2.5rem;
            box-sizing: border-box;
        }
        
        .campos-secundarios input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        /* Estilo específico para el input principal con validación */
        .campo-direccion-principal .input-with-validation {
            position: relative;
            width: 100%;
        }
        
        .campo-direccion-principal .input-with-validation input {
            padding-right: 2.5rem; /* Espacio para el icono de validación */
        }
        
        .campo-direccion-principal .input-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
        }
        
        /* Responsive para móviles */
        @media (max-width: 768px) {
            .campos-direccion {
                flex-direction: column;
                gap: 8px;
            }
            
            .campo-direccion-principal {
                flex: 1;
                min-width: auto;
                max-width: none;
            }
            
            .campos-secundarios {
                flex: 1;
                min-width: auto;
            }
            
            .campo-numero,
            .campo-depto {
                flex: 1;
                min-width: auto;
            }
        }

        .region-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            margin-bottom: 0.75rem;
            margin-left: 0;
            margin-right: 0;
            color: #6b7280;
        }

        .region-info strong {
            color: #374151;
        }

        .address-input-container input {
            width: 100%;
            height: 48px;
            padding: 0.7rem 1rem;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
            color: #111827;
            box-sizing: border-box;
        }

        .address-input-container input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .address-input-container input:valid {
            border-color: #10b981;
        }

        /* Estilos para el carrusel de tiendas */
        .stores-carousel {
            margin: 0.1rem 0;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            animation: carouselSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes carouselSlideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .carousel-viewport {
            position: relative;
            overflow: hidden;
            margin-bottom: 0.1rem;
            width: 100%;
            height: 140px;
            border-radius: 8px;
            flex: 1;
        }

        .carousel-camera {
            display: flex;
            transition: transform 0.3s ease;
            width: 100%;
            height: 100%;
        }

        .carousel-content {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .store-card {
            flex: 0 0 100%;
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            min-height: 100px;
        }

        .store-card:hover {
            border-color: #d1d5db;
        }

        .store-card.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .store-card-content {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .store-image {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            background: #FFD700;
        }

        .store-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .store-status {
            display: inline-block;
            font-size: 0.65rem;
            font-weight: 600;
            margin-bottom: 0.4rem;
            padding: 0.15rem 0.5rem;
            border-radius: 20px;
            background: #fce7f3;
            color: #dc2626;
            border: 1px solid #f9a8d4;
            width: fit-content;
        }

        .store-status.open {
            background: #dcfce7;
            color: #16a34a;
            border: 1px solid #bbf7d0;
            animation: pulse 2s infinite;
        }

        .store-status.closed {
            background: #fce7f3;
            color: #dc2626;
            border: 1px solid #f9a8d4;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .store-name {
            font-size: 0.85rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 0.3rem 0;
        }

        .store-address {
            font-size: 0.7rem;
            color: #374151;
            margin: 0 0 0.25rem 0;
            font-weight: 500;
        }

        .store-hours {
            font-size: 0.65rem;
            color: #374151;
            margin: 0;
            line-height: 1.4;
            display: block;
            font-weight: 500;
        }

        @media (min-width: 640px) {
            .store-hours {
                display: block;
            }
        }

        /* Controles del carrusel */
        .carousel-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.6rem;
            margin-bottom: 0.4rem;
            padding: 0 0.5rem;
        }

        .carousel-prev,
        .carousel-next {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            font-size: 1rem;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .carousel-prev:hover,
        .carousel-next:hover {
            background: #e9ecef;
            color: #059669;
            border-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .carousel-pagination {
            display: flex;
            gap: 0.6rem;
            align-items: center;
        }

        .pagination-bullet {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #d1d5db;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination-bullet.active {
            background: #059669;
            width: 28px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(5, 150, 105, 0.3);
        }

        .carousel-actions {
            display: flex;
            justify-content: center;
            margin-top: 0.4rem;
        }

        .carousel-actions .btn {
            width: 100%;
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            height: 36px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 1px 3px rgba(107, 114, 128, 0.2);
        }

        .carousel-actions .btn:hover {
            background: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(107, 114, 128, 0.3);
        }

        .carousel-actions .btn:disabled {
            background: #D3D3D3;
            color: #808080;
            cursor: not-allowed;
            transform: none;
        }

        /* Responsive para el carrusel */
        @media (max-width: 768px) {
            .store-card {
                padding: 0.75rem;
            }
            
            .store-image {
                width: 60px;
                height: 60px;
            }
            
            .store-name {
                font-size: 0.75rem;
            }
            
            .store-address {
                font-size: 0.65rem;
            }
            
            .carousel-controls {
                gap: 0.5rem;
            }
            
            .carousel-prev,
            .carousel-next {
                font-size: 1.2rem;
                padding: 0.25rem;
            }
        }

        .modal-description {
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .input-with-validation {
            position: relative;
        }

        .validation-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #4CAF50;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .form-help {
            display: block;
            margin-top: 0.5rem;
            color: #666;
            font-size: 0.8rem;
            font-style: italic;
        }

        /* Estilos para campos de dirección como en FREST */
        .address-fields {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .address-fields .form-group {
            margin-bottom: 0;
        }

        .address-fields .form-group:first-child {
            grid-column: 1;
        }

        .address-fields .form-group:nth-child(2) {
            grid-column: 2;
        }

        .address-fields .form-group:nth-child(3) {
            grid-column: 3;
        }

        .address-fields label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #333;
            margin-bottom: 0.5rem;
            display: block;
        }

        .address-fields input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            background: white;
        }

        .address-fields input:focus {
            outline: none;
            border-color: #2E8B57;
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
        }

        .address-fields input:valid {
            border-color: #4CAF50;
        }

        /* Responsive para campos de dirección */
        @media (max-width: 768px) {
            .address-fields {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .address-fields .form-group {
                grid-column: 1 !important;
            }
        }

        /* Estilos para el menú desplegable de sugerencias */
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            max-height: none;
            overflow: visible;
            margin-top: 4px;
        }

        /* Estilos específicos para el dropdown del campo inicial */
        #initial-address-suggestions {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 632px;
            margin-top: 4px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background: white;
            max-height: none;
            overflow: visible;
            z-index: 1000;
        }

        .suggestions-list {
            padding: 0;
            margin: 0;
        }

        .suggestion-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease;
            font-size: 0.85rem;
            color: #374151;
            line-height: 1.3;
        }

        .suggestion-item:hover {
            background-color: #f8fafc;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item.active {
            background-color: #f0fdf4;
            color: #059669;
        }

        /* Estilos específicos para el dropdown del campo inicial */
        #initial-address-suggestions .suggestion-item {
            padding: 10px 16px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.85rem;
            color: #374151;
            background: white;
            display: block;
            line-height: 1.3;
        }

        #initial-address-suggestions .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-icon {
            color: #2E8B57;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .suggestion-content {
            flex: 1;
        }

        .suggestion-text {
            font-weight: 500;
            color: #374151;
            line-height: 1.4;
        }

        .suggestion-highlight {
            background-color: #fff3cd;
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* Estilos para información de ubicación */
        .location-info {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #2E8B57;
        }

        .location-text {
            color: #666;
            font-size: 0.9rem;
        }

        .location-text strong {
            color: #2E8B57;
            font-weight: 600;
        }

        .location-context {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            color: #666;
        }

        .map-container {
            margin: 1rem 0;
            border-radius: 8px;
            overflow: hidden;
            height: 220px; /* Aumentado otro 5% desde 210px */
            border: 1px solid #e5e7eb;
            display: none; /* Oculto por defecto */
        }

        /* Mostrar mapa solo cuando el modal de dirección esté expandido */
        .address-modal.expanded .map-container {
            display: block;
        }

        .map {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Mapa de respaldo */
        .map-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            border-radius: 8px;
        }

        .map-placeholder {
            text-align: center;
            padding: 2rem;
        }

        /* Estilos específicos para Google Maps */
        .map-container .map {
            position: relative;
            overflow: hidden;
        }

        /* Estilos para marcadores personalizados de Leaflet */
        .custom-marker {
            background: transparent;
            border: none;
        }
        
        .marker-circle {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2E8B57, #4CAF50);
            border: 3px solid #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .marker-number {
            color: #ffffff;
            font-weight: bold;
            font-size: 16px;
            font-family: Arial, sans-serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* Efectos hover mejorados */
        .marker-circle:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(46, 139, 87, 0.4);
            border-color: #FFD700;
        }

        /* Estilos para popups personalizados */
        .custom-popup .leaflet-popup-content-wrapper {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border: 2px solid #2E8B57;
        }
        
        .custom-popup .leaflet-popup-content {
            margin: 15px;
            font-family: 'Montserrat', sans-serif;
        }
        
        .custom-popup .leaflet-popup-tip {
            background: #ffffff;
            border: 2px solid #2E8B57;
        }

        .map-instructions {
            background: #f8f9fa;
            padding: 1rem;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }

        /* Contenedor del botón Continuar */
        .continue-button-container {
            display: flex;
            justify-content: center;
            margin-top: 2.19rem; /* Reducido otro 10% desde 2.43rem para subir el botón */
            margin-bottom: 1rem;
            width: 100%;
        }

        /* Botón Continuar con especificaciones exactas del inspector */
        .continue-btn {
            background-color: #297E36;
            border: none;
            border-radius: 10px;
            color: #FFFFFF;
            display: inline-block;
            font-family: "Euclid Circular A", sans-serif;
            font-weight: 600;
            line-height: 1.3;
            padding: 0.8rem 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            width: 100%;
            max-width: 632px;
            height: 50px; /* Aumentado un 5% desde 48px */
            box-sizing: border-box;
            box-shadow: 0 3px 6px rgba(41, 126, 54, 0.2);
        }

        .continue-btn:hover {
            background-color: #1f5a2a;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(41, 126, 54, 0.3);
        }

        .continue-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(41, 126, 54, 0.3);
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
            width: 100%;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 100%;
                margin: 0;
                border-radius: 0;
                max-height: 100vh;
            }

            .address-modal.expanded {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
            }

            .modal-body {
                padding: 24px 16px 20px;
            }

            .address-modal.expanded .modal-body {
                height: calc(100vh - 40px);
            }

            .modal-title {
                font-size: 1.25rem;
                margin-bottom: 0.75rem;
            }

            .modal-subtitle {
                font-size: 0.875rem;
                margin-bottom: 1.25rem;
            }

            .delivery-option {
                font-size: 0.875rem;
                padding: 0.75rem;
            }

            .map-container {
                height: 250px;
            }

            .delivery-options {
                flex-direction: column;
                gap: 0.75rem;
                margin: 1.5rem auto;
            }

            .address-input-container,
            .stores-carousel {
                margin: 1.5rem auto;
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-actions .btn {
                width: 100%;
            }

            .continue-btn {
                width: 100%;
                height: 40px;
                padding: 12px 16px;
                font-size: 16px;
            }
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            margin-bottom: 2rem;
        }

        .section-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2E8B57;
            margin: 0 0 0.5rem 0;
            font-family: 'Playfair Display', serif;
        }

        .section-header p {
            font-size: 1.1rem;
            color: #666;
            margin: 0;
        }

        .account-cards {
            display: grid;
            gap: 2rem;
        }

        .card {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 2rem;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2E8B57;
            margin: 0 0 1.5rem 0;
            font-family: 'Playfair Display', serif;
        }

        /* Formularios */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2E8B57;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
        }

        /* Preferencias de alimentación */
        .preferences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .preference-item {
            margin-bottom: 0.5rem;
        }

        .preference-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .preference-label:hover {
            border-color: #2E8B57;
            background: #f8f9fa;
        }

        .preference-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            position: relative;
            transition: all 0.3s ease;
        }

        .preference-label input[type="checkbox"]:checked + .checkmark {
            background: #2E8B57;
            border-color: #2E8B57;
        }

        .preference-label input[type="checkbox"]:checked + .checkmark::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .preference-text {
            font-weight: 500;
            color: #333;
        }

        /* Estilos para la sección de saldo */
        .balance-display {
            text-align: center;
            margin: 2rem 0;
        }

        .balance-amount {
            font-size: 3rem;
            font-weight: 700;
            color: #2E8B57;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .balance-amount.promotional {
            color: #FF6B35;
        }

        .currency {
            font-size: 2rem;
            opacity: 0.8;
        }

        .amount {
            font-size: 3.5rem;
        }

        .balance-description {
            color: #666;
            font-size: 1rem;
            margin: 0;
        }

        .balance-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #2E8B57;
            color: #2E8B57;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-outline:hover {
            background: #2E8B57;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 139, 87, 0.3);
        }

        /* Estados vacíos */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .empty-icon {
            font-size: 4rem;
            color: #2E8B57;
            margin-bottom: 1.5rem;
            opacity: 0.7;
        }

        .empty-state h3 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #333;
            margin: 0 0 1rem 0;
        }

        .empty-state p {
            font-size: 1.1rem;
            color: #666;
            margin: 0 0 2rem 0;
            line-height: 1.6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .account-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 0 15px;
            }

            .account-sidebar {
                position: static;
                order: 2;
            }

            .account-content {
                order: 1;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .preferences-grid {
                grid-template-columns: 1fr;
            }

            .section-header h1 {
                font-size: 2rem;
            }

            .nav-item {
                padding: 0.75rem 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <a href="index.html" class="logo-container">
                <img src="assets/img/Logo Huerto Hogar.jpg" alt="Logo de HuertoHogar" class="logo">
                <h2>HuertoHogar</h2>
            </a>
            <nav class="main-nav">
                <a href="index.html">Inicio</a>
                <a href="productos.html">Productos</a>
                <a href="nosotros.html">Nosotros</a>
                <a href="blog.html">Blog</a>
            </nav>
            <div class="header-actions">
                <div class="search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Buscar...">
                </div>
                <a href="login.html" class="login-link" id="user-login-link">Ingresar</a>
                <div class="user-profile" id="user-profile" style="display: none;">
                    <span class="user-name" id="user-name"></span>
                    <div class="user-menu">
                        <a href="mi-cuenta.html" class="user-menu-item">Mi Cuenta</a>
                        <button id="logout-btn" class="user-menu-item logout-btn">Cerrar Sesión</button>
                    </div>
                </div>
                <button id="open-cart-btn" class="cart-button">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="cart-counter" class="cart-counter">0</span>
                </button>
            </div>
        </div>
    </header>

    <main class="page-container">
        <div class="account-layout">
            <!-- Sidebar de navegación -->
            <aside class="account-sidebar">
                <div class="sidebar-header">
                    <h2>Mi Cuenta</h2>
                    <div class="user-info">
                        <span id="sidebar-user-name">—</span>
                        <span class="user-balance">$0</span>
                </div>
            </div>
                <nav class="sidebar-nav">
                    <button class="nav-item active" data-section="datos-personales">
                        <i class="fas fa-user"></i>
                        <span>Datos Personales</span>
                    </button>
                    <button class="nav-item" data-section="saldo">
                        <i class="fas fa-dollar-sign"></i>
                        <span>Saldo</span>
                    </button>
                    <button class="nav-item" data-section="huerto-club">
                        <i class="fas fa-crown"></i>
                        <span>HuertoHogar CLUB</span>
                    </button>
                    <button class="nav-item" data-section="historial-pedidos">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Historial de Pedidos</span>
                    </button>
                    <button class="nav-item" data-section="direcciones">
                        <i class="fas fa-truck"></i>
                        <span>Direcciones</span>
                    </button>
                    <button class="nav-item" data-section="medios-pago">
                        <i class="fas fa-credit-card"></i>
                        <span>Medios de Pago</span>
                    </button>
                    <button class="nav-item logout-item" id="sidebar-logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Cerrar Sesión</span>
                    </button>
                </nav>
            </aside>

            <!-- Contenido principal -->
            <div class="account-content">
                <!-- Sección Datos Personales -->
                <section id="datos-personales" class="content-section active">
                    <div class="section-header">
                        <h1>Mi cuenta</h1>
                        <div class="user-info-display">
                            <span id="display-user-name">Usuario</span>
                            <span class="user-balance-display">$0</span>
                </div>
            </div>
                    
                    <div class="profile-container">
                        <div class="profile-form-section">
                            <h2>Datos Personales</h2>
                <form id="profile-form">
                                <div class="form-row">
                    <div class="form-group">
                                        <label for="profile-name">Nombre</label>
                                        <input id="profile-name" type="text" required>
                    </div>
                    <div class="form-group">
                                        <label for="profile-lastname">Apellido</label>
                                        <input id="profile-lastname" type="text" required>
                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-rut">RUT</label>
                                    <div class="rut-input-container">
                                        <input id="profile-rut" type="text" placeholder="1234567-8" required>
                                        <span class="rut-checkmark" id="rut-checkmark" style="display: none;">✓</span>
                                    </div>
                                    <small style="color: #666; font-size: 0.9rem;">Formato: 1234567-8</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-birthdate">Fecha de nacimiento</label>
                                    <div class="date-input-container">
                                        <input id="profile-birthdate" type="text" placeholder="dd/mm/aaaa" readonly>
                                        <i class="fas fa-calendar-alt" id="calendar-icon" style="cursor: pointer;"></i>
                                    </div>
                                    <div id="date-picker" style="display: none; position: absolute; background: white; border: 1px solid #E5E7EB; border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 1000; margin-top: 8px; width: 350px; font-family: 'Montserrat', sans-serif;">
                                        <!-- Selector de año -->
                                        <div style="margin-bottom: 15px;">
                                            <label style="display: block; font-size: 13px; color: #6B7280; margin-bottom: 8px; font-weight: 500;">Año de nacimiento</label>
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <button type="button" id="prev-year" style="background: #F3F4F6; border: none; font-size: 16px; cursor: pointer; padding: 6px 10px; border-radius: 6px; color: #6B7280; transition: all 0.2s ease;">‹‹</button>
                                                <select id="year-selector" style="flex: 1; padding: 8px 12px; border: 1px solid #D1D5DB; border-radius: 6px; background: white; font-size: 14px; color: #374151; cursor: pointer;">
                                                    <option value="">Seleccionar año</option>
                                                </select>
                                                <button type="button" id="next-year" style="background: #F3F4F6; border: none; font-size: 16px; cursor: pointer; padding: 6px 10px; border-radius: 6px; color: #6B7280; transition: all 0.2s ease;">››</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Navegación de mes -->
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                            <button type="button" id="prev-month" style="background: #F3F4F6; border: none; font-size: 18px; cursor: pointer; padding: 8px 12px; border-radius: 6px; color: #6B7280; transition: all 0.2s ease;">‹</button>
                                            <h3 id="current-month-year" style="margin: 0; font-size: 16px; color: #374151; font-weight: 600;"></h3>
                                            <button type="button" id="next-month" style="background: #F3F4F6; border: none; font-size: 18px; cursor: pointer; padding: 8px 12px; border-radius: 6px; color: #6B7280; transition: all 0.2s ease;">›</button>
                                        </div>
                                        <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; text-align: center; font-size: 12px;"></div>
                                        <div style="margin-top: 15px; text-align: center;">
                                            <button type="button" id="clear-date" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 8px; font-size: 13px; font-weight: 500; transition: all 0.2s ease;">Limpiar</button>
                                            <button type="button" id="close-calendar" style="background: #6B7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s ease;">Cerrar</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-email">Email *</label>
                                    <input id="profile-email" type="email" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                                    <small style="color: #666; font-size: 0.9rem;">El email no se puede modificar</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-phone">Celular</label>
                                    <div class="phone-input-container">
                                        <span class="phone-prefix">+56</span>
                                        <input id="profile-phone" type="tel" placeholder="9 1234 5678">
                                        <span class="phone-checkmark" id="phone-checkmark"></span>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="household-section">
                            <h3>¿Para cuántas personas se cocina en tu casa?</h3>
                            <div class="household-inputs">
                                <div class="form-group">
                                    <label for="adults">Adultos</label>
                                    <select id="adults">
                                        <option value="1">1</option>
                                        <option value="2" selected>2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5+">5+</option>
                                    </select>
                                </div>
                    <div class="form-group">
                                    <label for="children">Niños</label>
                                    <select id="children">
                                        <option value="0" selected>0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4+">4+</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="diet-section">
                            <h3>¿Qué tipo de alimentación llevas?</h3>
                            <p class="diet-subtitle">Selecciona todas las opciones que apliquen</p>
                            <div class="diet-tags">
                                <label class="diet-tag">
                                    <input type="checkbox" name="diet" value="vegetariana">
                                    <span class="tag-text">Vegetariana</span>
                                </label>
                                <label class="diet-tag">
                                    <input type="checkbox" name="diet" value="vegana">
                                    <span class="tag-text">Vegana</span>
                                </label>
                                <label class="diet-tag">
                                    <input type="checkbox" name="diet" value="sin-gluten">
                                    <span class="tag-text">Sin gluten</span>
                                </label>
                                <label class="diet-tag">
                                    <input type="checkbox" name="diet" value="saludable">
                                    <span class="tag-text">Saludable</span>
                                </label>
                                <label class="diet-tag">
                                    <input type="checkbox" name="diet" value="sin-azucar">
                                    <span class="tag-text">Sin Azúcar</span>
                                </label>
                                <label class="diet-tag">
                                    <input type="checkbox" name="diet" value="keto">
                                    <span class="tag-text">Keto</span>
                                </label>
                                <label class="diet-tag">
                                    <input type="checkbox" name="diet" value="sin-restricciones">
                                    <span class="tag-text">Sin restricciones alimentarias</span>
                        </label>
                    </div>
                        </div>

                        <div class="form-actions">
                    <div id="profile-feedback"></div>
                            <button class="btn btn-primary" type="submit" form="profile-form">
                                <i class="fas fa-save"></i>
                                Guardar Cambios
                            </button>
            </div>
                    </div>
                </section>

                <!-- Sección Saldo -->
                <section id="saldo" class="content-section">
                    <div class="section-header">
                        <h1>Mi cuenta</h1>
                        <div class="user-info-display">
                            <span id="display-user-name-saldo">Usuario</span>
                            <span class="user-balance-display">$0</span>
                        </div>
                    </div>
                    
                    <div class="balance-container">
                        <div class="balance-card">
                            <h3>Saldo a favor</h3>
                            <div class="balance-input-container">
                                <div class="balance-input">
                                    <span class="currency-symbol">$</span>
                                    <input type="text" value="0" readonly class="balance-amount-input">
                                </div>
                            </div>
                            <button class="btn btn-outline-light" onclick="requestRefund()">
                                Solicitar devolución
                            </button>
                        </div>

                        <div class="balance-card">
                            <h3>Saldo promocional</h3>
                            <div class="balance-input-container">
                                <div class="balance-input">
                                    <span class="currency-symbol">$</span>
                                    <input type="text" value="0" readonly class="balance-amount-input">
                                </div>
                            </div>
                            <p class="balance-description">Válido como crédito HuertoHogar (No reembolsable)</p>
                        </div>
                    </div>
                </section>

                <!-- Sección HuertoHogar CLUB -->
                <section id="huerto-club" class="content-section">
                    <div class="section-header">
                        <h1>Mi cuenta</h1>
                        <div class="user-info-display">
                            <span id="display-user-name-club">Usuario</span>
                            <span class="user-balance-display">$0</span>
                        </div>
                    </div>
                    
                    <div class="club-container">
                        <!-- Banner promocional -->
                        <div class="promo-banner">
                            <div class="promo-content">
                                <i class="fas fa-leaf"></i>
                                <span>¡COMENZÓ! HuertoHogarazo de tomate a LUCA</span>
                                <i class="fas fa-apple-alt"></i>
                            </div>
                        </div>

                        <!-- Nivel de lealtad -->
                        <div class="loyalty-level-card">
                            <div class="level-header">
                                <div class="level-icon">
                                    <i class="fas fa-seedling"></i>
                                </div>
                                <div class="level-info">
                                    <h2>Nivel 1 - Lechuga</h2>
                                    <div class="level-stats">
                                        <div class="stat-item">
                                            <span class="stat-label">Saldo disponible:</span>
                                            <span class="stat-value">0</span>
                                            <i class="fas fa-seedling"></i>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-label">Acumuladas:</span>
                                            <span class="stat-value">0</span>
                                            <i class="fas fa-seedling"></i>
                                            <i class="fas fa-seedling"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="level-description">¿Quieres mantener estos beneficios para siempre? Conviértete en HuertoHogar PREMIUM</p>
                        </div>

                        <!-- Mensaje de acumulación -->
                        <div class="accumulation-message">
                            <p>Tienes 3 meses para acumular puntos, ¡Sigue así!</p>
                        </div>

                        <!-- Historial de transacciones -->
                        <div class="transaction-history">
                            <h3>Saldo actual puntos canjeables: 0</h3>
                            <div class="history-table">
                                <div class="table-header">
                                    <span>Fecha</span>
                                    <span>Descripción</span>
                                    <span>Movimiento puntos</span>
                                    <span>Saldo puntos</span>
                                </div>
                                <div class="table-empty">
                                    <p>No hay transacciones registradas</p>
                                </div>
                            </div>
                        </div>

                        <!-- Promoción de membresía -->
                        <div class="membership-promo">
                            <div class="promo-content">
                                <span>¿Mejor un atajo al último nivel? Adquiere la membresía HuertoHogar PREMIUM y disfruta de envíos gratis siempre</span>
                                <button class="btn btn-premium" onclick="becomePremium()">QUIERO SER PREMIUM</button>
                            </div>
                        </div>

                        <!-- Beneficios del último nivel -->
                        <div class="benefits-section">
                            <h3>Beneficios del último nivel PALTA</h3>
                            <div class="benefits-grid">
                                <div class="benefit-card">
                                    <i class="fas fa-seedling"></i>
                                    <h4>Puntos acumulados</h4>
                                    <p>Compra, gana puntos, canjéalos por cupones y avanza de nivel.</p>
                                </div>
                                <div class="benefit-card">
                                    <i class="fas fa-rocket"></i>
                                    <h4>Descuentos de productos</h4>
                                    <p>en tienda y web (acceso limitado).</p>
                                </div>
                                <div class="benefit-card">
                                    <i class="fas fa-calendar-alt"></i>
                                    <h4>Recordatorio de compra</h4>
                                    <p>Te recordaremos cuando realizar tu próxima compra.</p>
                                </div>
                                <div class="benefit-card">
                                    <i class="fas fa-gift"></i>
                                    <h4>Despacho gratis sobre $1 para tu cumpleaños y $5.000 de regalo en dinero HuertoHogar.</h4>
                                    <p>Despacho gratis en tus compras sobre $1 y $10.000 en HuertoHogar.</p>
                                </div>
                                <div class="benefit-card">
                                    <i class="fas fa-percentage"></i>
                                    <h4>5% de descuento en TODO HuertoHogar</h4>
                                    <p>los sábados y domingos. (tope máx $10.000). *No aplica en compras de formatos mayoristas.</p>
                                </div>
                                <div class="benefit-card">
                                    <i class="fas fa-truck"></i>
                                    <h4>Despacho gratis ilimitado</h4>
                                    <p>por compras sobre $24.990.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Promoción de membresía (duplicada) -->
                        <div class="membership-promo">
                            <div class="promo-content">
                                <span>¿Mejor un atajo al último nivel? Adquiere la membresía HuertoHogar PREMIUM y disfruta de envíos gratis siempre</span>
                                <button class="btn btn-premium" onclick="becomePremium()">QUIERO SER PREMIUM</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sección Historial de Pedidos -->
                <section id="historial-pedidos" class="content-section">
                    <div class="section-header">
                        <h1>Historial de Pedidos</h1>
                        <p>Revisa todos tus pedidos anteriores</p>
                    </div>
                    
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-shopping-basket"></i>
                        </div>
                        <h3>No hay pedidos</h3>
                        <p>Aún no has realizado ningún pedido. ¡Explora nuestros productos frescos!</p>
                        <a href="productos.html" class="btn btn-primary">Ver Productos</a>
                    </div>
                </section>

                <!-- Sección Direcciones -->
                <section id="direcciones" class="content-section">
                    <div class="section-header">
                        <h1>Mi cuenta</h1>
                        <div class="user-info-display">
                            <span id="display-user-name-direcciones">Usuario</span>
                            <span class="user-balance-display">$0</span>
                        </div>
                    </div>
                    
                    <div class="addresses-container">
                        <div class="addresses-header">
                            <h2>Direcciones</h2>
                            <p>Gestiona tus direcciones de entrega</p>
                        </div>
                        
                        <div class="addresses-list" id="addresses-list">
                            <!-- Las direcciones se cargarán dinámicamente -->
                        </div>
                        
                        <div class="add-address-section">
                            <button class="btn btn-primary" onclick="showAddAddressModal()">
                                <i class="fas fa-plus"></i>
                                Agregar Dirección
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Sección Medios de Pago -->
                <section id="medios-pago" class="content-section">
                    <div class="section-header">
                        <h1>Medios de Pago</h1>
                        <p>Gestiona tus métodos de pago</p>
                    </div>
                    
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <h3>No tienes métodos de pago registrados</h3>
                        <p>Agrega una tarjeta para facilitar tus compras</p>
                        <button class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Agregar Tarjeta
                        </button>
            </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Modal para agregar dirección -->
    <div id="addressModal" class="modal-overlay">
        <div class="modal-content address-modal">
            <!-- Botón de cerrar -->
            <button class="modal-close" onclick="closeAddressModal()">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            
            <!-- Contenido principal -->
            <div class="modal-body">
                <div class="mt-2 p-2 sm:p-3">
                <h1 class="modal-title">Ingresa dirección y descubre lo que tenemos para ti.</h1>
                <h2 class="modal-subtitle" id="modal-subtitle">¡Tú decides la opción que más te conviene!</h2>
                
                <!-- Opciones de entrega -->
                <div class="delivery-options">
                    <button class="delivery-option active" id="home-delivery" onclick="selectDeliveryOption('home')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="delivery-icon">
                            <path d="M21.2567 16.8001C21.1704 17.6244 20.8102 18.2801 20.1469 18.7621C19.6713 19.1083 19.1374 19.2669 18.5515 19.2592C17.1805 19.2415 16.0695 18.1812 15.9376 16.8216C15.902 16.8216 15.864 16.8216 15.8272 16.8216C13.4936 16.8216 11.16 16.8216 8.82511 16.8204C8.73253 16.8204 8.70082 16.8407 8.68941 16.9409C8.53341 18.308 7.28924 19.3417 5.91063 19.2592C4.64997 19.1832 3.65565 18.3093 3.42356 17.0728C3.40834 16.989 3.39946 16.9041 3.38805 16.8153C3.26503 16.7899 3.142 16.7734 3.02406 16.7392C2.43938 16.5705 2.01959 16.0201 2.0031 15.4113C2.00183 15.3403 2.00056 15.268 2.00056 15.197C2.00056 12.3396 1.9993 9.48344 2.00056 6.62603C2.00056 5.81561 2.3227 5.16499 3.00123 4.70714C3.34873 4.47378 3.74063 4.36471 4.15535 4.36344C6.71852 4.35837 9.28042 4.35964 11.8436 4.35964C12.5373 4.35964 13.2311 4.34315 13.9235 4.37232C14.7416 4.40656 15.3808 4.77056 15.774 5.50996C15.9642 5.86761 16.0352 6.2557 16.0378 6.65774C16.0378 6.7034 16.0378 6.75032 16.0378 6.81374C16.0872 6.81374 16.1278 6.81374 16.1697 6.81374C16.6808 6.81374 17.1919 6.8074 17.703 6.815C18.3232 6.82388 18.8749 7.01412 19.3162 7.46816C19.5103 7.66728 19.6574 7.8981 19.7842 8.14415C20.1127 8.78589 20.4437 9.42637 20.7709 10.0694C20.8153 10.1569 20.8762 10.2165 20.9662 10.2545C21.3366 10.4131 21.7069 10.5729 22.0747 10.7378C22.686 11.0104 22.9955 11.4848 22.998 12.1531C23.0018 13.1792 22.9993 14.2052 22.998 15.2312C22.998 15.6079 22.9156 15.963 22.6733 16.2636C22.3766 16.6314 21.9745 16.7798 21.5167 16.8039C21.4355 16.8077 21.3531 16.8039 21.2567 16.8039V16.8001ZM14.5057 11.7689V11.6573C14.5057 9.99075 14.5057 8.32424 14.5057 6.65774C14.5057 6.61462 14.5057 6.5715 14.5019 6.52964C14.4689 6.15931 14.2749 5.94751 13.9261 5.90819C13.8411 5.89805 13.7549 5.89297 13.6699 5.89297C10.5144 5.89551 7.35773 5.89805 4.20228 5.90058C4.16676 5.90058 4.13125 5.90058 4.09574 5.90566C3.86872 5.93229 3.69243 6.04136 3.60873 6.2557C3.5618 6.37618 3.53263 6.51189 3.53263 6.63998C3.52756 8.31029 3.52883 9.97933 3.52883 11.6496C3.52883 11.6877 3.52883 11.7257 3.52883 11.7689H14.507H14.5057ZM14.4892 15.2858V13.3314H3.5339V15.2959C3.65185 15.3225 3.73048 15.2972 3.7977 15.1894C4.42169 14.1786 5.41347 13.826 6.46233 13.9655C7.27909 14.0746 7.88279 14.5083 8.30893 15.2021C8.35205 15.2718 8.39771 15.2972 8.47888 15.2959C8.92531 15.2896 9.37174 15.287 9.81817 15.2858C11.3261 15.2858 12.8341 15.2858 14.3421 15.2858H14.4879H14.4892ZM21.4647 15.2858C21.4685 15.2655 21.4723 15.2553 21.4723 15.2452C21.4723 14.2306 21.4735 13.2147 21.4697 12.2001C21.4697 12.1646 21.4266 12.1126 21.3911 12.0961C21.0106 11.9249 20.6289 11.7574 20.2433 11.5964C20.1533 11.5596 20.0506 11.5393 19.9529 11.538C18.6922 11.5342 17.4303 11.5355 16.1697 11.5355C16.1329 11.5355 16.0948 11.5406 16.0593 11.5431V15.2756C16.2014 15.3048 16.3028 15.2921 16.3878 15.1463C16.4829 14.9814 16.6097 14.8292 16.7467 14.696C17.7157 13.7499 19.1805 13.67 20.2446 14.5007C20.4602 14.6694 20.6669 14.8507 20.7823 15.1145C20.8102 15.178 20.8838 15.2388 20.951 15.2667C21.1172 15.3352 21.2922 15.3086 21.4647 15.287V15.2858ZM16.0504 9.97806H19.0118C18.9966 9.94509 18.9865 9.92353 18.9751 9.90197C18.7455 9.48217 18.5121 9.06491 18.2889 8.64131C18.1862 8.446 18.034 8.37117 17.8209 8.3699C17.3567 8.36863 16.8926 8.35722 16.4284 8.35088C16.3041 8.34961 16.1811 8.35088 16.0492 8.35088V9.97806H16.0504ZM18.6174 15.4709C17.9998 15.4709 17.4684 15.9744 17.4658 16.5642C17.4633 17.1958 17.9744 17.7449 18.5603 17.7399C19.2211 17.7348 19.7322 17.2452 19.736 16.6149C19.7398 15.9884 19.2338 15.4709 18.6174 15.4709ZM6.05648 15.4709C5.43503 15.4709 4.92265 15.977 4.92012 16.5972C4.91631 17.2211 5.43376 17.7424 6.05395 17.7399C6.67286 17.7373 7.18397 17.2237 7.18524 16.6048C7.18524 15.9808 6.6792 15.4709 6.05775 15.4709H6.05648Z"></path>
                        </svg>
                        Despacho a domicilio
                    </button>
                    <button class="delivery-option" id="store-pickup" onclick="selectDeliveryOption('store')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" viewBox="0 0 24 24" class="delivery-icon">
                            <path d="M20.3511 13.1096V19.0067H21.2238V20.7522H3.77315V19.0067H4.64591V13.1096C3.55496 12.3818 2.90039 11.1563 2.90039 9.8442C2.90039 9.12238 3.09616 8.42746 3.45334 7.83416L5.81905 3.73638C5.97447 3.46588 6.2629 3.3 6.57524 3.3H18.4232C18.7356 3.3 19.0225 3.46588 19.1794 3.73638L21.5377 7.82221C22.6197 9.61853 22.0966 11.9469 20.3526 13.1096H20.3511ZM18.6056 13.7462C17.3891 13.8822 16.1801 13.4443 15.3342 12.5596C14.5945 13.3337 13.5693 13.7716 12.4992 13.7716C11.4277 13.7716 10.404 13.3352 9.66427 12.5611C8.81841 13.4443 7.60791 13.8837 6.39292 13.7462V19.0052H18.6086V13.7462H18.6056ZM7.07887 5.04402L4.95675 8.72037C4.50543 9.83673 5.04343 11.1085 6.15979 11.5613C7.15808 11.9648 8.30283 11.5807 8.85279 10.6542C9.1457 9.9234 10.1784 9.9234 10.4728 10.6542C10.9196 11.7735 12.1884 12.319 13.3077 11.8722C13.8637 11.651 14.303 11.2101 14.5257 10.6542C14.8186 9.9234 15.8513 9.9234 16.1457 10.6542C16.5985 11.7705 17.8718 12.3071 18.9881 11.8542C20.1045 11.4014 20.641 10.1281 20.1882 9.01179C20.1449 8.90568 20.094 8.80406 20.0358 8.70692L17.9196 5.04552H7.08186L7.07887 5.04402Z"></path>
                        </svg>
                        Retiro en tienda
                        <div class="free-badge">Gratis</div>
                    </button>
                </div>
                
                <!-- Campo de dirección inicial (siempre visible) -->
                <div class="initial-address-field" style="display: none;">
                    <div class="relative w-full">
                        <input type="text" id="initial-address-input" placeholder="Ingresa tu dirección" autocomplete="off" class="w-full rounded-md border-gray-200 text-base focus:border-green-500 focus:ring-green-500 focus-visible:border-green-500 focus-visible:ring-green-500">
                    </div>
                    <!-- Menú desplegable de sugerencias para el campo inicial -->
                    <div id="initial-address-suggestions" class="suggestions-dropdown" style="display: none;">
                        <div class="suggestions-list" id="initial-suggestions-list">
                            <!-- Las sugerencias se cargarán dinámicamente -->
                        </div>
                    </div>
                </div>
                
                <!-- Botón de búsqueda -->
                <div class="search-button-container" style="display: none;">
                    <button class="search-address-btn" id="search-address-btn">Buscar dirección</button>
                </div>
                
                <!-- Separador -->
                <div class="separator" style="display: none;">
                    <span>O elige una comuna</span>
                </div>
                
                <!-- Grid de comunas -->
                <div class="communes-grid" style="display: none;">
                    <a href="#" class="commune-link" data-commune="Santiago">Santiago</a>
                    <a href="#" class="commune-link" data-commune="Concepción">Concepción</a>
                    <a href="#" class="commune-link" data-commune="Valparaíso">Valparaíso</a>
                    <a href="#" class="commune-link" data-commune="Viña del Mar">Viña del Mar</a>
                    <a href="#" class="commune-link" data-commune="Puerto Montt">Puerto Montt</a>
                    <a href="#" class="commune-link" data-commune="Villarrica">Villarrica</a>
                </div>
                
                <!-- Campo de dirección -->
                <!-- Campo de entrada de dirección (se mostrará cuando se seleccione "Despacho a domicilio") -->
                <div id="address-input-container" class="address-input-container" style="display: none;">
                    <div class="address-form">
                        <!-- Campos de dirección en una sola fila horizontal -->
                        <div class="campos-direccion">
                            <!-- Campo principal de dirección (60%) -->
                            <div class="campo-direccion-principal">
                                <div class="input-with-validation">
                                    <input type="text" id="address-input" placeholder="Ingresa tu dirección" required autocomplete="off">
                                    <div class="input-icon" id="address-check-icon" style="display: none;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 12l2 2 4-4" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                    <!-- Menú desplegable de sugerencias -->
                                    <div id="address-suggestions" class="suggestions-dropdown" style="display: none;">
                                        <div class="suggestions-list" id="suggestions-list">
                                            <!-- Las sugerencias se cargarán dinámicamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Contenedor para campos secundarios - mismo ancho que botón "Retiro en tienda" -->
                            <div class="campos-secundarios">
                                <!-- Campo de número -->
                                <div class="campo-numero">
                                    <input type="text" id="address-number" placeholder="Numero" autocomplete="off">
                                </div>
                                
                                <!-- Campo de depto/casa/ofic -->
                                <div class="campo-depto">
                                    <input type="text" id="address-details" placeholder="Depto/casa/ofic" autocomplete="off">
                                </div>
                            </div>
                        </div>
                        
                        <div class="region-info" style="display: flex; justify-content: flex-end; margin-left: calc(50% + 8px); margin-right: 0; width: calc(50% - 8px);">
                            <span>Región: <strong id="selected-region">Bío Bío</strong></span>
                            <span>|</span>
                            <span>Comuna: <strong id="selected-commune">Concepción</strong></span>
                        </div>
                    </div>
                    
                    <!-- Mapa integrado -->
                    <div id="map-container" class="map-container">
                        <div id="map" class="map"></div>
                        <!-- Mapa de respaldo en caso de error -->
                        <div id="map-fallback" class="map-fallback" style="display: none;">
                            <div class="map-placeholder">
                                <i class="fas fa-map-marker-alt" style="font-size: 2rem; color: #10b981; margin-bottom: 1rem;"></i>
                                <h3 style="color: #374151; margin-bottom: 0.5rem;">Ubicación seleccionada</h3>
                                <p style="color: #6b7280; font-size: 0.9rem;">Santiago, Santiago, Chile</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botón Continuar -->
                    <div class="continue-button-container">
                        <button class="continue-btn" id="continue-btn">Continuar</button>
                    </div>
                </div>
                
                <!-- Carrusel de tiendas (solo para retiro en tienda) -->
                <div id="stores-carousel" class="stores-carousel">
                    <div class="carousel-viewport">
                        <div class="carousel-camera" id="carousel-camera">
                            <div class="carousel-content" id="carousel-content">
                                <!-- Las tiendas se cargarán dinámicamente -->
                            </div>
                        </div>
                    </div>
                    <div class="carousel-controls">
                        <button class="carousel-prev" id="carousel-prev">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 010-1.06l7.5-7.5a.75.75 0 111.06 1.06L9.31 12l6.97 6.97a.75.75 0 11-1.06 1.06l-7.5-7.5z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                        <div class="carousel-pagination" id="carousel-pagination">
                            <!-- Los indicadores se generarán dinámicamente -->
                        </div>
                        <button class="carousel-next" id="carousel-next">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 010 1.06l-7.5 7.5a.75.75 0 01-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 011.06-1.06l7.5 7.5z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="carousel-actions">
                        <button class="btn btn-primary" id="view-hours-btn" disabled>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            Ver horarios
                        </button>
                    </div>
                    
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para retiro en tienda -->
    <div id="storeModal" class="modal-overlay">
        <div class="modal-content store-modal">
            <!-- Botón de cerrar -->
            <button class="modal-close" onclick="closeStoreModal()">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            
            <!-- Contenido principal -->
            <div class="modal-body">
                <div class="mt-2 p-2 sm:p-3">
                <h1 class="modal-title">Ingresa dirección y descubre lo que tenemos para ti.</h1>
                <h2 class="modal-subtitle" id="store-modal-subtitle">¡Te ayudamos a encontrar la tienda más cercana!</h2>
                
                <!-- Opciones de entrega -->
                <div class="delivery-options">
                    <button class="delivery-option" id="store-home-delivery" onclick="selectStoreDeliveryOption('home')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="delivery-icon">
                            <path d="M21.2567 16.8001C21.1704 17.6244 20.8102 18.2801 20.1469 18.7621C19.6713 19.1083 19.1374 19.2669 18.5515 19.2592C17.1805 19.2415 16.0695 18.1812 15.9376 16.8216C15.902 16.8216 15.864 16.8216 15.8272 16.8216C13.4936 16.8216 11.16 16.8216 8.82511 16.8204C8.73253 16.8204 8.70082 16.8407 8.68941 16.9409C8.53341 18.308 7.28924 19.3417 5.91063 19.2592C4.64997 19.1832 3.65565 18.3093 3.42356 17.0728C3.40834 16.989 3.39946 16.9041 3.38805 16.8153C3.26503 16.7899 3.142 16.7734 3.02406 16.7392C2.43938 16.5705 2.01959 16.0201 2.0031 15.4113C2.00183 15.3403 2.00056 15.268 2.00056 15.197C2.00056 12.3396 1.9993 9.48344 2.00056 6.62603C2.00056 5.81561 2.3227 5.16499 3.00123 4.70714C3.34873 4.47378 3.74063 4.36471 4.15535 4.36344C6.71852 4.35837 9.28042 4.35964 11.8436 4.35964C12.5373 4.35964 13.2311 4.34315 13.9235 4.37232C14.7416 4.40656 15.3808 4.77056 15.774 5.50996C15.9642 5.86761 16.0352 6.2557 16.0378 6.65774C16.0378 6.7034 16.0378 6.75032 16.0378 6.81374C16.0872 6.81374 16.1278 6.81374 16.1697 6.81374C16.6808 6.81374 17.1919 6.8074 17.703 6.815C18.3232 6.82388 18.8749 7.01412 19.3162 7.46816C19.5103 7.66728 19.6574 7.8981 19.7842 8.14415C20.1127 8.78589 20.4437 9.42637 20.7709 10.0694C20.8153 10.1569 20.8762 10.2165 20.9662 10.2545C21.3366 10.4131 21.7069 10.5729 22.0747 10.7378C22.686 11.0104 22.9955 11.4848 22.998 12.1531C23.0018 13.1792 22.9993 14.2052 22.998 15.2312C22.998 15.6079 22.9156 15.963 22.6733 16.2636C22.3766 16.6314 21.9745 16.7798 21.5167 16.8039C21.4355 16.8077 21.3531 16.8039 21.2567 16.8039V16.8001ZM14.5057 11.7689V11.6573C14.5057 9.99075 14.5057 8.32424 14.5057 6.65774C14.5057 6.61462 14.5057 6.5715 14.5019 6.52964C14.4689 6.15931 14.2749 5.94751 13.9261 5.90819C13.8411 5.89805 13.7549 5.89297 13.6699 5.89297C10.5144 5.89551 7.35773 5.89805 4.20228 5.90058C4.16676 5.90058 4.13125 5.90058 4.09574 5.90566C3.86872 5.93229 3.69243 6.04136 3.60873 6.2557C3.5618 6.37618 3.53263 6.51189 3.53263 6.63998C3.52756 8.31029 3.52883 9.97933 3.52883 11.6496C3.52883 11.6877 3.52883 11.7257 3.52883 11.7689H14.507H14.5057ZM14.4892 15.2858V13.3314H3.5339V15.2959C3.65185 15.3225 3.73048 15.2972 3.7977 15.1894C4.42169 14.1786 5.41347 13.826 6.46233 13.9655C7.27909 14.0746 7.88279 14.5083 8.30893 15.2021C8.35205 15.2718 8.39771 15.2972 8.47888 15.2959C8.92531 15.2896 9.37174 15.287 9.81817 15.2858C11.3261 15.2858 12.8341 15.2858 14.3421 15.2858H14.4879H14.4892ZM21.4647 15.2858C21.4685 15.2655 21.4723 15.2553 21.4723 15.2452C21.4723 14.2306 21.4735 13.2147 21.4697 12.2001C21.4697 12.1646 21.4266 12.1126 21.3911 12.0961C21.0106 11.9249 20.6289 11.7574 20.2433 11.5964C20.1533 11.5596 20.0506 11.5393 19.9529 11.538C18.6922 11.5342 17.4303 11.5355 16.1697 11.5355C16.1329 11.5355 16.0948 11.5406 16.0593 11.5431V15.2756C16.2014 15.3048 16.3028 15.2921 16.3878 15.1463C16.4829 14.9814 16.6097 14.8292 16.7467 14.696C17.7157 13.7499 19.1805 13.67 20.2446 14.5007C20.4602 14.6694 20.6669 14.8507 20.7823 15.1145C20.8102 15.178 20.8838 15.2388 20.951 15.2667C21.1172 15.3352 21.2922 15.3086 21.4647 15.287V15.2858ZM16.0504 9.97806H19.0118C18.9966 9.94509 18.9865 9.92353 18.9751 9.90197C18.7455 9.48217 18.5121 9.06491 18.2889 8.64131C18.1862 8.446 18.034 8.37117 17.8209 8.3699C17.3567 8.36863 16.8926 8.35722 16.4284 8.35088C16.3041 8.34961 16.1811 8.35088 16.0492 8.35088V9.97806H16.0504ZM18.6174 15.4709C17.9998 15.4709 17.4684 15.9744 17.4658 16.5642C17.4633 17.1958 17.9744 17.7449 18.5603 17.7399C19.2211 17.7348 19.7322 17.2452 19.736 16.6149C19.7398 15.9884 19.2338 15.4709 18.6174 15.4709ZM6.05648 15.4709C5.43503 15.4709 4.92265 15.977 4.92012 16.5972C4.91631 17.2211 5.43376 17.7424 6.05395 17.7399C6.67286 17.7373 7.18397 17.2237 7.18524 16.6048C7.18524 15.9808 6.6792 15.4709 6.05775 15.4709H6.05648Z"></path>
                        </svg>
                        Despacho a domicilio
                    </button>
                    <button class="delivery-option active" id="store-pickup" onclick="selectStoreDeliveryOption('store')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" viewBox="0 0 24 24" class="delivery-icon">
                            <path d="M20.3511 13.1096V19.0067H21.2238V20.7522H3.77315V19.0067H4.64591V13.1096C3.55496 12.3818 2.90039 11.1563 2.90039 9.8442C2.90039 9.12238 3.09616 8.42746 3.45334 7.83416L5.81905 3.73638C5.97447 3.46588 6.2629 3.3 6.57524 3.3H18.4232C18.7356 3.3 19.0225 3.46588 19.1794 3.73638L21.5377 7.82221C22.6197 9.61853 22.0966 11.9469 20.3526 13.1096H20.3511ZM18.6056 13.7462C17.3891 13.8822 16.1801 13.4443 15.3342 12.5596C14.5945 13.3337 13.5693 13.7716 12.4992 13.7716C11.4277 13.7716 10.404 13.3352 9.66427 12.5611C8.81841 13.4443 7.60791 13.8837 6.39292 13.7462V19.0052H18.6086V13.7462H18.6056ZM7.07887 5.04402L4.95675 8.72037C4.50543 9.83673 5.04343 11.1085 6.15979 11.5613C7.15808 11.9648 8.30283 11.5807 8.85279 10.6542C9.1457 9.9234 10.1784 9.9234 10.4728 10.6542C10.9196 11.7735 12.1884 12.319 13.3077 11.8722C13.8637 11.651 14.303 11.2101 14.5257 10.6542C14.8186 9.9234 15.8513 9.9234 16.1457 10.6542C16.5985 11.7705 17.8718 12.3071 18.9881 11.8542C20.1045 11.4014 20.641 10.1281 20.1882 9.01179C20.1449 8.90568 20.094 8.80406 20.0358 8.70692L17.9196 5.04552H7.08186L7.07887 5.04402Z"></path>
                        </svg>
                        Retiro en tienda
                        <div class="free-badge">Gratis</div>
                    </button>
                </div>
                
                <!-- Carrusel de tiendas (solo para retiro en tienda) -->
                <div id="store-stores-carousel" class="stores-carousel">
                    <div class="carousel-viewport">
                        <div class="carousel-camera" id="store-carousel-camera" style="transform: translateX(0%);">
                            <div class="carousel-content" id="store-carousel-content">
                                <!-- Las tarjetas de tienda se cargarán aquí -->
                            </div>
                        </div>
                    </div>
                    <div class="carousel-controls">
                        <button class="carousel-prev" id="store-carousel-prev">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 010-1.06l7.5-7.5a.75.75 0 111.06 1.06L9.31 12l6.97 6.97a.75.75 0 11-1.06 1.06l-7.5-7.5z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                        <div class="carousel-pagination" id="store-carousel-pagination">
                            <!-- Los puntos de paginación se cargarán aquí -->
                        </div>
                        <button class="carousel-next" id="store-carousel-next">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 010 1.06l-7.5 7.5a.75.75 0 01-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 011.06-1.06l7.5 7.5z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="carousel-actions">
                        <button class="btn btn-primary" id="store-view-hours-btn" disabled="">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"></circle>
                                <polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2"></polyline>
                            </svg>
                            Ver horarios
                        </button>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>HuertoHogar</h4>
                <p>Conectando el campo chileno con tu mesa. Frescura, calidad y sostenibilidad en cada entrega.</p>
            </div>
            <div class="footer-section">
                <h4>Navegación</h4>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="productos.html">Productos</a></li>
                    <li><a href="nosotros.html">Nosotros</a></li>
                    <li><a href="blog.html">Blog</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Síguenos</h4>
                <div class="social-icons">
                    <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                </div>
            </div>
        </div>
        <p class="footer-bottom">© 2025 HuertoHogar. Todos los derechos reservados.</p>
    </footer>

    <div id="cart-overlay" class="hidden"></div>
    <div id="cart-offcanvas" class="hidden">
        <div class="cart-header">
            <h3>Tu Carrito</h3>
            <button id="close-cart-btn" class="close-btn">×</button>
        </div>
        <div id="cart-items" class="cart-body">
            </div>
        <div class="cart-footer">
            <div class="summary-line">
                <span>Subtotal</span>
                <span id="cart-total">$0 CLP</span>
            </div>
            <button class="btn btn-primary checkout-btn">Finalizar Compra</button>
        </div>
    </div>

    <script src="assets/js/script.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        // Funcionalidad del sidebar de navegación
        function initializeSidebar() {
            console.log('Initializing sidebar...');
            const navItems = document.querySelectorAll('.nav-item[data-section]');
            const contentSections = document.querySelectorAll('.content-section');
            const sidebarLogoutBtn = document.getElementById('sidebar-logout-btn');
            const mainLogoutBtn = document.getElementById('logout-btn');

            console.log('Found nav items:', navItems.length);
            console.log('Found content sections:', contentSections.length);

            // Navegación entre secciones
            navItems.forEach((item, index) => {
                // Remover listeners existentes para evitar duplicados
                item.removeEventListener('click', handleNavClick);
                console.log(`Adding listener to nav item ${index}:`, item.textContent.trim());
                item.addEventListener('click', handleNavClick);
            });

            // Funcionalidad de logout desde sidebar
            if (sidebarLogoutBtn) {
                sidebarLogoutBtn.removeEventListener('click', handleSidebarLogout);
                sidebarLogoutBtn.addEventListener('click', handleSidebarLogout);
            }

            // Cargar datos del usuario
            loadUserData();
        }

        // Función para manejar clicks en navegación
        function handleNavClick(e) {
            e.preventDefault();
            console.log('Nav item clicked:', this.textContent.trim());
            const targetSection = this.getAttribute('data-section');
            console.log('Target section:', targetSection);
            
            const navItems = document.querySelectorAll('.nav-item[data-section]');
            const contentSections = document.querySelectorAll('.content-section');
            
            // Remover clase active de todos los items
            navItems.forEach(nav => nav.classList.remove('active'));
            contentSections.forEach(section => section.classList.remove('active'));
            
            // Agregar clase active al item clickeado
            this.classList.add('active');
            
            // Mostrar la sección correspondiente
            const targetElement = document.getElementById(targetSection);
            if (targetElement) {
                console.log('Showing section:', targetSection);
                targetElement.classList.add('active');
            } else {
                console.log('Section not found:', targetSection);
            }
        }

        // Función para manejar logout desde sidebar
        function handleSidebarLogout() {
            const mainLogoutBtn = document.getElementById('logout-btn');
            if (mainLogoutBtn) {
                mainLogoutBtn.click();
            }
        }

        // Función para cargar datos del usuario
        function loadUserData() {
            // Obtener usuario actual desde la sesión
            const session = JSON.parse(localStorage.getItem('huerto_session') || 'null');
            let user = null;
            
            if (session && session.userId) {
                const users = JSON.parse(localStorage.getItem('huerto_users') || '[]');
                user = users.find(u => u.id === session.userId);
            }
            
            console.log('Sesión actual:', session);
            console.log('Usuario cargado desde localStorage:', user);
            if (user) {
                // Extraer nombre de visualización usando la función de auth.js
                const displayName = window.HuertoAuth && window.HuertoAuth.extractDisplayName 
                    ? window.HuertoAuth.extractDisplayName(user.nombre) 
                    : user.nombre || 'Usuario';

                // Actualizar nombre en sidebar
                const sidebarUserName = document.getElementById('sidebar-user-name');
                if (sidebarUserName) {
                    sidebarUserName.textContent = displayName;
                }

                // Actualizar nombre en header
                const headerUserName = document.getElementById('user-name');
                if (headerUserName) {
                    headerUserName.textContent = displayName;
                }

                // Actualizar información en el header de la sección
                const displayUserName = document.getElementById('display-user-name');
                if (displayUserName) {
                    displayUserName.textContent = displayName;
                }

                // Actualizar información en la sección de saldo
                const displayUserNameSaldo = document.getElementById('display-user-name-saldo');
                if (displayUserNameSaldo) {
                    displayUserNameSaldo.textContent = displayName;
                }

                // Actualizar información en la sección de club
                const displayUserNameClub = document.getElementById('display-user-name-club');
                if (displayUserNameClub) {
                    displayUserNameClub.textContent = displayName;
                }

                // Actualizar información en la sección de direcciones
                const displayUserNameDirecciones = document.getElementById('display-user-name-direcciones');
                if (displayUserNameDirecciones) {
                    displayUserNameDirecciones.textContent = displayName;
                }

                // Llenar formulario con datos del usuario
                const profileName = document.getElementById('profile-name');
                const profileLastname = document.getElementById('profile-lastname');
                const profileEmail = document.getElementById('profile-email');
                const profilePhone = document.getElementById('profile-phone');
                const profileRut = document.getElementById('profile-rut');
                const profileBirthdate = document.getElementById('profile-birthdate');
                const adults = document.getElementById('adults');
                const children = document.getElementById('children');
                
                console.log('Elementos encontrados:');
                console.log('profileName:', profileName);
                console.log('profileLastname:', profileLastname);

                if (user.nombre) {
                    console.log('Llenando formulario con nombre:', user.nombre);
                    const nameParts = user.nombre.split(' ');
                    
                    // Separar nombres y apellidos - SIMPLE
                    if (nameParts.length >= 4) {
                        // 4+ partes: primeras 2 son nombres, resto son apellidos
                        if (profileName) profileName.value = nameParts.slice(0, 2).join(' ');
                        if (profileLastname) profileLastname.value = nameParts.slice(2).join(' ');
                    } else if (nameParts.length === 3) {
                        // 3 partes: primera es nombre, resto son apellidos
                        if (profileName) profileName.value = nameParts[0];
                        if (profileLastname) profileLastname.value = nameParts.slice(1).join(' ');
                    } else if (nameParts.length === 2) {
                        // 2 partes: primera es nombre, segunda es apellido
                        if (profileName) profileName.value = nameParts[0];
                        if (profileLastname) profileLastname.value = nameParts[1];
                    } else {
                        // 1 parte: solo nombre
                        if (profileName) profileName.value = user.nombre;
                        if (profileLastname) profileLastname.value = '';
                    }
                    
                    console.log('Nombres:', profileName ? profileName.value : 'Elemento no encontrado');
                    console.log('Apellidos:', profileLastname ? profileLastname.value : 'Elemento no encontrado');
                } else {
                    console.log('No hay nombre de usuario');
                    if (profileName) profileName.value = '';
                    if (profileLastname) profileLastname.value = '';
                }
                if (profileEmail) profileEmail.value = user.email || '';
                // Teléfono se deja vacío para que el cliente lo complete
                if (profilePhone) profilePhone.value = '';
                // RUT se deja vacío para que el cliente lo complete
                if (profileRut) profileRut.value = '';
                if (profileBirthdate) profileBirthdate.value = user.birthdate || '';
                if (adults) adults.value = user.adults || '2';
                if (children) children.value = user.children || '0';
                
                // Cargar preferencias de dieta
                if (user.diet && Array.isArray(user.diet)) {
                    user.diet.forEach(diet => {
                        const checkbox = document.querySelector(`input[name="diet"][value="${diet}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            }
        }

        // Función para mostrar modal de agregar dirección
        function showAddAddressModal() {
            const modal = document.getElementById('addressModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Resetear el modal a su estado inicial
            resetAddressModal();
        }

        // Función para resetear el modal a su estado inicial
        function resetAddressModal() {
            const modalContent = document.querySelector('.modal-content');
            const homeDelivery = document.getElementById('home-delivery');
            const storePickup = document.getElementById('store-pickup');
            const addressContainer = document.getElementById('address-input-container');
            const storesCarousel = document.getElementById('stores-carousel');
            const initialAddressField = document.querySelector('.initial-address-field');
            const modalSubtitle = document.getElementById('modal-subtitle');
            const initialAddressInput = document.getElementById('initial-address-input');
            
            // Remover clase expanded para mostrar el modal en tamaño normal
            if (modalContent) {
                modalContent.classList.remove('expanded');
            }
            
            // Activar "Despacho a domicilio" por defecto
            homeDelivery.classList.add('active');
            storePickup.classList.remove('active');
            
            // Mostrar solo el campo de dirección inicial
            initialAddressField.style.display = 'block';
            addressContainer.style.display = 'none';
            storesCarousel.style.display = 'none';
            
            // Limpiar campo inicial
            if (initialAddressInput) {
                initialAddressInput.value = '';
            }
            
            // Resetear subtítulo
            modalSubtitle.textContent = '¡Tú decides la opción que más te conviene!';
            
            // Ocultar sugerencias
            hideSuggestions();
        }

        // Función para seleccionar opción de entrega
        function selectDeliveryOption(option) {
            const modalContent = document.querySelector('.modal-content');
            const homeDelivery = document.getElementById('home-delivery');
            const storePickup = document.getElementById('store-pickup');
            const addressContainer = document.getElementById('address-input-container');
            const storesCarousel = document.getElementById('stores-carousel');
            const modalSubtitle = document.getElementById('modal-subtitle');
            const initialAddressField = document.querySelector('.initial-address-field');
            
            // Remover clase active de ambos botones
            homeDelivery.classList.remove('active');
            storePickup.classList.remove('active');
            
            // Agregar clase active al botón seleccionado y manejar tamaños
            if (option === 'home') {
                homeDelivery.classList.add('active');
                addressContainer.style.display = 'none';
                storesCarousel.style.display = 'none';
                initialAddressField.style.display = 'block';
                modalSubtitle.textContent = '¡Tú decides la opción que más te conviene!';
                
                // Volver al tamaño original para "Despacho a domicilio"
                if (modalContent) {
                    modalContent.classList.remove('expanded');
                }
                
                // Limpiar el campo inicial
                const initialAddressInput = document.getElementById('initial-address-input');
                if (initialAddressInput) {
                    initialAddressInput.value = '';
                }
                
                // Ocultar sugerencias
                hideSuggestions();
            } else {
                // Transición suave sin cortes - transformar modal actual
                const addressModal = document.getElementById('addressModal');
                const addressModalContent = addressModal.querySelector('.modal-content');
                
                // Cambiar contenido del modal actual sin cerrarlo
                if (addressModalContent) {
                    // Animar transformación del contenido - más rápido
                    addressModalContent.style.transition = 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)';
                    addressModalContent.style.transform = 'scale(0.98)';
                    addressModalContent.style.opacity = '0.85';
                    
                    setTimeout(() => {
                        // Cambiar el contenido del modal
                        const modalTitle = addressModal.querySelector('.modal-title');
                        const modalSubtitle = addressModal.querySelector('.modal-subtitle');
                        const deliveryOptions = addressModal.querySelector('.delivery-options');
                        const initialAddressField = addressModal.querySelector('.initial-address-field');
                        const addressContainer = addressModal.querySelector('#address-input-container');
                        const storesCarousel = addressModal.querySelector('#stores-carousel');
                        
                        // Cambiar título y subtítulo
                        if (modalTitle) {
                            modalTitle.textContent = 'Ingresa dirección y descubre lo que tenemos para ti.';
                        }
                        if (modalSubtitle) {
                modalSubtitle.textContent = '¡Te ayudamos a encontrar la tienda más cercana!';
                            modalSubtitle.id = 'store-modal-subtitle';
                        }
                        
                        // Cambiar botones de opción
                        if (deliveryOptions) {
                            deliveryOptions.innerHTML = `
                                <button class="delivery-option" id="store-home-delivery" onclick="selectStoreDeliveryOption('home')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="delivery-icon">
                                        <path d="M21.2567 16.8001C21.1704 17.6244 20.8102 18.2801 20.1469 18.7621C19.6713 19.1083 19.1374 19.2669 18.5515 19.2592C17.1805 19.2415 16.0695 18.1812 15.9376 16.8216C15.902 16.8216 15.864 16.8216 15.8272 16.8216C13.4936 16.8216 11.16 16.8216 8.82511 16.8204C8.73253 16.8204 8.70082 16.8407 8.68941 16.9409C8.53341 18.308 7.28924 19.3417 5.91063 19.2592C4.64997 19.1832 3.65565 18.3093 3.42356 17.0728C3.40834 16.989 3.39946 16.9041 3.38805 16.8153C3.26503 16.7899 3.142 16.7734 3.02406 16.7392C2.43938 16.5705 2.01959 16.0201 2.0031 15.4113C2.00183 15.3403 2.00056 15.268 2.00056 15.197C2.00056 12.3396 1.9993 9.48344 2.00056 6.62603C2.00056 5.81561 2.3227 5.16499 3.00123 4.70714C3.34873 4.47378 3.74063 4.36471 4.15535 4.36344C6.71852 4.35837 9.28042 4.35964 11.8436 4.35964C12.5373 4.35964 13.2311 4.34315 13.9235 4.37232C14.7416 4.40656 15.3808 4.77056 15.774 5.50996C15.9642 5.86761 16.0352 6.2557 16.0378 6.65774C16.0378 6.7034 16.0378 6.75032 16.0378 6.81374C16.0872 6.81374 16.1278 6.81374 16.1697 6.81374C16.6808 6.81374 17.1919 6.8074 17.703 6.815C18.3232 6.82388 18.8749 7.01412 19.3162 7.46816C19.5103 7.66728 19.6574 7.8981 19.7842 8.14415C20.1127 8.78589 20.4437 9.42637 20.7709 10.0694C20.8153 10.1569 20.8762 10.2165 20.9662 10.2545C21.3366 10.4131 21.7069 10.5729 22.0747 10.7378C22.686 11.0104 22.9955 11.4848 22.998 12.1531C23.0018 13.1792 22.9993 14.2052 22.998 15.2312C22.998 15.6079 22.9156 15.963 22.6733 16.2636C22.3766 16.6314 21.9745 16.7798 21.5167 16.8039C21.4355 16.8077 21.3531 16.8039 21.2567 16.8039V16.8001ZM14.5057 11.7689V11.6573C14.5057 9.99075 14.5057 8.32424 14.5057 6.65774C14.5057 6.61462 14.5057 6.5715 14.5019 6.52964C14.4689 6.15931 14.2749 5.94751 13.9261 5.90819C13.8411 5.89805 13.7549 5.89297 13.6699 5.89297C10.5144 5.89551 7.35773 5.89805 4.20228 5.90058C4.16676 5.90058 4.13125 5.90058 4.09574 5.90566C3.86872 5.93229 3.69243 6.04136 3.60873 6.2557C3.5618 6.37618 3.53263 6.51189 3.53263 6.63998C3.52756 8.31029 3.52883 9.97933 3.52883 11.6496C3.52883 11.6877 3.52883 11.7257 3.52883 11.7689H14.507H14.5057ZM14.4892 15.2858V13.3314H3.5339V15.2959C3.65185 15.3225 3.73048 15.2972 3.7977 15.1894C4.42169 14.1786 5.41347 13.826 6.46233 13.9655C7.27909 14.0746 7.88279 14.5083 8.30893 15.2021C8.35205 15.2718 8.39771 15.2972 8.47888 15.2959C8.92531 15.2896 9.37174 15.287 9.81817 15.2858C11.3261 15.2858 12.8341 15.2858 14.3421 15.2858H14.4879H14.4892ZM21.4647 15.2858C21.4685 15.2655 21.4723 15.2553 21.4723 15.2452C21.4723 14.2306 21.4735 13.2147 21.4697 12.2001C21.4697 12.1646 21.4266 12.1126 21.3911 12.0961C21.0106 11.9249 20.6289 11.7574 20.2433 11.5964C20.1533 11.5596 20.0506 11.5393 19.9529 11.538C18.6922 11.5342 17.4303 11.5355 16.1697 11.5355C16.1329 11.5355 16.0948 11.5406 16.0593 11.5431V15.2756C16.2014 15.3048 16.3028 15.2921 16.3878 15.1463C16.4829 14.9814 16.6097 14.8292 16.7467 14.696C17.7157 13.7499 19.1805 13.67 20.2446 14.5007C20.4602 14.6694 20.6669 14.8507 20.7823 15.1145C20.8102 15.178 20.8838 15.2388 20.951 15.2667C21.1172 15.3352 21.2922 15.3086 21.4647 15.287V15.2858ZM16.0504 9.97806H19.0118C18.9966 9.94509 18.9865 9.92353 18.9751 9.90197C18.7455 9.48217 18.5121 9.06491 18.2889 8.64131C18.1862 8.446 18.034 8.37117 17.8209 8.3699C17.3567 8.36863 16.8926 8.35722 16.4284 8.35088C16.3041 8.34961 16.1811 8.35088 16.0492 8.35088V9.97806H16.0504ZM18.6174 15.4709C17.9998 15.4709 17.4684 15.9744 17.4658 16.5642C17.4633 17.1958 17.9744 17.7449 18.5603 17.7399C19.2211 17.7348 19.7322 17.2452 19.736 16.6149C19.7398 15.9884 19.2338 15.4709 18.6174 15.4709ZM6.05648 15.4709C5.43503 15.4709 4.92265 15.977 4.92012 16.5972C4.91631 17.2211 5.43376 17.7424 6.05395 17.7399C6.67286 17.7373 7.18397 17.2237 7.18524 16.6048C7.18524 15.9808 6.6792 15.4709 6.05775 15.4709H6.05648Z"></path>
                                    </svg>
                                    Despacho a domicilio
                                </button>
                                <button class="delivery-option active" id="store-pickup" onclick="selectStoreDeliveryOption('store')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" viewBox="0 0 24 24" class="delivery-icon">
                                        <path d="M20.3511 13.1096V19.0067H21.2238V20.7522H3.77315V19.0067H4.64591V13.1096C3.55496 12.3818 2.90039 11.1563 2.90039 9.8442C2.90039 9.12238 3.09616 8.42746 3.45334 7.83416L5.81905 3.73638C5.97447 3.46588 6.2629 3.3 6.57524 3.3H18.4232C18.7356 3.3 19.0225 3.46588 19.1794 3.73638L21.5377 7.82221C22.6197 9.61853 22.0966 11.9469 20.3526 13.1096H20.3511ZM18.6056 13.7462C17.3891 13.8822 16.1801 13.4443 15.3342 12.5596C14.5945 13.3337 13.5693 13.7716 12.4992 13.7716C11.4277 13.7716 10.404 13.3352 9.66427 12.5611C8.81841 13.4443 7.60791 13.8837 6.39292 13.7462V19.0052H18.6086V13.7462H18.6056ZM7.07887 5.04402L4.95675 8.72037C4.50543 9.83673 5.04343 11.1085 6.15979 11.5613C7.15808 11.9648 8.30283 11.5807 8.85279 10.6542C9.1457 9.9234 10.1784 9.9234 10.4728 10.6542C10.9196 11.7735 12.1884 12.319 13.3077 11.8722C13.8637 11.651 14.303 11.2101 14.5257 10.6542C14.8186 9.9234 15.8513 9.9234 16.1457 10.6542C16.5985 11.7705 17.8718 12.3071 18.9881 11.8542C20.1045 11.4014 20.641 10.1281 20.1882 9.01179C20.1449 8.90568 20.094 8.80406 20.0358 8.70692L17.9196 5.04552H7.08186L7.07887 5.04402Z"></path>
                                    </svg>
                                    Retiro en tienda
                                    <div class="free-badge">Gratis</div>
                                </button>
                            `;
                        }
                        
                        // Reemplazar el carrusel con la estructura correcta del modal de tienda
                        if (storesCarousel) {
                            storesCarousel.innerHTML = `
                                <div class="carousel-viewport">
                                    <div class="carousel-camera" id="store-carousel-camera">
                                        <div class="carousel-content" id="store-carousel-content">
                                            <!-- Las tiendas se cargarán dinámicamente -->
                                        </div>
                                    </div>
                                </div>
                                <div class="carousel-controls">
                                    <button class="carousel-prev" id="store-carousel-prev">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                            <path fill-rule="evenodd" d="M7.72 12.53a.75.75 0 010-1.06l7.5-7.5a.75.75 0 111.06 1.06L9.31 12l6.97 6.97a.75.75 0 11-1.06 1.06l-7.5-7.5z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                    <div class="carousel-pagination" id="store-carousel-pagination">
                                        <!-- Los indicadores se generarán dinámicamente -->
                                    </div>
                                    <button class="carousel-next" id="store-carousel-next">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                                            <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 010 1.06l-7.5 7.5a.75.75 0 01-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 011.06-1.06l7.5 7.5z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="carousel-actions">
                                    <button class="btn btn-primary" id="store-view-hours-btn" disabled="">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"></circle>
                                            <polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2"></polyline>
                                        </svg>
                                        Ver horarios
                                    </button>
                                </div>
                            `;
                            storesCarousel.style.display = 'flex';
                        }
                        
                        // Ocultar campo de dirección inicial y contenedor de dirección
                        if (initialAddressField) {
                            initialAddressField.style.display = 'none';
                        }
                        if (addressContainer) {
                            addressContainer.style.display = 'none';
                        }
                        
                        // Cambiar clase del modal para aplicar estilos de tienda
                        addressModalContent.classList.remove('address-modal');
                        addressModalContent.classList.add('store-modal');
                        
                        // Animar entrada del nuevo contenido
                        addressModalContent.style.transform = 'scale(1)';
                        addressModalContent.style.opacity = '1';
                        
                        // Cargar carrusel de tiendas con los nuevos IDs
                        loadStoreStoresCarousel();
                        
                        // Inicializar controles del carrusel
                        initializeStoreCarouselControls();
                        
                        // Limpiar estilos de transición
                        setTimeout(() => {
                            addressModalContent.style.transition = '';
                        }, 200);
                        
                    }, 100);
                }
            }
        }

        // Variables globales para el carrusel
        let currentStoreIndex = 0;
        let selectedStore = null;

        // Función para cargar el carrusel de tiendas
        function loadStoresCarousel() {
            const carouselContent = document.getElementById('carousel-content');
            const carouselPagination = document.getElementById('carousel-pagination');
            
            if (!carouselContent || !carouselPagination) {
                console.error('Carrusel elements not found');
                return;
            }
            
            console.log(`Loading ${stores.length} stores into carousel`);
            
            // Actualizar estados antes de cargar
            updateStoreStatuses();
            
            // Resetear índice actual
            currentStoreIndex = 0;
            
            // Generar HTML de las tiendas
            carouselContent.innerHTML = stores.map((store, index) => `
                <div class="store-card" data-index="${index}" onclick="selectStore(${index})">
                    <img src="${store.image}" alt="${store.name}" class="store-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTEwIiBlaWdodD0iMTEwIiB2aWV3Qm94PSIwIDAgMTEwIDExMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNTUiIGN5PSI1NSIgcj0iNTUiIGZpbGw9IiNGRkQ3MDAiLz4KPHA+YXRoIGQ9Ik01NSAyMmMtNiAwLTExIDUtMTEgMTFzNSAxMSAxMSAxMSAxMS01IDExLTExLTUtMTEtMTEtMTF6bTAgMTN2MzNtMCAwaC02bTYgMGg2bS02LTZoMTJ2LTYiIGZpbGw9Im5vbmUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjx0ZXh0IHg9IjU1IiB5PSI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyMCIgZm9udC13ZWlnaHQ9ImJvbGQiPkZSRVNQPC90ZXh0Pgo8L3N2Zz4K'">
                    <div class="store-info">
                        <div class="store-status ${store.isOpen ? 'open' : 'closed'}">
                            ${store.isOpen ? '• Abierta' : '• Cerrada'}
                        </div>
                        <div class="store-name">${store.name}</div>
                        <div class="store-address">Dirección: ${store.address}</div>
                        <div class="store-hours">Horario: ${store.hours}</div>
                    </div>
                </div>
            `).join('');
            
            // Generar indicadores de paginación
            carouselPagination.innerHTML = stores.map((_, index) => `
                <div class="pagination-bullet ${index === 0 ? 'active' : ''}" onclick="goToStore(${index})"></div>
            `).join('');
            
            // Actualizar posición del carrusel
            setTimeout(() => {
                updateCarouselPosition();
                updatePagination();
            }, 100);
        }

        // Función para seleccionar una tienda
        function selectStore(index) {
            // Remover selección anterior
            document.querySelectorAll('.store-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Seleccionar nueva tienda
            const storeCard = document.querySelector(`[data-index="${index}"]`);
            if (storeCard) {
                storeCard.classList.add('selected');
                selectedStore = stores[index];
                
                // Habilitar botón "Ver horarios"
                const viewHoursBtn = document.getElementById('view-hours-btn');
                if (viewHoursBtn) {
                    viewHoursBtn.disabled = false;
                }
            }
        }

        // Función para ir a una tienda específica
        function goToStore(index) {
            currentStoreIndex = index;
            updateCarouselPosition();
            updatePagination();
        }

        // Función para actualizar la posición del carrusel
        function updateCarouselPosition() {
            const carouselCamera = document.getElementById('carousel-camera');
            if (carouselCamera) {
                const translateX = -currentStoreIndex * 100;
                carouselCamera.style.transform = `translateX(${translateX}%)`;
                console.log(`Moving to store ${currentStoreIndex}, translateX: ${translateX}%`);
            }
        }

        // Función para actualizar la paginación
        function updatePagination() {
            document.querySelectorAll('.pagination-bullet').forEach((bullet, index) => {
                bullet.classList.toggle('active', index === currentStoreIndex);
            });
        }

        // Función para ir a la tienda anterior
        function prevStore() {
            if (currentStoreIndex > 0) {
                currentStoreIndex--;
                updateCarouselPosition();
                updatePagination();
                console.log(`Previous store: ${currentStoreIndex}`);
            } else {
                console.log('Already at first store');
            }
        }

        // Función para ir a la tienda siguiente
        function nextStore() {
            if (currentStoreIndex < stores.length - 1) {
                currentStoreIndex++;
                updateCarouselPosition();
                updatePagination();
                console.log(`Next store: ${currentStoreIndex}`);
            } else {
                console.log('Already at last store');
            }
        }

        // Función para cerrar modal de agregar dirección
        function closeAddressModal() {
            const modal = document.getElementById('addressModal');
            const modalContent = modal.querySelector('.modal-content');
            const overlay = modal.querySelector('.modal-overlay');
            
            // Agregar clase de cierre para animación
            if (modalContent) {
                modalContent.classList.add('closing');
            }
            if (overlay) {
                overlay.classList.add('closing');
            }
            
            // Esperar a que termine la animación antes de ocultar - optimizado
            setTimeout(() => {
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
                
                // Remover clases de animación
                if (modalContent) {
                    modalContent.classList.remove('closing');
                }
                if (overlay) {
                    overlay.classList.remove('closing');
                }
            
            // Limpiar formulario
                const addressInput = document.getElementById('address-input');
                if (addressInput) {
                    addressInput.value = '';
                }
                const mapContainer = document.getElementById('map-container');
                if (mapContainer) {
                    mapContainer.style.display = 'none';
                }
            
            // Limpiar mapa si existe
            if (addressMap) {
                addressMap.remove();
                addressMap = null;
                addressMarker = null;
            }
            
            // Ocultar sugerencias
            hideSuggestions();
            }, 200);
        }

        // Función para abrir modal de tienda
        function openStoreModal() {
            const modal = document.getElementById('storeModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Asegurar que los botones estén en el estado correcto
                const homeDeliveryBtn = document.getElementById('store-home-delivery');
                const storePickupBtn = document.getElementById('store-pickup');
                const modalSubtitle = document.getElementById('store-modal-subtitle');
                
                if (homeDeliveryBtn && storePickupBtn) {
                    homeDeliveryBtn.classList.remove('active');
                    storePickupBtn.classList.add('active');
                }
                
                if (modalSubtitle) {
                    modalSubtitle.textContent = '¡Te ayudamos a encontrar la tienda más cercana!';
                }
                
                loadStoreStoresCarousel();
            }
        }

        // Función para cargar carrusel de tiendas en modal de tienda
        function loadStoreStoresCarousel() {
            const carouselContent = document.getElementById('store-carousel-content');
            const pagination = document.getElementById('store-carousel-pagination');
            
            if (!carouselContent || !pagination) {
                console.log('Carrusel elements not found, trying alternative IDs...');
                // Intentar con IDs alternativos si no se encuentran
                const altCarouselContent = document.querySelector('#store-carousel-content, .carousel-content');
                const altPagination = document.querySelector('#store-carousel-pagination, .carousel-pagination');
                
                if (!altCarouselContent || !altPagination) {
                    console.log('Alternative carrusel elements not found either');
                    return;
                }
                
                // Actualizar estados antes de cargar
                updateStoreStatuses();
                
                // Usar elementos alternativos
                carouselContent = altCarouselContent;
                pagination = altPagination;
            }
            
            // Actualizar estados antes de cargar
            updateStoreStatuses();
            
            // Limpiar contenido existente
            carouselContent.innerHTML = '';
            pagination.innerHTML = '';
            
            // Cargar tiendas
            stores.forEach((store, index) => {
                const storeCard = document.createElement('div');
                storeCard.className = 'store-card';
                storeCard.setAttribute('data-index', index);
                storeCard.onclick = () => selectStore(index);
                
                storeCard.innerHTML = `
                    <img src="${store.image}" alt="${store.name}" class="store-image" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTEwIiBlaWdodD0iMTEwIiB2aWV3Qm94PSIwIDAgMTEwIDExMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNTUiIGN5PSI1NSIgcj0iNTUiIGZpbGw9IiNGRkQ3MDAiLz4KPHA+YXRoIGQ9Ik01NSAyMmMtNiAwLTExIDUtMTEgMTFzNSAxMSAxMSAxMSAxMS01IDExLTExLTUtMTEtMTEtMTF6bTAgMTN2MzNtMCAwaC02bTYgMGg2bS02LTZoMTJ2LTYiIGZpbGw9Im5vbmUiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjx0ZXh0IHg9IjU1IiB5PSI4MCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0id2hpdGUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyMCIgZm9udC13ZWlnaHQ9ImJvbGQiPkZSRVNQPC90ZXh0Pgo8L3N2Zz4K'">
                    <div class="store-info">
                        <div class="store-status ${store.isOpen ? 'open' : 'closed'}">
                            • ${store.isOpen ? 'Abierta' : 'Cerrada'}
                        </div>
                        <div class="store-name">${store.name}</div>
                        <div class="store-address">Dirección: ${store.address}</div>
                        <div class="store-hours">Horario: ${store.hours}</div>
                    </div>
                `;
                
                carouselContent.appendChild(storeCard);
                
                // Crear punto de paginación
                const bullet = document.createElement('div');
                bullet.className = 'pagination-bullet';
                if (index === 0) bullet.classList.add('active');
                bullet.onclick = () => goToStore(index);
                pagination.appendChild(bullet);
            });
            
            // Inicializar carrusel
            currentStoreIndex = 0;
            selectedStore = null;
            updateStoreCarousel();
        }

        // Función para actualizar carrusel de tiendas en modal de tienda
        function updateStoreCarousel() {
            const camera = document.getElementById('store-carousel-camera') || document.querySelector('.carousel-camera');
            const bullets = document.querySelectorAll('#store-carousel-pagination .pagination-bullet, .carousel-pagination .pagination-bullet');
            
            if (camera) {
                camera.style.transform = `translateX(-${currentStoreIndex * 100}%)`;
            }
            
            // Actualizar bullets
            bullets.forEach((bullet, index) => {
                bullet.classList.toggle('active', index === currentStoreIndex);
            });
        }

        // Función para inicializar controles del carrusel de tienda
        function initializeStoreCarouselControls() {
            const prevBtn = document.getElementById('store-carousel-prev') || document.querySelector('.carousel-prev');
            const nextBtn = document.getElementById('store-carousel-next') || document.querySelector('.carousel-next');
            
            if (prevBtn) {
                // Remover listeners existentes para evitar duplicados
                prevBtn.replaceWith(prevBtn.cloneNode(true));
                const newPrevBtn = document.getElementById('store-carousel-prev') || document.querySelector('.carousel-prev');
                
                newPrevBtn.addEventListener('click', () => {
                    if (currentStoreIndex > 0) {
                        currentStoreIndex--;
                        updateStoreCarousel();
                    }
                });
            }
            
            if (nextBtn) {
                // Remover listeners existentes para evitar duplicados
                nextBtn.replaceWith(nextBtn.cloneNode(true));
                const newNextBtn = document.getElementById('store-carousel-next') || document.querySelector('.carousel-next');
                
                newNextBtn.addEventListener('click', () => {
                    if (currentStoreIndex < stores.length - 1) {
                        currentStoreIndex++;
                        updateStoreCarousel();
                    }
                });
            }
        }

        // Función para abrir modal de dirección
        function openAddressModal() {
            const modal = document.getElementById('addressModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Asegurar que los botones estén en el estado correcto
                const homeDelivery = document.getElementById('home-delivery');
                const storePickup = document.getElementById('store-pickup');
                const modalSubtitle = document.getElementById('modal-subtitle');
                const modalContent = document.querySelector('.modal-content.address-modal');
                const addressContainer = document.getElementById('address-input-container');
                const storesCarousel = document.getElementById('stores-carousel');
                const initialAddressField = document.querySelector('.initial-address-field');
                
                if (homeDelivery && storePickup) {
                    homeDelivery.classList.add('active');
                    storePickup.classList.remove('active');
                }
                
                if (modalSubtitle) {
                    modalSubtitle.textContent = '¡Tú decides la opción que más te conviene!';
                }
                
                // Resetear modal a estado básico (sin expanded)
                if (modalContent) {
                    modalContent.classList.remove('expanded');
                }
                
                // Ocultar contenedores expandidos
                if (addressContainer) {
                    addressContainer.style.display = 'none';
                }
                
                if (storesCarousel) {
                    storesCarousel.style.display = 'none';
                }
                
                // Mostrar campo de dirección inicial
                if (initialAddressField) {
                    initialAddressField.style.display = 'block';
                }
                
                // Limpiar campo de dirección inicial
                const initialAddressInput = document.getElementById('initial-address-input');
                if (initialAddressInput) {
                    initialAddressInput.value = '';
                }
                
                // Ocultar sugerencias
                hideSuggestions();
            }
        }

        // Función para cerrar modal de tienda
        function closeStoreModal() {
            const modal = document.getElementById('storeModal');
            const modalContent = modal.querySelector('.modal-content');
            const overlay = modal.querySelector('.modal-overlay');
            
            // Agregar clase de cierre para animación
            if (modalContent) {
                modalContent.classList.add('closing');
            }
            if (overlay) {
                overlay.classList.add('closing');
            }
            
            // Esperar a que termine la animación antes de ocultar - optimizado
            setTimeout(() => {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
                
                // Remover clases de animación
                if (modalContent) {
                    modalContent.classList.remove('closing');
                }
                if (overlay) {
                    overlay.classList.remove('closing');
                }
            }, 200);
        }

        // Función para manejar opciones de entrega en modal de tienda
        function selectStoreDeliveryOption(option) {
            const homeDeliveryBtn = document.getElementById('store-home-delivery');
            const storePickupBtn = document.getElementById('store-pickup');
            const modalSubtitle = document.getElementById('store-modal-subtitle');
            
            // Remover clase active de ambos botones primero
            homeDeliveryBtn.classList.remove('active');
            storePickupBtn.classList.remove('active');
            
            if (option === 'home') {
                // Transición suave sin cortes - transformar modal actual de vuelta
                const addressModal = document.getElementById('addressModal');
                const addressModalContent = addressModal.querySelector('.modal-content');
                
                // Cambiar contenido del modal actual sin cerrarlo
                if (addressModalContent) {
                    // Animar transformación del contenido - más rápido
                    addressModalContent.style.transition = 'all 0.2s cubic-bezier(0.4, 0, 0.2, 1)';
                    addressModalContent.style.transform = 'scale(0.98)';
                    addressModalContent.style.opacity = '0.85';
                    
                    setTimeout(() => {
                        // Cambiar el contenido del modal de vuelta a dirección
                        const modalTitle = addressModal.querySelector('.modal-title');
                        const modalSubtitle = addressModal.querySelector('.modal-subtitle');
                        const deliveryOptions = addressModal.querySelector('.delivery-options');
                        const initialAddressField = addressModal.querySelector('.initial-address-field');
                        const addressContainer = addressModal.querySelector('#address-input-container');
                        const storesCarousel = addressModal.querySelector('#stores-carousel');
                        
                        // Cambiar título y subtítulo
                        if (modalTitle) {
                            modalTitle.textContent = 'Ingresa dirección y descubre lo que tenemos para ti.';
                        }
                        if (modalSubtitle) {
                            modalSubtitle.textContent = '¡Tú decides la opción que más te conviene!';
                            modalSubtitle.id = 'modal-subtitle';
                        }
                        
                        // Cambiar botones de opción de vuelta a dirección
                        if (deliveryOptions) {
                            deliveryOptions.innerHTML = `
                                <button class="delivery-option active" id="home-delivery" onclick="selectDeliveryOption('home')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="delivery-icon">
                                        <path d="M21.2567 16.8001C21.1704 17.6244 20.8102 18.2801 20.1469 18.7621C19.6713 19.1083 19.1374 19.2669 18.5515 19.2592C17.1805 19.2415 16.0695 18.1812 15.9376 16.8216C15.902 16.8216 15.864 16.8216 15.8272 16.8216C13.4936 16.8216 11.16 16.8216 8.82511 16.8204C8.73253 16.8204 8.70082 16.8407 8.68941 16.9409C8.53341 18.308 7.28924 19.3417 5.91063 19.2592C4.64997 19.1832 3.65565 18.3093 3.42356 17.0728C3.40834 16.989 3.39946 16.9041 3.38805 16.8153C3.26503 16.7899 3.142 16.7734 3.02406 16.7392C2.43938 16.5705 2.01959 16.0201 2.0031 15.4113C2.00183 15.3403 2.00056 15.268 2.00056 15.197C2.00056 12.3396 1.9993 9.48344 2.00056 6.62603C2.00056 5.81561 2.3227 5.16499 3.00123 4.70714C3.34873 4.47378 3.74063 4.36471 4.15535 4.36344C6.71852 4.35837 9.28042 4.35964 11.8436 4.35964C12.5373 4.35964 13.2311 4.34315 13.9235 4.37232C14.7416 4.40656 15.3808 4.77056 15.774 5.50996C15.9642 5.86761 16.0352 6.2557 16.0378 6.65774C16.0378 6.7034 16.0378 6.75032 16.0378 6.81374C16.0872 6.81374 16.1278 6.81374 16.1697 6.81374C16.6808 6.81374 17.1919 6.8074 17.703 6.815C18.3232 6.82388 18.8749 7.01412 19.3162 7.46816C19.5103 7.66728 19.6574 7.8981 19.7842 8.14415C20.1127 8.78589 20.4437 9.42637 20.7709 10.0694C20.8153 10.1569 20.8762 10.2165 20.9662 10.2545C21.3366 10.4131 21.7069 10.5729 22.0747 10.7378C22.686 11.0104 22.9955 11.4848 22.998 12.1531C23.0018 13.1792 22.9993 14.2052 22.998 15.2312C22.998 15.6079 22.9156 15.963 22.6733 16.2636C22.3766 16.6314 21.9745 16.7798 21.5167 16.8039C21.4355 16.8077 21.3531 16.8039 21.2567 16.8039V16.8001ZM14.5057 11.7689V11.6573C14.5057 9.99075 14.5057 8.32424 14.5057 6.65774C14.5057 6.61462 14.5057 6.5715 14.5019 6.52964C14.4689 6.15931 14.2749 5.94751 13.9261 5.90819C13.8411 5.89805 13.7549 5.89297 13.6699 5.89297C10.5144 5.89551 7.35773 5.89805 4.20228 5.90058C4.16676 5.90058 4.13125 5.90058 4.09574 5.90566C3.86872 5.93229 3.69243 6.04136 3.60873 6.2557C3.5618 6.37618 3.53263 6.51189 3.53263 6.63998C3.52756 8.31029 3.52883 9.97933 3.52883 11.6496C3.52883 11.6877 3.52883 11.7257 3.52883 11.7689H14.507H14.5057ZM14.4892 15.2858V13.3314H3.5339V15.2959C3.65185 15.3225 3.73048 15.2972 3.7977 15.1894C4.42169 14.1786 5.41347 13.826 6.46233 13.9655C7.27909 14.0746 7.88279 14.5083 8.30893 15.2021C8.35205 15.2718 8.39771 15.2972 8.47888 15.2959C8.92531 15.2896 9.37174 15.287 9.81817 15.2858C11.3261 15.2858 12.8341 15.2858 14.3421 15.2858H14.4879H14.4892ZM21.4647 15.2858C21.4685 15.2655 21.4723 15.2553 21.4723 15.2452C21.4723 14.2306 21.4735 13.2147 21.4697 12.2001C21.4697 12.1646 21.4266 12.1126 21.3911 12.0961C21.0106 11.9249 20.6289 11.7574 20.2433 11.5964C20.1533 11.5596 20.0506 11.5393 19.9529 11.538C18.6922 11.5342 17.4303 11.5355 16.1697 11.5355C16.1329 11.5355 16.0948 11.5406 16.0593 11.5431V15.2756C16.2014 15.3048 16.3028 15.2921 16.3878 15.1463C16.4829 14.9814 16.6097 14.8292 16.7467 14.696C17.7157 13.7499 19.1805 13.67 20.2446 14.5007C20.4602 14.6694 20.6669 14.8507 20.7823 15.1145C20.8102 15.178 20.8838 15.2388 20.951 15.2667C21.1172 15.3352 21.2922 15.3086 21.4647 15.287V15.2858ZM16.0504 9.97806H19.0118C18.9966 9.94509 18.9865 9.92353 18.9751 9.90197C18.7455 9.48217 18.5121 9.06491 18.2889 8.64131C18.1862 8.446 18.034 8.37117 17.8209 8.3699C17.3567 8.36863 16.8926 8.35722 16.4284 8.35088C16.3041 8.34961 16.1811 8.35088 16.0492 8.35088V9.97806H16.0504ZM18.6174 15.4709C17.9998 15.4709 17.4684 15.9744 17.4658 16.5642C17.4633 17.1958 17.9744 17.7449 18.5603 17.7399C19.2211 17.7348 19.7322 17.2452 19.736 16.6149C19.7398 15.9884 19.2338 15.4709 18.6174 15.4709ZM6.05648 15.4709C5.43503 15.4709 4.92265 15.977 4.92012 16.5972C4.91631 17.2211 5.43376 17.7424 6.05395 17.7399C6.67286 17.7373 7.18397 17.2237 7.18524 16.6048C7.18524 15.9808 6.6792 15.4709 6.05775 15.4709H6.05648Z"></path>
                                    </svg>
                                    Despacho a domicilio
                                </button>
                                <button class="delivery-option" id="store-pickup" onclick="selectDeliveryOption('store')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="25" height="24" viewBox="0 0 24 24" class="delivery-icon">
                                        <path d="M20.3511 13.1096V19.0067H21.2238V20.7522H3.77315V19.0067H4.64591V13.1096C3.55496 12.3818 2.90039 11.1563 2.90039 9.8442C2.90039 9.12238 3.09616 8.42746 3.45334 7.83416L5.81905 3.73638C5.97447 3.46588 6.2629 3.3 6.57524 3.3H18.4232C18.7356 3.3 19.0225 3.46588 19.1794 3.73638L21.5377 7.82221C22.6197 9.61853 22.0966 11.9469 20.3526 13.1096H20.3511ZM18.6056 13.7462C17.3891 13.8822 16.1801 13.4443 15.3342 12.5596C14.5945 13.3337 13.5693 13.7716 12.4992 13.7716C11.4277 13.7716 10.404 13.3352 9.66427 12.5611C8.81841 13.4443 7.60791 13.8837 6.39292 13.7462V19.0052H18.6086V13.7462H18.6056ZM7.07887 5.04402L4.95675 8.72037C4.50543 9.83673 5.04343 11.1085 6.15979 11.5613C7.15808 11.9648 8.30283 11.5807 8.85279 10.6542C9.1457 9.9234 10.1784 9.9234 10.4728 10.6542C10.9196 11.7735 12.1884 12.319 13.3077 11.8722C13.8637 11.651 14.303 11.2101 14.5257 10.6542C14.8186 9.9234 15.8513 9.9234 16.1457 10.6542C16.5985 11.7705 17.8718 12.3071 18.9881 11.8542C20.1045 11.4014 20.641 10.1281 20.1882 9.01179C20.1449 8.90568 20.094 8.80406 20.0358 8.70692L17.9196 5.04552H7.08186L7.07887 5.04402Z"></path>
                                    </svg>
                                    Retiro en tienda
                                    <div class="free-badge">Gratis</div>
                                </button>
                            `;
                        }
                        
                        // Mostrar campo de dirección inicial y ocultar carrusel
                        if (initialAddressField) {
                            initialAddressField.style.display = 'block';
                        }
                        if (storesCarousel) {
                            storesCarousel.style.display = 'none';
                        }
                        if (addressContainer) {
                            addressContainer.style.display = 'none';
                        }
                        
                        // Cambiar clase del modal de vuelta a dirección
                        addressModalContent.classList.remove('store-modal');
                        addressModalContent.classList.add('address-modal');
                        
                        // Animar entrada del nuevo contenido
                        addressModalContent.style.transform = 'scale(1)';
                        addressModalContent.style.opacity = '1';
                        
                        // Limpiar estilos de transición
                        setTimeout(() => {
                            addressModalContent.style.transition = '';
                        }, 200);
                        
                    }, 100);
                }
            } else {
                // Mantener en retiro en tienda
                storePickupBtn.classList.add('active');
                modalSubtitle.textContent = '¡Te ayudamos a encontrar la tienda más cercana!';
            }
        }

        // Función para manejar el botón Continuar
        function handleContinueButton() {
            const continueBtn = document.getElementById('continue-btn');
            if (continueBtn) {
                continueBtn.addEventListener('click', function() {
                    // Aquí puedes agregar la lógica para continuar con el proceso
                    console.log('Continuar con la dirección seleccionada');
                    
                    // Por ejemplo, cerrar el modal y continuar con el flujo
                    closeAddressModal();
                    
                    // O mostrar un mensaje de confirmación
                    alert('Dirección seleccionada correctamente');
                });
            }
        }


        // Base de datos de tiendas para retiro con horarios estructurados
        const stores = [
            {
                name: 'Tienda Copihue',
                address: 'Copihue 2891, Providencia',
                hours: 'Lunes a viernes de 10:00 a 20:00 horas. Sábados, domingos y festivos de 10:00 a 19:00 horas.',
                isOpen: false, // Se calculará automáticamente
                image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNGRkQ3MDAiLz4KPHRleHQgeD0iMzAiIHk9IjM1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCI+RlJFU1Q8L3RleHQ+Cjwvc3ZnPgo=',
                schedule: {
                    weekdays: { open: '10:00', close: '20:00' },
                    saturday: { open: '10:00', close: '19:00' },
                    sunday: { open: '10:00', close: '19:00' }
                }
            },
            {
                name: 'Tienda Santiago',
                address: 'Av. Providencia 1234, Providencia',
                hours: 'Lunes a viernes de 10:00 a 20:00 horas. Sábados, domingos y festivos de 10:00 a 19:00 horas.',
                isOpen: true,
                image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNGRkQ3MDAiLz4KPHRleHQgeD0iMzAiIHk9IjM1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCI+RlJFU1Q8L3RleHQ+Cjwvc3ZnPgo=',
                schedule: {
                    weekdays: { open: '10:00', close: '20:00' },
                    saturday: { open: '10:00', close: '19:00' },
                    sunday: { open: '10:00', close: '19:00' }
                }
            },
            {
                name: 'Tienda Puerto Montt',
                address: 'Av. Diego Portales 567, Puerto Montt',
                hours: 'Lunes a viernes de 10:00 a 20:00 horas. Sábados, domingos y festivos de 10:00 a 19:00 horas.',
                isOpen: false,
                image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNGRkQ3MDAiLz4KPHRleHQgeD0iMzAiIHk9IjM1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCI+RlJFU1Q8L3RleHQ+Cjwvc3ZnPgo=',
                schedule: {
                    weekdays: { open: '10:00', close: '20:00' },
                    saturday: { open: '10:00', close: '19:00' },
                    sunday: { open: '10:00', close: '19:00' }
                }
            },
            {
                name: 'Tienda Villarrica',
                address: 'Av. Bernardo O\'Higgins 890, Villarrica',
                hours: 'Lunes a viernes de 10:00 a 20:00 horas. Sábados, domingos y festivos de 10:00 a 19:00 horas.',
                isOpen: true,
                image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiNGRkQ3MDAiLz4KPHRleHQgeD0iMzAiIHk9IjM1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCI+RlJFU1Q8L3RleHQ+Cjwvc3ZnPgo=',
                schedule: {
                    weekdays: { open: '10:00', close: '20:00' },
                    saturday: { open: '10:00', close: '19:00' },
                    sunday: { open: '10:00', close: '19:00' }
                }
            },
            {
                name: 'Tienda Nacimiento',
                address: 'Av. Manuel Rodríguez 234, Nacimiento',
                hours: 'Lunes a viernes de 10:00 a 20:00 horas. Sábados, domingos y festivos de 10:00 a 19:00 horas.',
                isOpen: true,
                image: 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=150&h=150&fit=crop&crop=center',
                schedule: {
                    weekdays: { open: '10:00', close: '20:00' },
                    saturday: { open: '10:00', close: '19:00' },
                    sunday: { open: '10:00', close: '19:00' }
                }
            },
            {
                name: 'Tienda Viña del Mar',
                address: 'Av. Libertad 456, Viña del Mar',
                hours: 'Lunes a viernes de 10:00 a 20:00 horas. Sábados, domingos y festivos de 10:00 a 19:00 horas.',
                isOpen: false,
                image: 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=150&h=150&fit=crop&crop=center',
                schedule: {
                    weekdays: { open: '10:00', close: '20:00' },
                    saturday: { open: '10:00', close: '19:00' },
                    sunday: { open: '10:00', close: '19:00' }
                }
            },
            {
                name: 'Tienda Valparaíso',
                address: 'Av. Argentina 789, Valparaíso',
                hours: 'Lunes a viernes de 10:00 a 20:00 horas. Sábados, domingos y festivos de 10:00 a 19:00 horas.',
                isOpen: true,
                image: 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?w=150&h=150&fit=crop&crop=center',
                schedule: {
                    weekdays: { open: '10:00', close: '20:00' },
                    saturday: { open: '10:00', close: '19:00' },
                    sunday: { open: '10:00', close: '19:00' }
                }
            },
            {
                name: 'Tienda Concepción',
                address: 'Av. Pedro de Valdivia 321, Concepción',
                hours: 'Lunes a viernes de 10:00 a 20:00 horas. Sábados, domingos y festivos de 10:00 a 19:00 horas.',
                isOpen: true,
                image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=150&h=150&fit=crop&crop=center',
                schedule: {
                    weekdays: { open: '10:00', close: '20:00' },
                    saturday: { open: '10:00', close: '19:00' },
                    sunday: { open: '10:00', close: '19:00' }
                }
            },
            {
                name: 'Tienda La Serena',
                address: 'Av. Francisco de Aguirre 654, La Serena',
                hours: 'Lunes a viernes de 10:00 a 20:00 horas. Sábados, domingos y festivos de 10:00 a 19:00 horas.',
                isOpen: false,
                image: 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=150&h=150&fit=crop&crop=center',
                schedule: {
                    weekdays: { open: '10:00', close: '20:00' },
                    saturday: { open: '10:00', close: '19:00' },
                    sunday: { open: '10:00', close: '19:00' }
                }
            },
            {
                name: 'Tienda Antofagasta',
                address: 'Av. Argentina 987, Antofagasta',
                hours: 'Lunes a viernes de 10:00 a 20:00 horas. Sábados, domingos y festivos de 10:00 a 19:00 horas.',
                isOpen: true,
                image: 'https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?w=150&h=150&fit=crop&crop=center',
                schedule: {
                    weekdays: { open: '10:00', close: '20:00' },
                    saturday: { open: '10:00', close: '19:00' },
                    sunday: { open: '10:00', close: '19:00' }
                }
            }
        ];

        // ===== SISTEMA DE HORARIOS AUTOMÁTICO =====
        
        // Función para convertir hora en formato "HH:MM" a minutos desde medianoche
        function timeToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        // Función para obtener el día de la semana actual (0 = domingo, 1 = lunes, ..., 6 = sábado)
        function getCurrentDayOfWeek() {
            return new Date().getDay();
        }
        
        // Función para obtener la hora actual en minutos desde medianoche
        function getCurrentTimeInMinutes() {
            const now = new Date();
            return now.getHours() * 60 + now.getMinutes();
        }
        
        // Función para verificar si una tienda está abierta según la hora actual
        function isStoreOpen(store) {
            const currentDay = getCurrentDayOfWeek();
            const currentTime = getCurrentTimeInMinutes();
            
            let schedule;
            
            // Determinar qué horario usar según el día
            if (currentDay === 0) { // Domingo
                schedule = store.schedule.sunday;
            } else if (currentDay === 6) { // Sábado
                schedule = store.schedule.saturday;
            } else { // Lunes a viernes
                schedule = store.schedule.weekdays;
            }
            
            const openTime = timeToMinutes(schedule.open);
            const closeTime = timeToMinutes(schedule.close);
            
            return currentTime >= openTime && currentTime < closeTime;
        }
        
        // Función para actualizar el estado de todas las tiendas
        function updateStoreStatuses() {
            stores.forEach(store => {
                store.isOpen = isStoreOpen(store);
            });
        }
        
        // Función para actualizar el estado visual de las tiendas en el carrusel
        function updateStoreStatusDisplay() {
            // Actualizar carrusel principal
            const storeCards = document.querySelectorAll('.store-card');
            storeCards.forEach((card, index) => {
                if (stores[index]) {
                    const statusElement = card.querySelector('.store-status');
                    if (statusElement) {
                        if (stores[index].isOpen) {
                            statusElement.textContent = '• Abierta';
                            statusElement.className = 'store-status open';
                        } else {
                            statusElement.textContent = '• Cerrada';
                            statusElement.className = 'store-status closed';
                        }
                    }
                }
            });
            
            // Actualizar carrusel de tienda modal
            const storeModalCards = document.querySelectorAll('#store-carousel-content .store-card');
            storeModalCards.forEach((card, index) => {
                if (stores[index]) {
                    const statusElement = card.querySelector('.store-status');
                    if (statusElement) {
                        if (stores[index].isOpen) {
                            statusElement.textContent = '• Abierta';
                            statusElement.className = 'store-status open';
                        } else {
                            statusElement.textContent = '• Cerrada';
                            statusElement.className = 'store-status closed';
                        }
                    }
                }
            });
        }
        
        // Función para actualizar el estado de las tiendas cada minuto
        function startStoreStatusUpdater() {
            // Actualizar inmediatamente
            updateStoreStatuses();
            updateStoreStatusDisplay();
            
            // Actualizar cada minuto
            setInterval(() => {
                updateStoreStatuses();
                updateStoreStatusDisplay();
            }, 60000); // 60000ms = 1 minuto
        }
        
        // Función para obtener información detallada del horario de una tienda
        function getStoreScheduleInfo(store) {
            const currentDay = getCurrentDayOfWeek();
            const currentTime = getCurrentTimeInMinutes();
            
            let schedule;
            let dayName;
            
            if (currentDay === 0) {
                schedule = store.schedule.sunday;
                dayName = 'Domingo';
            } else if (currentDay === 6) {
                schedule = store.schedule.saturday;
                dayName = 'Sábado';
            } else {
                schedule = store.schedule.weekdays;
                dayName = 'Lunes a Viernes';
            }
            
            const openTime = timeToMinutes(schedule.open);
            const closeTime = timeToMinutes(schedule.close);
            
            let nextChange;
            if (store.isOpen) {
                // Si está abierta, mostrar cuándo cierra
                const minutesUntilClose = closeTime - currentTime;
                const hoursUntilClose = Math.floor(minutesUntilClose / 60);
                const minsUntilClose = minutesUntilClose % 60;
                
                if (hoursUntilClose > 0) {
                    nextChange = `Cierra en ${hoursUntilClose}h ${minsUntilClose}m`;
                } else {
                    nextChange = `Cierra en ${minsUntilClose}m`;
                }
            } else {
                // Si está cerrada, mostrar cuándo abre
                const minutesUntilOpen = openTime - currentTime;
                if (minutesUntilOpen < 0) {
                    // Ya pasó la hora de apertura de hoy, mostrar apertura de mañana
                    nextChange = `Abre mañana a las ${schedule.open}`;
                } else {
                    const hoursUntilOpen = Math.floor(minutesUntilOpen / 60);
                    const minsUntilOpen = minutesUntilOpen % 60;
                    
                    if (hoursUntilOpen > 0) {
                        nextChange = `Abre en ${hoursUntilOpen}h ${minsUntilOpen}m`;
                    } else {
                        nextChange = `Abre en ${minsUntilOpen}m`;
                    }
                }
            }
            
            return {
                dayName,
                openTime: schedule.open,
                closeTime: schedule.close,
                nextChange,
                isOpen: store.isOpen
            };
        }

        // Base de datos de direcciones reales por ciudad
        const addressDatabase = {
            'santiago': [
                { street: 'Santiago', number: '', commune: 'Santiago', region: 'Metropolitana' },
                { street: 'Santiago Centro', number: '', commune: 'Santiago', region: 'Metropolitana' },
                { street: 'Santiago de Chile', number: '', commune: 'Santiago', region: 'Metropolitana' },
                { street: 'Santiago Airport - Avenida Armando Cortínez Oriente', number: '', commune: 'Pudahuel', region: 'Metropolitana' },
                { street: 'Santiago College - Camino Los Trapenses', number: '', commune: 'Lo Barnechea', region: 'Metropolitana' },
                { street: 'Providencia', number: '1234', commune: 'Providencia', region: 'Metropolitana' },
                { street: 'Las Condes', number: '567', commune: 'Las Condes', region: 'Metropolitana' },
                { street: 'Ñuñoa', number: '890', commune: 'Ñuñoa', region: 'Metropolitana' },
                { street: 'Maipú', number: '2345', commune: 'Maipú', region: 'Metropolitana' },
                { street: 'La Reina', number: '678', commune: 'La Reina', region: 'Metropolitana' },
                { street: 'Vitacura', number: '3456', commune: 'Vitacura', region: 'Metropolitana' },
                { street: 'San Miguel', number: '901', commune: 'San Miguel', region: 'Metropolitana' },
                { street: 'La Florida', number: '4567', commune: 'La Florida', region: 'Metropolitana' }
            ],
            'concepcion': [
                { street: 'Santiago Amengual', number: '123', commune: 'Concepción' },
                { street: 'Santiago Amengual', number: '456', commune: 'Concepción' },
                { street: 'Santiago Amengual', number: '789', commune: 'Concepción' },
                { street: 'Santiago Amengual', number: '321', commune: 'Concepción' },
                { street: 'Santiago Amengual', number: '654', commune: 'Concepción' },
                { street: 'Orompello', number: '456', commune: 'Concepción' },
                { street: 'Barros Arana', number: '789', commune: 'Concepción' },
                { street: 'Aníbal Pinto', number: '321', commune: 'Concepción' },
                { street: 'Cochrane', number: '654', commune: 'Concepción' },
                { street: 'Rengo', number: '987', commune: 'Concepción' },
                { street: 'Caupolicán', number: '147', commune: 'Concepción' },
                { street: 'San Martín', number: '258', commune: 'Concepción' }
            ],
            'valparaiso': [
                { street: 'Esmeralda', number: '123', commune: 'Valparaíso' },
                { street: 'Condell', number: '456', commune: 'Valparaíso' },
                { street: 'Pedro Montt', number: '789', commune: 'Valparaíso' },
                { street: 'Victoria', number: '321', commune: 'Valparaíso' },
                { street: 'Blanco', number: '654', commune: 'Valparaíso' },
                { street: 'Serrano', number: '987', commune: 'Valparaíso' }
            ],
            'vina-del-mar': [
                { street: 'Libertad', number: '123', commune: 'Viña del Mar' },
                { street: 'Quillota', number: '456', commune: 'Viña del Mar' },
                { street: 'Álvarez', number: '789', commune: 'Viña del Mar' },
                { street: 'Viana', number: '321', commune: 'Viña del Mar' },
                { street: 'San Martín', number: '654', commune: 'Viña del Mar' },
                { street: 'Arlegui', number: '987', commune: 'Viña del Mar' }
            ],
            'puerto-montt': [
                { street: 'Urmeneta', number: '123', commune: 'Puerto Montt' },
                { street: 'Rancagua', number: '456', commune: 'Puerto Montt' },
                { street: 'Lagos', number: '789', commune: 'Puerto Montt' },
                { street: 'O\'Higgins', number: '321', commune: 'Puerto Montt' },
                { street: 'Chacabuco', number: '654', commune: 'Puerto Montt' },
                { street: 'Pudeto', number: '987', commune: 'Puerto Montt' }
            ],
            'villarrica': [
                { street: 'Pedro de Valdivia', number: '123', commune: 'Villarrica' },
                { street: 'O\'Higgins', number: '456', commune: 'Villarrica' },
                { street: 'San Martín', number: '789', commune: 'Villarrica' },
                { street: 'Caupolicán', number: '321', commune: 'Villarrica' },
                { street: 'Lautaro', number: '654', commune: 'Villarrica' },
                { street: 'Manuel Rodríguez', number: '987', commune: 'Villarrica' }
            ],
            'nacimiento': [
                { street: 'O\'Higgins', number: '123', commune: 'Nacimiento' },
                { street: 'San Martín', number: '456', commune: 'Nacimiento' },
                { street: 'Caupolicán', number: '789', commune: 'Nacimiento' },
                { street: 'Lautaro', number: '321', commune: 'Nacimiento' },
                { street: 'Manuel Rodríguez', number: '654', commune: 'Nacimiento' },
                { street: 'Pedro de Valdivia', number: '987', commune: 'Nacimiento' }
            ]
        };

        // Variables globales para el menú desplegable
        let currentSuggestions = [];
        let selectedSuggestionIndex = -1;

        // Función para buscar dirección y mostrar sugerencias
        function searchAddress() {
            const addressInput = document.getElementById('address-input');
            
            if (!addressInput) return;
            
            const addressValue = addressInput.value.trim();
            
            if (addressValue.length >= 2) { // Mínimo 2 caracteres para mostrar sugerencias
                // Buscar sugerencias en la base de datos
                const suggestions = findAddressSuggestions(addressValue);
                
                if (suggestions.length > 0) {
                    showSuggestions(suggestions);
                } else {
                    hideSuggestions();
                }
            } else {
                hideSuggestions();
            }
        }

        // Función para buscar direcciones en el campo inicial
        function searchInitialAddress() {
            const initialAddressInput = document.getElementById('initial-address-input');
            
            if (!initialAddressInput) return;
            
            const addressValue = initialAddressInput.value.trim();
            
            if (addressValue.length >= 2) { // Mínimo 2 caracteres para mostrar sugerencias
                // Buscar sugerencias en la base de datos
                const suggestions = findAddressSuggestions(addressValue);
                
                if (suggestions.length > 0) {
                    showInitialSuggestions(suggestions);
                } else {
                    hideSuggestions();
                }
            } else {
                hideSuggestions();
            }
        }

        // Función para buscar sugerencias de direcciones
        function findAddressSuggestions(query) {
            const suggestions = [];
            const queryLower = query.toLowerCase();
            
            for (const [city, addresses] of Object.entries(addressDatabase)) {
                for (const address of addresses) {
                    const fullAddress = address.number ? 
                        `${address.street} ${address.number}, ${address.commune}, Chile` : 
                        `${address.street}, ${address.commune}, Chile`;
                    const streetOnly = address.street;
                    const region = address.region || getRegionByCity(city);
                    
                    // Buscar coincidencias
                    if (fullAddress.toLowerCase().includes(queryLower) || 
                        streetOnly.toLowerCase().includes(queryLower)) {
                        suggestions.push({
                            ...address,
                            region: region,
                            fullAddress: fullAddress
                        });
                    }
                }
            }
            
            // Limitar a exactamente 5 sugerencias máximo
            console.log('Sugerencias encontradas:', suggestions.length);
            return suggestions.slice(0, 5);
        }

        // Función para mostrar sugerencias
        function showSuggestions(suggestions) {
            const suggestionsDropdown = document.getElementById('address-suggestions');
            const suggestionsList = document.getElementById('suggestions-list');
            
            if (!suggestionsDropdown || !suggestionsList) return;
            
            currentSuggestions = suggestions;
            selectedSuggestionIndex = -1;
            
            // Generar HTML de sugerencias
            suggestionsList.innerHTML = suggestions.map((suggestion, index) => `
                <div class="suggestion-item" data-index="${index}">
                    <div class="suggestion-content">
                        <div class="suggestion-text">${highlightMatch(suggestion.fullAddress, document.getElementById('address-input').value)}</div>
                    </div>
                </div>
            `).join('');
            
            // Mostrar dropdown
            console.log('Mostrando dropdown de sugerencias');
            suggestionsDropdown.style.display = 'block';
            
            // Agregar event listeners a las sugerencias
            suggestionsList.querySelectorAll('.suggestion-item').forEach((item, index) => {
                item.addEventListener('click', () => selectSuggestion(index));
                item.addEventListener('mouseenter', () => setActiveSuggestion(index));
            });
        }

        // Función para mostrar sugerencias en el campo inicial
        function showInitialSuggestions(suggestions) {
            const suggestionsDropdown = document.getElementById('initial-address-suggestions');
            const suggestionsList = document.getElementById('initial-suggestions-list');
            
            if (!suggestionsDropdown || !suggestionsList) {
                console.log('Elementos no encontrados para mostrar sugerencias iniciales');
                return;
            }
            
            currentSuggestions = suggestions;
            selectedSuggestionIndex = -1;
            
            // Generar HTML de sugerencias
            suggestionsList.innerHTML = suggestions.map((suggestion, index) => `
                <div class="suggestion-item" data-index="${index}">
                    <div class="suggestion-content">
                        <div class="suggestion-text">${highlightMatch(suggestion.fullAddress, document.getElementById('initial-address-input').value)}</div>
                    </div>
                </div>
            `).join('');
            
            // Mostrar dropdown
            console.log('Mostrando dropdown de sugerencias iniciales:', suggestions.length, 'sugerencias');
            suggestionsDropdown.style.display = 'block';
            
            // Agregar event listeners a las sugerencias
            suggestionsList.querySelectorAll('.suggestion-item').forEach((item, index) => {
                item.addEventListener('click', () => selectInitialSuggestion(index));
                item.addEventListener('mouseenter', () => setActiveSuggestion(index));
            });
        }

        // Función para ocultar sugerencias
        function hideSuggestions() {
            const suggestionsDropdown = document.getElementById('address-suggestions');
            const initialSuggestionsDropdown = document.getElementById('initial-address-suggestions');
            
            if (suggestionsDropdown) {
                suggestionsDropdown.style.display = 'none';
            }
            if (initialSuggestionsDropdown) {
                initialSuggestionsDropdown.style.display = 'none';
            }
            currentSuggestions = [];
            selectedSuggestionIndex = -1;
        }

        // Función para seleccionar una sugerencia
        function selectSuggestion(index) {
            if (index >= 0 && index < currentSuggestions.length) {
                const suggestion = currentSuggestions[index];
                const addressInput = document.getElementById('address-input');
                const checkIcon = document.getElementById('address-check-icon');
                const selectedRegion = document.getElementById('selected-region');
                const selectedCommune = document.getElementById('selected-commune');
                
                // Llenar el input con la dirección seleccionada
                addressInput.value = suggestion.fullAddress;
                
                // Mostrar icono de check
                if (checkIcon) {
                    checkIcon.style.display = 'block';
                }
                
                // Actualizar región y comuna
                if (selectedRegion) {
                    selectedRegion.textContent = suggestion.region;
                }
                if (selectedCommune) {
                    selectedCommune.textContent = suggestion.commune;
                }
                
                // Ocultar sugerencias
                hideSuggestions();
                
                // Mostrar validación y mapa
                showAddressValidation(suggestion);
            }
        }

        // Función para seleccionar una sugerencia del campo inicial
        function selectInitialSuggestion(index) {
            if (index >= 0 && index < currentSuggestions.length) {
                const suggestion = currentSuggestions[index];
                const initialAddressInput = document.getElementById('initial-address-input');
                const modalContent = document.querySelector('.modal-content');
                
                // Expandir el modal para mostrar el formulario completo
                if (modalContent) {
                    modalContent.classList.add('expanded');
                }
                
                // Llenar el input con la dirección seleccionada
                initialAddressInput.value = suggestion.fullAddress;
                
                // Ocultar sugerencias
                hideSuggestions();
                
                // Mostrar el formulario completo de despacho a domicilio
                const addressContainer = document.getElementById('address-input-container');
                const initialAddressField = document.querySelector('.initial-address-field');
                const homeDelivery = document.getElementById('home-delivery');
                const storePickup = document.getElementById('store-pickup');
                
                // Asegurar que "Despacho a domicilio" esté seleccionado
                homeDelivery.classList.add('active');
                storePickup.classList.remove('active');
                
                // Actualizar subtítulo
                const modalSubtitle = document.getElementById('modal-subtitle');
                if (modalSubtitle) {
                    modalSubtitle.textContent = '¡Tú decide la opción que más te conviene!';
                }
                
                // Ocultar campo inicial y mostrar formulario completo
                initialAddressField.style.display = 'none';
                addressContainer.style.display = 'block';
                
                // Llenar el formulario completo con la dirección seleccionada
                const addressInput = document.getElementById('address-input');
                const checkIcon = document.getElementById('address-check-icon');
                const selectedRegion = document.getElementById('selected-region');
                const selectedCommune = document.getElementById('selected-commune');
                
                if (addressInput) {
                    addressInput.value = suggestion.fullAddress;
                }
                
                if (checkIcon) {
                    checkIcon.style.display = 'block';
                }
                
                if (selectedRegion) {
                    selectedRegion.textContent = suggestion.region;
                }
                if (selectedCommune) {
                    selectedCommune.textContent = suggestion.commune;
                }
                
                // Mostrar validación y mapa
                showAddressValidation(suggestion);
            }
        }

        // Función para establecer sugerencia activa
        function setActiveSuggestion(index) {
            const suggestionsList = document.getElementById('suggestions-list');
            if (suggestionsList) {
                suggestionsList.querySelectorAll('.suggestion-item').forEach((item, i) => {
                    item.classList.toggle('active', i === index);
                });
            }
            selectedSuggestionIndex = index;
        }

        // Función para resaltar coincidencias en el texto
        function highlightMatch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="suggestion-highlight">$1</span>');
        }

        // Función para mostrar validación de dirección
        function showAddressValidation(address) {
            const mapContainer = document.getElementById('map-container');
            
            if (mapContainer) mapContainer.style.display = 'block';
            
            // Inicializar el mapa si no existe
            if (!googleMap) {
                initializeMap();
            }
            
            // Actualizar el mapa con la nueva ubicación
            updateMapWithAddress(address);
        }

        // Función para actualizar el mapa con una dirección específica
        function updateMapWithAddress(address) {
            if (!googleMap || !checkGoogleMapsLoaded()) {
                initializeMap();
                return;
            }
            
            // Obtener coordenadas por comuna
            const coords = getCoordinatesByCommune(address.commune);
            
            // Actualizar la vista del mapa
            googleMap.setCenter({ lat: coords.lat, lng: coords.lng });
            googleMap.setZoom(16);
            
            // Limpiar marcador existente
            if (currentMarker) {
                currentMarker.setMap(null);
            }
            
            // Agregar nuevo marcador
            currentMarker = new google.maps.Marker({
                position: { lat: coords.lat, lng: coords.lng },
                map: googleMap,
                title: address.fullAddress
            });
            
            // Crear info window actualizada
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="text-align: center; padding: 10px;">
                        <strong>${address.fullAddress}</strong><br>
                        <span style="color: #10b981;">📍 ${address.commune}, ${address.region}</span><br>
                        <span style="color: #10b981;">✅ Zona de cobertura HuertoHogar</span>
                    </div>
                `
            });
            
            // Abrir info window
            infoWindow.open(googleMap, currentMarker);
        }

        // Función para buscar en la base de datos
        function findAddressInDatabase(addressInput) {
            const inputLower = addressInput.toLowerCase();
            
            for (const [city, addresses] of Object.entries(addressDatabase)) {
                for (const address of addresses) {
                    const fullAddress = `${address.street} ${address.number}`.toLowerCase();
                    const streetOnly = address.street.toLowerCase();
                    
                    // Buscar coincidencias en la dirección completa o solo en la calle
                    if (fullAddress.includes(inputLower) || 
                        streetOnly.includes(inputLower) ||
                        inputLower.includes(streetOnly)) {
                        return {
                            ...address,
                            region: getRegionByCity(city)
                        };
                    }
                }
            }
            return null;
        }

        // Función para obtener la región por ciudad
        function getRegionByCity(city) {
            const regions = {
                'santiago': 'Metropolitana',
                'concepcion': 'Bío Bío',
                'valparaiso': 'Valparaíso',
                'vina-del-mar': 'Valparaíso',
                'puerto-montt': 'Los Lagos',
                'villarrica': 'La Araucanía',
                'nacimiento': 'Bío Bío'
            };
            return regions[city] || 'Desconocida';
        }

        // Función para ocultar mapa y validación
        function hideMapAndValidation() {
            const mapContainer = document.getElementById('map-container');
            
            if (mapContainer) mapContainer.style.display = 'none';
            
            // También ocultar sugerencias
            hideSuggestions();
        }

        // Variable global para el mapa
        let addressMap;
        let addressMarker;

        // Función para mostrar mapa real con Leaflet
        function showSimulatedMap(streetName, streetNumber, commune = 'Concepción', region = 'Bío Bío') {
            const mapElement = document.getElementById('map');
            const fullAddress = `${streetName} ${streetNumber}, ${commune}, ${region}, Chile`;
            
            // Limpiar el mapa anterior si existe
            if (addressMap) {
                addressMap.remove();
            }
            
            try {
                // Verificar que Leaflet esté disponible
                if (typeof L === 'undefined') {
                    console.error('Leaflet no está disponible');
                    showMapError();
                    return;
                }

                // Coordenadas aproximadas basadas en la comuna
                const coordinates = getCoordinatesByCommune(commune);
                
                // Crear el mapa
                addressMap = L.map('map').setView([coordinates.lat, coordinates.lng], 15);

                // Agregar capa de OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 18
                }).addTo(addressMap);

                // Crear icono personalizado
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `
                        <div class="marker-circle">
                            <i class="fas fa-map-marker-alt" style="color: white; font-size: 18px;"></i>
                        </div>
                    `,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40],
                    popupAnchor: [0, -40]
                });

                // Crear marcador
                addressMarker = L.marker([coordinates.lat, coordinates.lng], { icon: customIcon }).addTo(addressMap);
                
                // Crear contenido del popup
                const popupContent = `
                    <div class="address-popup">
                        <h3 style="margin: 0 0 8px 0; color: #2E8B57; font-size: 16px;">${fullAddress}</h3>
                        <p style="margin: 0 0 5px 0; font-size: 14px; color: #666;">
                            <i class="fas fa-map-marker-alt" style="color: #2E8B57; margin-right: 5px;"></i>
                            ${commune}, ${region}
                        </p>
                        <p style="margin: 0; font-size: 12px; color: #4CAF50; font-weight: 500;">
                            <i class="fas fa-check-circle" style="margin-right: 5px;"></i>
                            Zona de cobertura HuertoHogar
                        </p>
                    </div>
                `;
                
                // Agregar popup al marcador
                addressMarker.bindPopup(popupContent, {
                    maxWidth: 250,
                    className: 'custom-popup'
                });

                // Abrir popup automáticamente
                addressMarker.openPopup();

                // Efecto hover en el marcador
                addressMarker.on('mouseover', function() {
                    this.getElement().querySelector('.marker-circle').style.transform = 'scale(1.1)';
                });
                
                addressMarker.on('mouseout', function() {
                    this.getElement().querySelector('.marker-circle').style.transform = 'scale(1)';
                });

                console.log('✅ Mapa real inicializado correctamente');
            } catch (error) {
                console.error('❌ Error al inicializar el mapa real:', error);
                showMapError();
            }
        }

        // Función para obtener coordenadas por comuna
        function getCoordinatesByCommune(commune) {
            const coordinates = {
                'Concepción': { lat: -36.8201, lng: -73.0444 },
                'San Miguel': { lat: -33.4489, lng: -70.6693 },
                'Providencia': { lat: -33.4170, lng: -70.6067 },
                'Las Condes': { lat: -33.4170, lng: -70.6067 },
                'Ñuñoa': { lat: -33.4569, lng: -70.6483 },
                'Maipú': { lat: -33.5117, lng: -70.7586 },
                'La Reina': { lat: -33.4569, lng: -70.6483 },
                'Vitacura': { lat: -33.4170, lng: -70.6067 },
                'La Florida': { lat: -33.5117, lng: -70.7586 },
                'Puerto Montt': { lat: -41.4718, lng: -72.9396 },
                'Villarrica': { lat: -39.2856, lng: -72.2273 },
                'Nacimiento': { lat: -37.5026, lng: -72.6731 },
                'Viña del Mar': { lat: -33.0245, lng: -71.5518 },
                'Valparaíso': { lat: -33.0472, lng: -71.6127 },
                'La Serena': { lat: -29.9045, lng: -71.2489 },
                'Antofagasta': { lat: -23.6345, lng: -70.3989 }
            };
            
            return coordinates[commune] || coordinates['Concepción'];
        }

        // Función para mostrar error del mapa
        function showMapError() {
            const mapElement = document.getElementById('map');
            mapElement.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; border-radius: 12px; padding: 2rem;">
                    <i class="fas fa-map-marked-alt" style="font-size: 3rem; color: #2E8B57; margin-bottom: 1rem;"></i>
                    <h3 style="margin: 0 0 0.5rem 0; color: #333; text-align: center;">Mapa no disponible</h3>
                    <p style="margin: 0; color: #666; text-align: center; line-height: 1.5;">
                        Estamos trabajando para mostrar la ubicación.<br>
                        La dirección ha sido validada correctamente.
                    </p>
                </div>
            `;
        }

        // Función para cargar direcciones desde localStorage
        function loadAddresses() {
            const addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
            const addressesList = document.getElementById('addresses-list');
            
            if (addresses.length === 0) {
                addressesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <h3>No tienes direcciones registradas</h3>
                        <p>Agrega una dirección para recibir tus pedidos en casa</p>
                    </div>
                `;
            } else {
                addressesList.innerHTML = addresses.map((address, index) => `
                    <div class="address-card ${address.isDefault ? 'default' : ''}">
                        <div class="address-header">
                            <span class="address-title">${address.title}</span>
                            ${address.isDefault ? '<span class="address-badge">Principal</span>' : ''}
                        </div>
                        <div class="address-details">
                            ${address.street} ${address.number}${address.apartment ? ', ' + address.apartment : ''}<br>
                            Concepción, Bío Bío
                        </div>
                        <div class="address-actions">
                            <button class="btn btn-outline btn-small" onclick="editAddress(${index})">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-outline btn-small" onclick="setDefaultAddress(${index})" ${address.isDefault ? 'disabled' : ''}>
                                <i class="fas fa-star"></i> ${address.isDefault ? 'Principal' : 'Hacer Principal'}
                            </button>
                            <button class="btn btn-outline btn-small" onclick="deleteAddress(${index})" style="color: #dc3545;">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Función para guardar nueva dirección
        function saveAddress(addressData) {
            const addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
            
            // Si es la primera dirección, marcarla como principal
            if (addresses.length === 0) {
                addressData.isDefault = true;
            }
            
            addresses.push(addressData);
            localStorage.setItem('userAddresses', JSON.stringify(addresses));
            
            // Recargar lista de direcciones
            loadAddresses();
            
            // Cerrar modal
            closeAddressModal();
            
            // Mostrar mensaje de éxito
            alert('Dirección agregada correctamente');
        }

        // Función para editar dirección
        function editAddress(index) {
            alert('Funcionalidad de editar dirección en desarrollo');
        }

        // Función para establecer dirección principal
        function setDefaultAddress(index) {
            const addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
            
            // Quitar principal de todas las direcciones
            addresses.forEach(addr => addr.isDefault = false);
            
            // Marcar la seleccionada como principal
            addresses[index].isDefault = true;
            
            localStorage.setItem('userAddresses', JSON.stringify(addresses));
            loadAddresses();
            
            alert('Dirección principal actualizada');
        }

        // Función para eliminar dirección
        function deleteAddress(index) {
            if (confirm('¿Estás seguro de que quieres eliminar esta dirección?')) {
                const addresses = JSON.parse(localStorage.getItem('userAddresses') || '[]');
                addresses.splice(index, 1);
                localStorage.setItem('userAddresses', JSON.stringify(addresses));
                loadAddresses();
                alert('Dirección eliminada correctamente');
            }
        }

        // Función para solicitar devolución
        function requestRefund() {
            const balance = document.querySelector('.balance-amount-input').value;
            if (balance === '0' || balance === '') {
                alert('No tienes saldo disponible para solicitar devolución.');
                return;
            }
            
            if (confirm(`¿Estás seguro de que quieres solicitar la devolución de $${balance}?`)) {
                alert('Tu solicitud de devolución ha sido enviada. Te contactaremos en las próximas 24 horas.');
            }
        }

        // Función para convertirse en PREMIUM
        function becomePremium() {
            if (confirm('¿Quieres convertirte en miembro PREMIUM de HuertoHogar? Disfrutarás de envíos gratis y muchos beneficios exclusivos.')) {
                alert('¡Excelente decisión! Te contactaremos pronto para completar tu membresía PREMIUM.');
            }
        }

        // Función para inicializar el calendario de fecha de nacimiento
        function initializeDatePicker() {
            const calendarIcon = document.getElementById('calendar-icon');
            const datePicker = document.getElementById('date-picker');
            const birthdateInput = document.getElementById('profile-birthdate');
            const currentMonthYear = document.getElementById('current-month-year');
            const calendarGrid = document.getElementById('calendar-grid');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const prevYearBtn = document.getElementById('prev-year');
            const nextYearBtn = document.getElementById('next-year');
            const yearSelector = document.getElementById('year-selector');
            const clearDateBtn = document.getElementById('clear-date');
            const closeCalendarBtn = document.getElementById('close-calendar');

            let currentDate = new Date();
            let selectedDate = null;

            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];

            const daysOfWeek = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];

            function formatDate(date) {
                if (!date) return '';
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }

            function populateYearSelector() {
                const currentYear = new Date().getFullYear();
                const startYear = currentYear - 100; // 100 años atrás
                const endYear = currentYear - 10; // 10 años atrás (edad mínima)
                
                yearSelector.innerHTML = '<option value="">Seleccionar año</option>';
                
                for (let year = endYear; year >= startYear; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelector.appendChild(option);
                }
            }

            function updateCalendar() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                currentMonthYear.textContent = `${months[month]} ${year}`;
                
                // Actualizar el selector de año
                yearSelector.value = year;
                
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                calendarGrid.innerHTML = '';
                
                // Días de la semana
                daysOfWeek.forEach(day => {
                    const dayHeader = document.createElement('div');
                    dayHeader.textContent = day;
                    dayHeader.style.fontWeight = 'bold';
                    dayHeader.style.color = '#666';
                    dayHeader.style.padding = '6px';
                    dayHeader.style.fontSize = '11px';
                    calendarGrid.appendChild(dayHeader);
                });
                
                // Días del mes
                for (let i = 0; i < 42; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    
                    const dayElement = document.createElement('div');
                    dayElement.textContent = date.getDate();
                    dayElement.className = 'calendar-day';
                    
                    if (date.getMonth() !== month) {
                        dayElement.classList.add('other-month');
                    }
                    
                    // Marcar día actual
                    const today = new Date();
                    if (date.toDateString() === today.toDateString()) {
                        dayElement.classList.add('today');
                    }
                    
                    if (selectedDate && date.toDateString() === selectedDate.toDateString()) {
                        dayElement.classList.add('selected');
                    }
                    
                    dayElement.addEventListener('click', () => {
                        if (date.getMonth() === month) {
                            selectedDate = new Date(date);
                            birthdateInput.value = formatDate(selectedDate);
                            updateCalendar();
                            datePicker.style.display = 'none';
                        }
                    });
                    
                    calendarGrid.appendChild(dayElement);
                }
            }

            // Event listeners
            calendarIcon.addEventListener('click', () => {
                datePicker.style.display = datePicker.style.display === 'none' ? 'block' : 'none';
                if (datePicker.style.display === 'block') {
                    populateYearSelector();
                    updateCalendar();
                }
            });

            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateCalendar();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateCalendar();
            });

            prevYearBtn.addEventListener('click', () => {
                currentDate.setFullYear(currentDate.getFullYear() - 1);
                updateCalendar();
            });

            nextYearBtn.addEventListener('click', () => {
                currentDate.setFullYear(currentDate.getFullYear() + 1);
                updateCalendar();
            });

            yearSelector.addEventListener('change', () => {
                if (yearSelector.value) {
                    currentDate.setFullYear(parseInt(yearSelector.value));
                    updateCalendar();
                }
            });

            clearDateBtn.addEventListener('click', () => {
                selectedDate = null;
                birthdateInput.value = '';
                updateCalendar();
            });

            closeCalendarBtn.addEventListener('click', () => {
                datePicker.style.display = 'none';
            });

            // Cerrar calendario al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!datePicker.contains(e.target) && !calendarIcon.contains(e.target)) {
                    datePicker.style.display = 'none';
                }
            });

            // Cargar fecha existente si existe
            if (birthdateInput.value) {
                const dateParts = birthdateInput.value.split('/');
                if (dateParts.length === 3) {
                    selectedDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                    currentDate = new Date(selectedDate);
                }
            }
        }

        // Función para validar RUT chileno
        function validateRut(rut) {
            if (!rut || typeof rut !== 'string') return false;
            
            // Limpiar RUT (quitar puntos y guiones)
            const cleanRut = rut.replace(/[.-]/g, '').trim();
            
            // Verificar que no esté vacío
            if (cleanRut.length === 0) return false;
            
            // Verificar formato básico (7-8 dígitos + dígito verificador)
            if (!/^\d{7,8}[\dkK]$/i.test(cleanRut)) return false;
            
            const rutDigits = cleanRut.slice(0, -1);
            const checkDigit = cleanRut.slice(-1).toUpperCase();
            
            // Verificar que los dígitos no sean todos iguales (RUTs inválidos como 1111111-1)
            if (/^(\d)\1+$/.test(rutDigits)) return false;
            
            // Algoritmo de validación RUT
            let sum = 0;
            let multiplier = 2;
            
            for (let i = rutDigits.length - 1; i >= 0; i--) {
                sum += parseInt(rutDigits[i]) * multiplier;
                multiplier = multiplier === 7 ? 2 : multiplier + 1;
            }
            
            const remainder = sum % 11;
            const calculatedCheckDigit = remainder === 0 ? '0' : remainder === 1 ? 'K' : (11 - remainder).toString();
            
            console.log('RUT digits:', rutDigits, 'Check digit:', checkDigit, 'Calculated:', calculatedCheckDigit);
            
            return checkDigit === calculatedCheckDigit;
        }

        // Función de prueba para validar RUTs conocidos
        function testRutValidation() {
            const testRuts = [
                '12345678-9', // RUT de prueba
                '11111111-1', // RUT inválido (dígitos repetidos)
                '1234567-8',  // RUT de 7 dígitos
                '12345678-K', // RUT con K
                '12345678-0', // RUT inválido
            ];
            
            console.log('=== Pruebas de validación RUT ===');
            testRuts.forEach(rut => {
                const isValid = validateRut(rut);
                console.log(`${rut}: ${isValid ? 'VÁLIDO' : 'INVÁLIDO'}`);
            });
        }

        // Función para validar teléfono chileno
        function validateChileanPhone(phone) {
            if (!phone || typeof phone !== 'string') return false;
            
            // Limpiar el teléfono (solo números)
            const cleanPhone = phone.replace(/\D/g, '');
            
            // Verificar que tenga 9 dígitos (incluyendo el 9 inicial)
            if (cleanPhone.length !== 9) return false;
            
            // Verificar que no sean todos iguales
            if (/^(\d)\1+$/.test(cleanPhone)) return false;
            
            // Verificar que empiece con 9 (celular chileno)
            return cleanPhone.startsWith('9');
        }

        // Función para formatear teléfono chileno
        function formatChileanPhone(phone) {
            // Limpiar el teléfono (solo números)
            const cleanPhone = phone.replace(/\D/g, '');
            
            if (cleanPhone.length === 0) return '';
            
            // Si tiene más de 9 dígitos, truncar
            const digits = cleanPhone.slice(0, 9);
            
            // Formatear con espacio después del 9
            if (digits.length <= 1) {
                return digits;
            } else if (digits.length <= 5) {
                return digits.slice(0, 1) + ' ' + digits.slice(1);
            } else {
                return digits.slice(0, 1) + ' ' + digits.slice(1, 5) + ' ' + digits.slice(5);
            }
        }

        // Función para formatear RUT automáticamente
        function formatRut(rut) {
            // Limpiar el RUT (quitar todo excepto números y K)
            const cleanRut = rut.replace(/[^0-9kK]/g, '');
            
            if (cleanRut.length === 0) return '';
            
            // Si tiene más de 8 dígitos, truncar
            const digits = cleanRut.slice(0, 8);
            const checkDigit = cleanRut.slice(8, 9);
            
            // Formatear con puntos y guión
            if (digits.length <= 3) {
                return digits;
            } else if (digits.length <= 6) {
                return digits.slice(0, -3) + '.' + digits.slice(-3);
            } else {
                const formatted = digits.slice(0, -6) + '.' + digits.slice(-6, -3) + '.' + digits.slice(-3);
                return checkDigit ? formatted + '-' + checkDigit : formatted;
            }
        }

        // Función para calcular la posición correcta del cursor después del formateo
        function calculateCursorPosition(originalValue, formattedValue, originalCursorPos) {
            // Contar solo dígitos y K antes de la posición original del cursor
            const beforeCursor = originalValue.substring(0, originalCursorPos);
            const digitCount = (beforeCursor.match(/[0-9kK]/g) || []).length;
            
            // Encontrar la posición en el valor formateado donde tenemos la misma cantidad de dígitos
            let newPos = 0;
            let digitCountInFormatted = 0;
            
            for (let i = 0; i < formattedValue.length; i++) {
                if (/[0-9kK]/.test(formattedValue[i])) {
                    digitCountInFormatted++;
                    if (digitCountInFormatted === digitCount) {
                        newPos = i + 1;
                        break;
                    }
                }
            }
            
            return Math.min(newPos, formattedValue.length);
        }

        // Función para inicializar validación de RUT
        function initializeRutValidation() {
            const rutInput = document.getElementById('profile-rut');
            const rutCheckmark = document.getElementById('rut-checkmark');
            const rutContainer = rutInput ? rutInput.closest('.rut-input-container') : null;
            
            if (rutInput && rutCheckmark && rutContainer) {
                // Función para actualizar el estado visual
                function updateRutValidation(rut) {
                    console.log('Validando RUT:', rut);
                    
                    // Limpiar clases anteriores
                    rutCheckmark.classList.remove('valid', 'invalid');
                    rutContainer.classList.remove('valid', 'invalid');
                    
                    if (rut === '') {
                        // Campo vacío - ocultar indicador
                        rutCheckmark.style.display = 'none';
                        console.log('Campo vacío - ocultando indicador');
                    } else {
                        const isValid = validateRut(rut);
                        console.log('RUT válido:', isValid);
                        
                        if (isValid) {
                            // RUT válido - mostrar checkmark verde
                            rutCheckmark.classList.add('valid');
                            rutCheckmark.textContent = '✓';
                            rutCheckmark.style.display = 'flex';
                            rutContainer.classList.add('valid');
                            console.log('Mostrando checkmark verde');
                        } else {
                            // RUT inválido - mostrar X roja
                            rutCheckmark.classList.add('invalid');
                            rutCheckmark.textContent = '✕';
                            rutCheckmark.style.display = 'flex';
                            rutContainer.classList.add('invalid');
                            console.log('Mostrando X roja');
                        }
                    }
                }
                
                // Evento de entrada con formateo automático mejorado
                rutInput.addEventListener('input', function() {
                    const originalValue = this.value;
                    const originalCursorPos = this.selectionStart;
                    const formattedRut = formatRut(originalValue);
                    
                    // Solo actualizar si el valor cambió
                    if (formattedRut !== originalValue) {
                        this.value = formattedRut;
                        
                        // Calcular nueva posición del cursor
                        const newCursorPos = calculateCursorPosition(originalValue, formattedRut, originalCursorPos);
                        
                        // Restaurar posición del cursor usando requestAnimationFrame para mejor rendimiento
                        requestAnimationFrame(() => {
                            this.setSelectionRange(newCursorPos, newCursorPos);
                        });
                    }
                    
                    updateRutValidation(formattedRut);
                });
                
                // Evento de pérdida de foco para validación final
                rutInput.addEventListener('blur', function() {
                    const rut = this.value.trim();
                    updateRutValidation(rut);
                });
                
                // Evento de tecla Enter para validación
                rutInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const rut = this.value.trim();
                        updateRutValidation(rut);
                    }
                });
                
                // Validar RUT inicial si ya tiene valor
                if (rutInput.value.trim() !== '') {
                    const rut = rutInput.value.trim();
                    updateRutValidation(rut);
                }
                
                // Ejecutar pruebas de validación (solo para depuración)
                testRutValidation();
            }
        }

        // Función para inicializar validación de teléfono
        function initializePhoneValidation() {
            const phoneInput = document.getElementById('profile-phone');
            const phoneContainer = phoneInput ? phoneInput.closest('.phone-input-container') : null;
            const phoneCheckmark = document.getElementById('phone-checkmark');
            
            if (phoneInput && phoneContainer && phoneCheckmark) {
                // Función para actualizar el estado visual del teléfono
                function updatePhoneValidation(phone) {
                    console.log('Validando teléfono:', phone);
                    
                    // Limpiar clases anteriores
                    phoneContainer.classList.remove('valid', 'invalid');
                    phoneCheckmark.classList.remove('valid', 'invalid');
                    
                    if (phone === '') {
                        // Campo vacío - ocultar indicador
                        phoneCheckmark.style.display = 'none';
                        console.log('Campo vacío - ocultando indicador');
                    } else {
                        const isValid = validateChileanPhone(phone);
                        console.log('Teléfono válido:', isValid);
                        
                        if (isValid) {
                            // Teléfono válido - mostrar checkmark verde
                            phoneContainer.classList.add('valid');
                            phoneCheckmark.classList.add('valid');
                            phoneCheckmark.textContent = '✓';
                            phoneCheckmark.style.display = 'flex';
                            console.log('Mostrando checkmark verde');
                        } else {
                            // Teléfono inválido - mostrar X roja
                            phoneContainer.classList.add('invalid');
                            phoneCheckmark.classList.add('invalid');
                            phoneCheckmark.textContent = '✕';
                            phoneCheckmark.style.display = 'flex';
                            console.log('Mostrando X roja');
                        }
                    }
                }
                
                // Evento de entrada con formateo automático
                phoneInput.addEventListener('input', function() {
                    const originalValue = this.value;
                    const formattedPhone = formatChileanPhone(originalValue);
                    
                    // Solo actualizar si el valor cambió
                    if (formattedPhone !== originalValue) {
                        this.value = formattedPhone;
                    }
                    
                    updatePhoneValidation(formattedPhone);
                });
                
                // Evento de pérdida de foco para validación final
                phoneInput.addEventListener('blur', function() {
                    const phone = this.value.trim();
                    updatePhoneValidation(phone);
                });
                
                // Validar teléfono inicial si ya tiene valor
                if (phoneInput.value.trim() !== '') {
                    const phone = phoneInput.value.trim();
                    updatePhoneValidation(phone);
                }
            }
        }

        // Manejo del formulario de perfil
        function initializeProfileForm() {
            const profileForm = document.getElementById('profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Obtener usuario actual desde la sesión
                    const session = JSON.parse(localStorage.getItem('huerto_session') || 'null');
                    const users = JSON.parse(localStorage.getItem('huerto_users') || '[]');
                    const userIndex = users.findIndex(u => u.id === session.userId);
                    
                    if (userIndex === -1) {
                        showAlert(feedback, 'Usuario no encontrado', 'warning');
                        return;
                    }
                    
                    const user = users[userIndex];
                    
                    // Actualizar datos del usuario
                    const firstName = document.getElementById('profile-name').value;
                    const lastName = document.getElementById('profile-lastname').value;
                    user.nombre = `${firstName} ${lastName}`.trim();
                    
                    // Actualizar displayName usando la función de auth.js
                    if (window.HuertoAuth && window.HuertoAuth.extractDisplayName) {
                        user.displayName = window.HuertoAuth.extractDisplayName(user.nombre);
                    }
                    
                    user.telefono = '+56 ' + document.getElementById('profile-phone').value;
                    user.rut = document.getElementById('profile-rut').value;
                    user.birthdate = document.getElementById('profile-birthdate').value;
                    user.adults = document.getElementById('adults').value;
                    user.children = document.getElementById('children').value;
                    
                    // Guardar preferencias de dieta
                    const dietCheckboxes = document.querySelectorAll('input[name="diet"]:checked');
                    user.diet = Array.from(dietCheckboxes).map(cb => cb.value);
                    
                    // Actualizar usuario en el array
                    users[userIndex] = user;
                    
                    // Guardar en localStorage
                    localStorage.setItem('huerto_users', JSON.stringify(users));
                    
                    // Mostrar mensaje de éxito
                    const feedback = document.getElementById('profile-feedback');
                    if (feedback) {
                        feedback.innerHTML = '<div class="success-message" style="color: #2E8B57; font-weight: 600; margin-top: 1rem;">✓ Datos guardados correctamente</div>';
                        setTimeout(() => {
                            feedback.innerHTML = '';
                        }, 3000);
                    }
                    
                    // Actualizar datos en sidebar y header
                    loadUserData();
                });
            }

            // Inicializar calendario para fecha de nacimiento
            initializeDatePicker();
            
            // Inicializar validación de RUT
            initializeRutValidation();
            
            // Inicializar validación de teléfono
            initializePhoneValidation();

            // Manejo del formulario de direcciones
            const addressForm = document.getElementById('address-form');
            if (addressForm) {
                addressForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const addressInput = document.getElementById('address-input').value.trim();
                    
                    if (addressInput) {
                        // Buscar la dirección en la base de datos para obtener los datos completos
                        const foundAddress = findAddressInDatabase(addressInput);
                        
                        if (foundAddress) {
                            const addressData = {
                                title: `${foundAddress.street} ${foundAddress.number}`,
                                street: foundAddress.street,
                                number: foundAddress.number,
                                commune: foundAddress.commune,
                                region: foundAddress.region,
                                isDefault: false
                            };
                            
                            saveAddress(addressData);
                        } else {
                            // Si no se encuentra en la base de datos, usar la dirección tal como está
                            const addressData = {
                                title: addressInput,
                                street: addressInput,
                                number: '',
                                commune: 'Concepción',
                                region: 'Bío Bío',
                                isDefault: false
                            };
                            
                            saveAddress(addressData);
                        }
                    }
                });
            }

            // Event listeners para búsqueda de direcciones
            const addressInput = document.getElementById('address-input');
            const initialAddressInput = document.getElementById('initial-address-input');
            
            if (addressInput) {
                addressInput.addEventListener('input', function() {
                    console.log('Address changed:', this.value);
                    searchAddress();
                });

                // Navegación con teclado
                addressInput.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (currentSuggestions.length > 0) {
                            selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, currentSuggestions.length - 1);
                            setActiveSuggestion(selectedSuggestionIndex);
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (currentSuggestions.length > 0) {
                            selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                            setActiveSuggestion(selectedSuggestionIndex);
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < currentSuggestions.length) {
                            selectSuggestion(selectedSuggestionIndex);
                        }
                    } else if (e.key === 'Escape') {
                        hideSuggestions();
                    }
                });
            } else {
                console.log('Address input not found');
            }
            
            if (initialAddressInput) {
                initialAddressInput.addEventListener('input', function() {
                    console.log('Initial address changed:', this.value);
                    searchInitialAddress();
                });

                // Navegación con teclado para el campo inicial
                initialAddressInput.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (currentSuggestions.length > 0) {
                            selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, currentSuggestions.length - 1);
                            setActiveSuggestion(selectedSuggestionIndex);
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (currentSuggestions.length > 0) {
                            selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                            setActiveSuggestion(selectedSuggestionIndex);
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < currentSuggestions.length) {
                            selectInitialSuggestion(selectedSuggestionIndex);
                        }
                    } else if (e.key === 'Escape') {
                        hideSuggestions();
                    }
                });
            }

            // Ocultar sugerencias al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.input-with-validation') && !e.target.closest('.initial-address-field')) {
                    hideSuggestions();
                }
            });

            // Event listeners para el carrusel de tiendas
            const carouselPrev = document.getElementById('carousel-prev');
            const carouselNext = document.getElementById('carousel-next');
            const viewHoursBtn = document.getElementById('view-hours-btn');
            
            if (carouselPrev) {
                carouselPrev.addEventListener('click', prevStore);
            }
            
            if (carouselNext) {
                carouselNext.addEventListener('click', nextStore);
            }
            
            if (viewHoursBtn) {
                viewHoursBtn.addEventListener('click', function() {
                    if (selectedStore) {
                        alert(`Horarios de ${selectedStore.name}:\n${selectedStore.hours}`);
                    }
                });
            }

            // Cargar direcciones al cargar la página
            loadAddresses();
        }

        // Inicialización principal
        document.addEventListener('DOMContentLoaded', function() {
            // Esperar a que auth.js se cargue completamente
            setTimeout(() => {
                // Cargar datos del usuario primero
                loadUserData();
                
                // Inicializar formulario de perfil
                initializeProfileForm();
                
                // Inicializar botones continuar
                handleContinueButton();
                
                // Inicializar controles del carrusel de tienda
                initializeStoreCarouselControls();
                
                // Inicializar sistema de horarios automático
                startStoreStatusUpdater();
                
                // Inicializar sidebar después de que todo esté cargado
                setTimeout(() => {
                    initializeSidebar();
                    // Inicializar el mapa por defecto
                    initializeMap();
                }, 100);
            }, 200);
        });

        // Variables globales para Google Maps
        let googleMap = null;
        let currentMarker = null;
        let googleMapsLoaded = false;

        // Función para verificar si Google Maps está cargado
        function checkGoogleMapsLoaded() {
            if (window.googleMapsLoaded && typeof google !== 'undefined' && google.maps && google.maps.Map) {
                console.log('Google Maps API cargada correctamente');
                return true;
            }
            return false;
        }

        // Función de callback para cuando Google Maps se carga
        function initMap() {
            console.log('Google Maps API cargada correctamente');
            window.googleMapsLoaded = true;
        }

        // Función para inicializar el mapa
        function initializeMap() {
            const mapContainer = document.getElementById('map-container');
            const mapElement = document.getElementById('map');
            const mapFallback = document.getElementById('map-fallback');
            
            if (!mapContainer || !mapElement) {
                console.log('Map container or element not found');
                return;
            }
            
            // Asegurar que el contenedor sea visible
            mapContainer.style.display = 'block';
            
            // Verificar si Google Maps está cargado
            if (!checkGoogleMapsLoaded()) {
                console.log('Google Maps no está disponible, mostrando mapa de respaldo');
                if (mapFallback) {
                    mapElement.style.display = 'none';
                    mapFallback.style.display = 'flex';
                }
                return;
            }
            
            // Coordenadas de Santiago como ejemplo (más común)
            const lat = -33.4489;
            const lng = -70.6693;
            
            try {
                // Crear el mapa de Google
                googleMap = new google.maps.Map(mapElement, {
                    center: { lat: lat, lng: lng },
                    zoom: 16,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    styles: [
                        {
                            featureType: "poi",
                            elementType: "labels",
                            stylers: [{ visibility: "on" }]
                        }
                    ]
                });
                
                // Agregar marcador
                currentMarker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: googleMap,
                    title: 'Santiago Amengual, Concepción, Biobío, Chile'
                });
                
                // Crear info window
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="text-align: center; padding: 10px;">
                            <strong>Santiago Amengual, Concepción, Biobío, Chile</strong><br>
                            <span style="color: #10b981;">📍 Concepción, Biobío</span><br>
                            <span style="color: #10b981;">✅ Zona de cobertura HuertoHogar</span>
                        </div>
                    `
                });
                
                // Abrir info window
                infoWindow.open(googleMap, currentMarker);
                
                console.log('Google Maps inicializado correctamente');
            } catch (error) {
                console.error('Error al inicializar Google Maps:', error);
                // Mostrar mapa de respaldo
                if (mapFallback) {
                    mapElement.style.display = 'none';
                    mapFallback.style.display = 'flex';
                }
            }
        }
    </script>
</body>
</html>

