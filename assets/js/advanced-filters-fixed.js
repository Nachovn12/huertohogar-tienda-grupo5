// Filtros avanzados para la p√°gina de productos - VERSI√ìN CORREGIDA
document.addEventListener('DOMContentLoaded', function() {
    console.log('Script avanzado cargado');
    
    // Elementos del DOM
    const quickFilters = document.querySelectorAll('.elegant-filter-btn');
    const viewButtons = document.querySelectorAll('.view-btn');
    const productGrid = document.getElementById('product-list-full');
    const productsCount = document.getElementById('products-count');
    const productsTotal = document.getElementById('products-total');
    
    // Estado de los filtros
    let currentFilters = {
        category: '',
        view: 'grid'
    };
    
    // Productos seg√∫n la r√∫brica del proyecto - Ordenados alfab√©ticamente
    const allProducts = [
        { 
            id: 'VR002', 
            name: 'Espinacas Frescas', 
            category: 'Verduras Org√°nicas', 
            price: 700, 
            stock: 'in-stock', 
            seasonal: false, 
            popular: true,
            unit: 'por bolsa de 500g',
            origin: 'Regi√≥n de O\'Higgins',
            description: 'Espinacas frescas y nutritivas, perfectas para ensaladas y batidos verdes. Cultivadas bajo pr√°cticas org√°nicas que garantizan su calidad y valor nutricional.',
            image: 'https://pngimg.com/uploads/spinach/spinach_PNG45.png',
            detailUrl: 'producto/espinacas-frescas.html'
        },
        { 
            id: 'FR001', 
            name: 'Manzanas Fuji', 
            category: 'Frutas Frescas', 
            price: 1200, 
            stock: 'in-stock', 
            seasonal: false, 
            popular: true,
            unit: 'por kilo',
            origin: 'Regi√≥n del Maule',
            description: 'Manzanas Fuji crujientes y dulces, perfectas para comer frescas o en postres.',
            image: 'https://santaisabel.vtexassets.com/arquivos/ids/174684-900-900?width=900&height=900&aspect=true',
            detailUrl: 'producto/manzanas-fuji.html'
        },
        { 
            id: 'OR001', 
            name: 'Miel Org√°nica', 
            category: 'Productos Org√°nicos', 
            price: 5000, 
            stock: 'in-stock', 
            seasonal: false, 
            popular: true,
            unit: 'por frasco de 500g',
            origin: 'Regi√≥n de Los Lagos',
            description: 'Miel org√°nica pura de abejas, endulzante natural perfecto para tu mesa.',
            image: 'https://png.pngtree.com/png-clipart/20240720/original/pngtree-family-apiary-organic-honey-food-production-png-image_15597696.png',
            detailUrl: 'producto/miel-organica.html'
        },
        { 
            id: 'FR002', 
            name: 'Naranjas Valencia', 
            category: 'Frutas Frescas', 
            price: 1000, 
            stock: 'in-stock', 
            seasonal: true, 
            popular: false,
            unit: 'por kilo',
            origin: 'Regi√≥n de Valpara√≠so',
            description: 'Naranjas Valencia jugosas y ricas en vitamina C, ideales para jugos naturales.',
            image: 'https://static.vecteezy.com/system/resources/previews/022/825/544/non_2x/orange-fruit-orange-on-transparent-background-free-png.png',
            detailUrl: 'producto/naranjas-valencia.html'
        },
        { 
            id: 'VR001', 
            name: 'Pimientos Tricolores', 
            category: 'Verduras Org√°nicas', 
            price: 1500, 
            stock: 'in-stock', 
            seasonal: true, 
            popular: false,
            unit: 'por kilo',
            origin: 'Regi√≥n Metropolitana',
            description: 'Pimientos rojos, amarillos y verdes, perfectos para ensaladas y guisos.',
            image: 'https://png.pngtree.com/png-vector/20241212/ourmid/pngtree-colored-paprica-raw-paprika-fruit-png-image_14613829.png',
            detailUrl: 'producto/pimientos-tricolores.html'
        },
        { 
            id: 'FR003', 
            name: 'Pl√°tanos Cavendish', 
            category: 'Frutas Frescas', 
            price: 800, 
            stock: 'in-stock', 
            seasonal: false, 
            popular: true,
            unit: 'por kilo',
            origin: 'Regi√≥n de Coquimbo',
            description: 'Pl√°tanos Cavendish dulces y cremosos, perfectos para el desayuno.',
            image: 'https://png.pngtree.com/png-vector/20240128/ourmid/pngtree-ripe-cavendish-banana-png-image_11508971.png',
            detailUrl: 'producto/platanos-cavendish.html'
        },
        { 
            id: 'OR002', 
            name: 'Quinua Org√°nica', 
            category: 'Productos Org√°nicos', 
            price: 3000, 
            stock: 'in-stock', 
            seasonal: false, 
            popular: true,
            unit: 'por paquete de 400g',
            origin: 'Regi√≥n de Arica y Parinacota',
            description: 'Quinua org√°nica, superalimento rico en prote√≠nas y nutrientes.',
            image: 'https://manare.cl/wp-content/uploads/2023/09/Manare_QuinoaOrganica400g.png',
            detailUrl: 'producto/quinua-organica.html'
        },
        { 
            id: 'LA001', 
            name: 'Leche Entera', 
            category: 'Productos L√°cteos', 
            price: 1200, 
            stock: 'in-stock', 
            seasonal: false, 
            popular: true,
            unit: 'por litro',
            origin: 'Producci√≥n local',
            description: 'Leche entera fresca y nutritiva, ideal para el desayuno y la preparaci√≥n de diversos platos.',
            image: 'https://www.soprole.cl/public/storage/imagenes/banners/202304180943Soprole-Lecheentera-litro.png',
            detailUrl: 'producto/leche-entera.html'
        },
        { 
            id: 'VR003', 
            name: 'Zanahorias Org√°nicas', 
            category: 'Verduras Org√°nicas', 
            price: 900, 
            stock: 'in-stock', 
            seasonal: true, 
            popular: false,
            unit: 'por kilo',
            origin: 'Regi√≥n de O\'Higgins',
            description: 'Zanahorias org√°nicas crujientes y dulces, ricas en betacaroteno y vitamina A.',
            image: 'https://png.pngtree.com/png-vector/20241225/ourmid/pngtree-fresh-organic-carrots-in-a-neat-stack-png-image_14812590.png',
            detailUrl: 'producto/zanahorias-organicas.html'
        }
    ];

    // Funci√≥n para renderizar productos
    function renderProducts(products) {
        if (!productGrid) {
            console.error('Product grid not found');
            return;
        }

        if (products.length === 0) {
            productGrid.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search"></i>
                    <h3>No se encontraron productos</h3>
                    <p>Intenta ajustar los filtros para ver m√°s resultados</p>
                </div>
            `;
            return;
        }

        productGrid.innerHTML = products.map(product => createProductCard(product)).join('');
        
        // Asegurar que las im√°genes se carguen correctamente
        const images = productGrid.querySelectorAll('img');
        images.forEach(img => {
            img.addEventListener('load', function() {
                this.classList.add('loaded');
                this.style.opacity = '1';
            });
            img.addEventListener('error', function() {
                console.error('Error cargando imagen:', this.src);
                this.style.display = 'none';
            });
        });
        
        // Aplicar estilos seg√∫n la vista actual
        if (currentFilters.view === 'list') {
            applyListViewStyles();
        } else {
            applyGridViewStyles();
        }
        
        // Actualizar contador de productos
        updateResultsInfo(products.length);
    }

    // Funci√≥n para crear tarjeta de producto
    function createProductCard(product) {
        const offerPrice = getOfferPrice(product.id);
        const originalPrice = getOriginalPrice(product.id);
        const isOnOffer = isProductOnOffer(product.id);
        
        const discountPercentage = isOnOffer ? Math.round((1 - offerPrice / originalPrice) * 100) : 0;
        
        return `
            <div class="product-card" data-category="${product.category}">
                <div class="product-badges">
                    ${!isOnOffer && product.seasonal ? '<div class="season-badge">Temporada</div>' : ''}
                    ${!isOnOffer && product.popular ? '<div class="new-badge">Popular</div>' : ''}
                    ${isOnOffer ? `<div class="offer-badge">üî• ${discountPercentage}% OFF</div>` : ''}
                </div>
                <img src="${product.image}" alt="${product.name}" loading="lazy" style="width: 100%; height: 200px; object-fit: contain; object-position: center; display: block; opacity: 1;">
                <div class="product-info">
                    <h4>${product.name}</h4>
                    <p class="product-category">${product.category}</p>
                    <p class="product-origin">üå± ${product.origin}</p>
                    <div class="product-rating">
                        <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</div>
                        <span class="rating-text">(4.2) ¬∑ 47 rese√±as</span>
                    </div>
                    <div class="product-pricing">
                        <span class="price ${isOnOffer ? 'has-offer' : ''}">${formatPrice(offerPrice || product.price)}</span>
                        <span class="product-unit">${product.unit || 'por unidad'}</span>
                        ${isOnOffer ? `<span class="original-price">Antes: ${formatPrice(originalPrice)}</span>` : ''}
                    </div>
                    <div class="quality-badges">
                        ${product.category === 'Productos Org√°nicos' ? '<span class="cert-badge organic">üåø Org√°nico</span>' : ''}
                        ${product.origin.includes('local') ? '<span class="cert-badge local">üè† Local</span>' : ''}
                        ${product.seasonal ? '<span class="cert-badge seasonal">üçÉ Fresco</span>' : ''}
                    </div>
                    <div class="product-actions">
                        <a href="${product.detailUrl}" class="view-details-btn" data-id="${product.id}">
                            <i class="fas fa-info-circle"></i> Ver Detalles
                        </a>
                        <button class="add-to-cart-btn" data-id="${product.id}">
                            <i class="fas fa-shopping-cart"></i> Agregar al Carrito
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Funci√≥n para formatear precios
    function formatPrice(price) {
        return `$${price.toLocaleString('es-CL')} CLP`;
    }

    // Funciones de ofertas (importadas del script principal)
    function getOfferPrice(productId) {
        if (typeof window.getOfferPrice === 'function') {
            return window.getOfferPrice(productId);
        }
        return null;
    }

    function getOriginalPrice(productId) {
        if (typeof window.getOriginalPrice === 'function') {
            return window.getOriginalPrice(productId);
        }
        return null;
    }

    function isProductOnOffer(productId) {
        if (typeof window.isProductOnOffer === 'function') {
            return window.isProductOnOffer(productId);
        }
        return false;
    }

    // Funci√≥n para actualizar informaci√≥n de resultados
    function updateResultsInfo(count) {
        if (productsCount) {
            productsCount.textContent = `Mostrando ${count} productos`;
        }
        if (productsTotal) {
            productsTotal.textContent = `de ${allProducts.length} total`;
        }
    }

    // Funci√≥n para aplicar filtros
    function applyFilters() {
        let filteredProducts = allProducts;
        
        if (currentFilters.category && currentFilters.category !== 'all') {
            filteredProducts = allProducts.filter(product => 
                product.category === currentFilters.category
            );
        }
        
        renderProducts(filteredProducts);
    }

    // Funci√≥n para manejar cambio de vista
    function handleViewChange(view) {
        currentFilters.view = view;
        
        // Actualizar botones de vista
        viewButtons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.view === view) {
                btn.classList.add('active');
            }
        });
        
        // Aplicar clase de vista al contenedor
        if (productGrid) {
            productGrid.className = `product-grid content-section ${view}-view`;
        }
        
        // Aplicar estilos espec√≠ficos
        if (view === 'list') {
            applyListViewStyles();
        } else {
            applyGridViewStyles();
        }
    }

    // Funci√≥n para manejar filtros r√°pidos
    function handleQuickFilter(category) {
        currentFilters.category = category;
        
        // Actualizar botones de filtro
        quickFilters.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.category === category) {
                btn.classList.add('active');
            }
        });
        
        applyFilters();
    }

    // Funci√≥n para configurar event listeners
    function setupEventListeners() {
        console.log('Configurando event listeners');
        
        // Filtros r√°pidos
        quickFilters.forEach(btn => {
            btn.addEventListener('click', function() {
                const category = this.dataset.category;
                handleQuickFilter(category);
            });
        });
        
        // Vista de productos
        viewButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const view = this.dataset.view;
                console.log('Cambiando vista a:', view);
                handleViewChange(view);
            });
        });
    }

    // Funci√≥n para aplicar estilos de vista de grid
    function applyGridViewStyles() {
        if (!productGrid) return;
        
        const cards = productGrid.querySelectorAll('.product-card');
        cards.forEach(card => {
            card.style.display = 'block';
            card.style.width = '100%';
            card.style.maxWidth = '100%';
        });
        
        console.log('Estilos de vista de grid aplicados correctamente');
    }

    // Funci√≥n para aplicar estilos de vista de lista
    function applyListViewStyles() {
        if (!productGrid) return;
        
        const cards = productGrid.querySelectorAll('.product-card');
        cards.forEach(card => {
            card.style.display = 'flex';
            card.style.width = '100%';
            card.style.maxWidth = '100%';
            card.style.alignItems = 'center';
            card.style.gap = '1.5rem';
            card.style.padding = '1rem';
            card.style.marginBottom = '1rem';
            
            const img = card.querySelector('img');
            if (img) {
                img.style.width = '120px';
                img.style.height = '120px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '8px';
                img.style.flexShrink = '0';
            }
            
            const productInfo = card.querySelector('.product-info');
            if (productInfo) {
                productInfo.style.flex = '1';
                productInfo.style.display = 'flex';
                productInfo.style.flexDirection = 'column';
                productInfo.style.gap = '0.5rem';
            }
            
            const viewBtn = card.querySelector('.view-details-btn');
            if (viewBtn) {
                viewBtn.style.display = 'flex';
                viewBtn.style.alignItems = 'center';
                viewBtn.style.justifyContent = 'center';
                viewBtn.style.gap = '0.375rem';
                viewBtn.style.flex = '1';
                viewBtn.style.padding = '0.625rem 1rem';
                viewBtn.style.opacity = '1';
                viewBtn.style.visibility = 'visible';
            }
            
            const addBtn = card.querySelector('.add-to-cart-btn');
            if (addBtn) {
                addBtn.style.display = 'flex';
                addBtn.style.alignItems = 'center';
                addBtn.style.justifyContent = 'center';
                addBtn.style.gap = '0.375rem';
                addBtn.style.flex = '1';
                addBtn.style.padding = '0.625rem 1rem';
                addBtn.style.opacity = '1';
                addBtn.style.visibility = 'visible';
            }
        });
        
        console.log('Estilos de vista de lista aplicados correctamente');
    }

    // Inicializar todo
    console.log('Inicializando filtros avanzados...');
    setupEventListeners();
    applyFilters();
    console.log('Filtros avanzados inicializados correctamente');
});