<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auto Logout - HuertoHogar</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; background: #f9f9f9; }
        .btn { padding: 10px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 4px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .status-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .timer-display { font-size: 18px; font-weight: bold; color: #dc3545; }
        .activity-indicator { width: 20px; height: 20px; border-radius: 50%; display: inline-block; margin-left: 10px; }
        .activity-active { background: #28a745; }
        .activity-inactive { background: #dc3545; }
    </style>
</head>
<body>
    <h1>Test de Cierre Automático de Sesión - HuertoHogar</h1>
    
    <div class="test-section">
        <h2>Estado de la Sesión</h2>
        <div id="session-status">
            <p>Estado: <span id="session-state">Iniciando...</span></p>
            <p>Última actividad: <span id="last-activity">-</span></p>
            <p>Timer de inactividad: <span id="inactivity-timer" class="timer-display">-</span></p>
            <p>Actividad: <span id="activity-indicator" class="activity-indicator activity-inactive"></span></p>
        </div>
        <button onclick="startTest()" class="btn btn-primary">Iniciar Test</button>
        <button onclick="simulateActivity()" class="btn btn-warning">Simular Actividad</button>
        <button onclick="clearTest()" class="btn btn-danger">Limpiar Test</button>
    </div>
    
    <div class="test-section">
        <h2>Eventos de Cierre</h2>
        <div id="logout-events">
            <p>Eventos detectados:</p>
            <ul id="events-list">
                <!-- Los eventos se mostrarán aquí -->
            </ul>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Simulación de Eventos</h2>
        <button onclick="simulateBeforeUnload()" class="btn btn-warning">Simular beforeunload</button>
        <button onclick="simulateUnload()" class="btn btn-warning">Simular unload</button>
        <button onclick="simulateBlur()" class="btn btn-warning">Simular blur</button>
        <button onclick="simulateFocus()" class="btn btn-warning">Simular focus</button>
        <button onclick="simulateVisibilityChange()" class="btn btn-warning">Simular visibilitychange</button>
    </div>
    
    <div class="test-section">
        <h2>Configuración de Timers</h2>
        <p>Timer de inactividad general: <strong>10 minutos</strong></p>
        <p>Advertencia antes del cierre: <strong>8 minutos</strong> (2 minutos antes)</p>
        <p>Timer de inactividad por pérdida de foco: <strong>5 minutos</strong></p>
    </div>

    <script>
        let testAdminPanel = null;
        let activityTimer = null;
        let lastActivityTime = Date.now();
        
        // Simular la clase AdminPanel con funcionalidad de auto-logout
        class TestAdminPanel {
            constructor() {
                this.inactivityTimer = null;
                this.warningTimer = null;
                this.lastActivity = Date.now();
                this.isLoggedIn = true;
                
                this.setupAutoLogout();
                this.startGeneralInactivityTimer();
                this.updateDisplay();
            }
            
            setupAutoLogout() {
                console.log('Configurando cierre automático de sesión del admin...');
                
                // Detectar actividad del usuario para reiniciar el timer
                const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
                activityEvents.forEach(event => {
                    document.addEventListener(event, () => {
                        this.resetInactivityTimer();
                    }, true);
                });
                
                // Detectar cuando el usuario intenta salir de la página
                window.addEventListener('beforeunload', (e) => {
                    this.logEvent('beforeunload - Usuario intentando salir de la página');
                    this.logoutAdmin();
                });
                
                // Detectar cuando la página se está descargando
                window.addEventListener('unload', () => {
                    this.logEvent('unload - Página descargándose');
                    this.logoutAdmin();
                });
                
                // Detectar cuando la página pierde el foco
                window.addEventListener('blur', () => {
                    this.logEvent('blur - Página perdió el foco');
                    this.setInactivityTimer();
                });
                
                // Detectar cuando la página recupera el foco
                window.addEventListener('focus', () => {
                    this.logEvent('focus - Página recuperó el foco');
                    this.clearInactivityTimer();
                });
                
                // Detectar cambios de visibilidad de la página
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.logEvent('visibilitychange - Página oculta');
                        this.setInactivityTimer();
                    } else {
                        this.logEvent('visibilitychange - Página visible');
                        this.clearInactivityTimer();
                    }
                });
                
                console.log('Cierre automático de sesión configurado correctamente');
            }
            
            resetInactivityTimer() {
                this.lastActivity = Date.now();
                this.clearInactivityTimer();
                this.startGeneralInactivityTimer();
                this.updateDisplay();
                this.logEvent('Actividad detectada - Timer reiniciado');
            }
            
            startGeneralInactivityTimer() {
                // Cerrar sesión después de 30 segundos para el test (normalmente 10 minutos)
                this.inactivityTimer = setTimeout(() => {
                    this.logEvent('Sesión cerrada por inactividad general (30 segundos)');
                    this.logoutAdmin();
                }, 30 * 1000); // 30 segundos para el test
                
                // Mostrar advertencia 10 segundos antes del cierre
                this.warningTimer = setTimeout(() => {
                    this.showInactivityWarning();
                }, 20 * 1000); // 20 segundos (10 segundos antes del cierre)
            }
            
            showInactivityWarning() {
                this.logEvent('⚠️ ADVERTENCIA: Sesión se cerrará en 10 segundos por inactividad');
                this.showMessage('⚠️ Tu sesión se cerrará en 10 segundos por inactividad. Mueve el mouse o haz clic para mantener la sesión activa.', 'warning');
            }
            
            setInactivityTimer() {
                // Cerrar sesión después de 15 segundos de inactividad por pérdida de foco
                this.inactivityTimer = setTimeout(() => {
                    this.logEvent('Sesión cerrada por inactividad (15 segundos)');
                    this.logoutAdmin();
                }, 15 * 1000); // 15 segundos para el test
            }
            
            clearInactivityTimer() {
                if (this.inactivityTimer) {
                    clearTimeout(this.inactivityTimer);
                    this.inactivityTimer = null;
                }
                if (this.warningTimer) {
                    clearTimeout(this.warningTimer);
                    this.warningTimer = null;
                }
            }
            
            logoutAdmin() {
                this.logEvent('Cerrando sesión del administrador...');
                
                // Limpiar datos de sesión del admin
                localStorage.removeItem('huertoHogarAuth');
                sessionStorage.removeItem('huertoHogarAuth');
                localStorage.removeItem('huertohogar_is_admin');
                localStorage.removeItem('huertohogar_user_role');
                
                // Limpiar timer de inactividad
                this.clearInactivityTimer();
                
                this.isLoggedIn = false;
                this.updateDisplay();
                
                this.logEvent('Sesión del administrador cerrada correctamente');
                this.showMessage('Sesión cerrada automáticamente por seguridad', 'info');
            }
            
            showMessage(message, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `status status-${type}`;
                messageDiv.textContent = message;
                document.body.insertBefore(messageDiv, document.body.firstChild);
                
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
            
            logEvent(message) {
                const eventsList = document.getElementById('events-list');
                const li = document.createElement('li');
                li.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                eventsList.insertBefore(li, eventsList.firstChild);
                
                // Mantener solo los últimos 10 eventos
                while (eventsList.children.length > 10) {
                    eventsList.removeChild(eventsList.lastChild);
                }
                
                console.log(message);
            }
            
            updateDisplay() {
                document.getElementById('session-state').textContent = this.isLoggedIn ? 'Activa' : 'Cerrada';
                document.getElementById('last-activity').textContent = new Date(this.lastActivity).toLocaleTimeString();
                
                const activityIndicator = document.getElementById('activity-indicator');
                if (this.isLoggedIn) {
                    activityIndicator.className = 'activity-indicator activity-active';
                } else {
                    activityIndicator.className = 'activity-indicator activity-inactive';
                }
                
                // Mostrar tiempo restante
                if (this.inactivityTimer && this.isLoggedIn) {
                    const timeLeft = this.getTimeLeft();
                    document.getElementById('inactivity-timer').textContent = timeLeft;
                } else {
                    document.getElementById('inactivity-timer').textContent = '-';
                }
            }
            
            getTimeLeft() {
                // Esta es una aproximación simple
                return 'Calculando...';
            }
        }
        
        function startTest() {
            if (testAdminPanel) {
                clearTest();
            }
            
            testAdminPanel = new TestAdminPanel();
            testAdminPanel.logEvent('Test iniciado');
            
            // Actualizar display cada segundo
            activityTimer = setInterval(() => {
                if (testAdminPanel) {
                    testAdminPanel.updateDisplay();
                }
            }, 1000);
        }
        
        function clearTest() {
            if (testAdminPanel) {
                testAdminPanel.clearInactivityTimer();
                testAdminPanel = null;
            }
            
            if (activityTimer) {
                clearInterval(activityTimer);
                activityTimer = null;
            }
            
            document.getElementById('session-state').textContent = 'Iniciando...';
            document.getElementById('last-activity').textContent = '-';
            document.getElementById('inactivity-timer').textContent = '-';
            document.getElementById('activity-indicator').className = 'activity-indicator activity-inactive';
            document.getElementById('events-list').innerHTML = '';
        }
        
        function simulateActivity() {
            if (testAdminPanel) {
                testAdminPanel.resetInactivityTimer();
            }
        }
        
        function simulateBeforeUnload() {
            if (testAdminPanel) {
                window.dispatchEvent(new Event('beforeunload'));
            }
        }
        
        function simulateUnload() {
            if (testAdminPanel) {
                window.dispatchEvent(new Event('unload'));
            }
        }
        
        function simulateBlur() {
            if (testAdminPanel) {
                window.dispatchEvent(new Event('blur'));
            }
        }
        
        function simulateFocus() {
            if (testAdminPanel) {
                window.dispatchEvent(new Event('focus'));
            }
        }
        
        function simulateVisibilityChange() {
            if (testAdminPanel) {
                // Simular que la página se oculta
                Object.defineProperty(document, 'hidden', {
                    writable: true,
                    value: true
                });
                document.dispatchEvent(new Event('visibilitychange'));
                
                // Después de 2 segundos, simular que vuelve a ser visible
                setTimeout(() => {
                    Object.defineProperty(document, 'hidden', {
                        writable: true,
                        value: false
                    });
                    document.dispatchEvent(new Event('visibilitychange'));
                }, 2000);
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Test de auto-logout cargado');
        });
    </script>
</body>
</html>
