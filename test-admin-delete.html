<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Admin Delete - HuertoHogar</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/admin-panel.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="admin-main" style="padding: 20px;">
        <h1>Test de Eliminación - Panel Admin</h1>
        
        <div class="debug-info" style="background: #f0f0f0; padding: 15px; margin: 20px 0; border-radius: 5px;">
            <h3>Estado del Sistema:</h3>
            <p>Productos: <span id="product-count">0</span></p>
            <p>Papelera: <span id="trash-count">0</span></p>
            <p>AdminPanel: <span id="admin-status">No inicializado</span></p>
        </div>
        
        <div class="products-container">
            <div class="products-header">
                <h2>Lista de Productos</h2>
                <div class="products-actions">
                    <button id="view-trash-btn" class="btn btn-outline">
                        <i class="fas fa-trash"></i>
                        Papelera (<span id="trash-count-display">0</span>)
                    </button>
                </div>
            </div>
            
            <div class="products-table-container">
                <table class="products-table" id="products-table">
                    <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Nombre</th>
                            <th>Categoría</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Estado</th>
                            <th>Destacado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="products-tbody">
                        <!-- Los productos se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Eliminación -->
    <div id="delete-modal" class="modal-overlay" style="display: none;">
        <div class="modal-container delete-modal">
            <div class="modal-header">
                <h2>Confirmar Eliminación</h2>
                <button class="close-btn" id="close-delete-modal">×</button>
            </div>
            <div class="modal-body">
                <div class="delete-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>¿Estás seguro de que deseas eliminar este producto?</p>
                    <p class="delete-product-name" id="delete-product-name"></p>
                    <p class="delete-warning-text">Esta acción no se puede deshacer.</p>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-delete">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete">
                        <i class="fas fa-trash"></i>
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Papelera -->
    <div id="trash-modal" class="modal-overlay" style="display: none;">
        <div class="modal-container trash-modal">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-trash"></i>
                    Papelera de Productos
                </h2>
                <button class="close-btn" id="close-trash-modal">×</button>
            </div>
            <div class="modal-body">
                <div class="trash-info">
                    <p>Productos eliminados recientemente. Puedes recuperarlos o eliminarlos permanentemente.</p>
                </div>
                
                <div class="trash-table-container">
                    <table class="trash-table" id="trash-table">
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>Precio</th>
                                <th>Eliminado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="trash-tbody">
                            <!-- Los productos eliminados se cargarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
                
                <div class="trash-empty" id="trash-empty" style="display: none;">
                    <div class="empty-state">
                        <i class="fas fa-trash-alt"></i>
                        <h3>Papelera Vacía</h3>
                        <p>No hay productos eliminados</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simular la clase AdminPanel
        class TestAdminPanel {
            constructor() {
                this.products = [
                    {
                        id: 1,
                        name: "Manzanas Fuji",
                        category: "Frutas Frescas",
                        price: 2500,
                        stock: 50,
                        image: "https://images.pexels.com/photos/102104/pexels-photo-102104.jpeg?auto=compress&cs=tinysrgb&w=400",
                        unit: "kg",
                        description: "Manzanas Fuji frescas y crujientes, perfectas para el consumo diario.",
                        features: ["Fresco", "De temporada", "Nutritivo"],
                        featured: true,
                        active: true,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: "Espinacas Orgánicas",
                        category: "Verduras Orgánicas",
                        price: 1800,
                        stock: 30,
                        image: "https://images.pexels.com/photos/2325840/pexels-photo-2325840.jpeg?auto=compress&cs=tinysrgb&w=400",
                        unit: "kg",
                        description: "Espinacas orgánicas cultivadas sin pesticidas, ricas en hierro y vitaminas.",
                        features: ["Orgánico", "Sin pesticidas", "Rico en hierro"],
                        featured: false,
                        active: true,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 3,
                        name: "Miel Orgánica",
                        category: "Productos Orgánicos",
                        price: 4500,
                        stock: 20,
                        image: "https://images.pexels.com/photos/33783/honey-jar-honey-comb-beeswax-bee-hive.jpg?auto=compress&cs=tinysrgb&w=400",
                        unit: "unidad",
                        description: "Miel pura de abejas, endulzante natural sin procesar.",
                        features: ["Natural", "Sin procesar", "Endulzante natural"],
                        featured: true,
                        active: true,
                        createdAt: new Date().toISOString()
                    }
                ];
                
                this.trashProducts = [];
                this.filteredProducts = [...this.products];
                
                // Elementos del DOM
                this.elements = {
                    productsTbody: document.getElementById('products-tbody'),
                    trashTbody: document.getElementById('trash-tbody'),
                    trashEmpty: document.getElementById('trash-empty'),
                    trashCount: document.getElementById('trash-count-display'),
                    deleteModal: document.getElementById('delete-modal'),
                    deleteProductName: document.getElementById('delete-product-name'),
                    confirmDelete: document.getElementById('confirm-delete'),
                    closeDeleteModal: document.getElementById('close-delete-modal'),
                    cancelDelete: document.getElementById('cancel-delete'),
                    trashModal: document.getElementById('trash-modal'),
                    closeTrashModal: document.getElementById('close-trash-modal'),
                    viewTrashBtn: document.getElementById('view-trash-btn')
                };
                
                this.init();
            }
            
            init() {
                console.log('TestAdminPanel inicializado');
                this.setupEventListeners();
                this.renderProducts();
                this.updateTrashCount();
                this.updateDebugInfo();
            }
            
            setupEventListeners() {
                // Botón de confirmar eliminación
                this.elements.confirmDelete.addEventListener('click', () => {
                    console.log('Botón confirmDelete clickeado');
                    this.deleteProduct();
                });
                
                // Botón de cancelar eliminación
                this.elements.cancelDelete.addEventListener('click', () => {
                    console.log('Botón cancelDelete clickeado');
                    this.closeDeleteModal();
                });
                
                // Botón de cerrar modal de eliminación
                this.elements.closeDeleteModal.addEventListener('click', () => {
                    console.log('Botón closeDeleteModal clickeado');
                    this.closeDeleteModal();
                });
                
                // Botón de ver papelera
                this.elements.viewTrashBtn.addEventListener('click', () => {
                    console.log('Botón viewTrashBtn clickeado');
                    this.openTrashModal();
                });
                
                // Botón de cerrar papelera
                this.elements.closeTrashModal.addEventListener('click', () => {
                    console.log('Botón closeTrashModal clickeado');
                    this.closeTrashModal();
                });
                
                console.log('Event listeners configurados');
            }
            
            renderProducts() {
                console.log('Renderizando productos...');
                this.elements.productsTbody.innerHTML = '';
                
                this.filteredProducts.forEach(product => {
                    const row = this.createProductRow(product);
                    this.elements.productsTbody.appendChild(row);
                });
                
                console.log(`Productos renderizados: ${this.filteredProducts.length}`);
            }
            
            createProductRow(product) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <img src="${product.image}" alt="${product.name}" class="product-image" 
                             onerror="this.src='https://via.placeholder.com/60x60?text=Sin+Imagen'">
                    </td>
                    <td>
                        <div class="product-name">${product.name}</div>
                        <div class="product-category">${product.category}</div>
                    </td>
                    <td>${product.category}</td>
                    <td class="product-price">$${product.price.toLocaleString('es-CL')}</td>
                    <td class="product-stock">${product.stock} ${product.unit}</td>
                    <td>
                        <span class="product-status ${product.active ? 'active' : 'inactive'}">
                            ${product.active ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>
                        <span class="product-featured ${product.featured ? 'yes' : 'no'}">
                            ${product.featured ? 'Sí' : 'No'}
                        </span>
                    </td>
                    <td>
                        <div class="product-actions">
                            <button class="btn-action btn-edit" onclick="testAdminPanel.editProduct(${product.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="testAdminPanel.confirmDeleteProduct(${product.id})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                return row;
            }
            
            confirmDeleteProduct(productId) {
                console.log('confirmDeleteProduct() llamado con ID:', productId);
                console.log('Products array:', this.products);
                
                const product = this.products.find(p => p.id === productId);
                console.log('Producto encontrado:', product);
                
                if (product) {
                    this.elements.deleteProductName.textContent = product.name;
                    this.elements.deleteModal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    
                    // Guardar el ID del producto a eliminar
                    this.elements.confirmDelete.dataset.productId = productId;
                    console.log('Modal de eliminación abierto para:', product.name);
                } else {
                    console.error('Producto no encontrado:', productId);
                    alert('Error: Producto no encontrado');
                }
            }
            
            closeDeleteModal() {
                this.elements.deleteModal.style.display = 'none';
                document.body.style.overflow = '';
                this.elements.confirmDelete.dataset.productId = '';
                console.log('Modal de eliminación cerrado');
            }
            
            deleteProduct() {
                console.log('deleteProduct() llamado');
                const productId = parseInt(this.elements.confirmDelete.dataset.productId);
                console.log('Product ID:', productId);
                console.log('Products array:', this.products);
                
                const index = this.products.findIndex(p => p.id === productId);
                console.log('Index encontrado:', index);
                
                if (index !== -1) {
                    const product = this.products[index];
                    const productName = product.name;
                    console.log('Producto a eliminar:', productName);
                    
                    // Agregar fecha de eliminación
                    product.deletedAt = new Date().toISOString();
                    product.deletedBy = 'admin';
                    
                    // Mover a la papelera
                    this.trashProducts.push(product);
                    console.log('Producto agregado a la papelera');
                    
                    // Eliminar de la lista principal
                    this.products.splice(index, 1);
                    this.filteredProducts = [...this.products];
                    
                    // Actualizar vistas
                    this.renderProducts();
                    this.updateTrashCount();
                    this.updateDebugInfo();
                    this.closeDeleteModal();
                    
                    console.log('Producto eliminado exitosamente');
                    alert(`Producto "${productName}" movido a la papelera.`);
                } else {
                    console.error('Error al eliminar producto:', productId);
                    alert('Error: No se pudo eliminar el producto');
                }
            }
            
            openTrashModal() {
                this.elements.trashModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                this.renderTrashProducts();
                console.log('Modal de papelera abierto');
            }
            
            closeTrashModal() {
                this.elements.trashModal.style.display = 'none';
                document.body.style.overflow = '';
                console.log('Modal de papelera cerrado');
            }
            
            renderTrashProducts() {
                if (this.trashProducts.length === 0) {
                    this.elements.trashTbody.innerHTML = '';
                    this.elements.trashEmpty.style.display = 'block';
                    return;
                }
                
                this.elements.trashEmpty.style.display = 'none';
                this.elements.trashTbody.innerHTML = '';
                
                this.trashProducts.forEach((product, index) => {
                    const row = this.createTrashRow(product, index);
                    this.elements.trashTbody.appendChild(row);
                });
                
                console.log(`Productos en papelera renderizados: ${this.trashProducts.length}`);
            }
            
            createTrashRow(product, index) {
                const row = document.createElement('tr');
                row.dataset.productId = product.id;
                
                const deletedDate = new Date(product.deletedAt).toLocaleDateString('es-CL', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                row.innerHTML = `
                    <td>
                        <img src="${product.image}" alt="${product.name}" class="trash-product-image" 
                             onerror="this.src='https://via.placeholder.com/50x50?text=Sin+Imagen'">
                    </td>
                    <td>
                        <div class="trash-product-name">${product.name}</div>
                        <div class="trash-product-category">${product.category}</div>
                    </td>
                    <td>${product.category}</td>
                    <td class="trash-product-price">$${product.price.toLocaleString('es-CL')}</td>
                    <td class="trash-deleted-date">${deletedDate}</td>
                    <td>
                        <div class="trash-actions-cell">
                            <button class="btn-restore" onclick="testAdminPanel.restoreProduct(${product.id})" title="Recuperar">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="btn-delete-permanent" onclick="testAdminPanel.deleteProductPermanently(${product.id})" title="Eliminar permanentemente">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                return row;
            }
            
            restoreProduct(productId) {
                console.log('restoreProduct() llamado con ID:', productId);
                const index = this.trashProducts.findIndex(p => p.id === productId);
                if (index !== -1) {
                    const product = this.trashProducts[index];
                    const productName = product.name;
                    
                    // Remover propiedades de eliminación
                    delete product.deletedAt;
                    delete product.deletedBy;
                    
                    // Agregar de vuelta a la lista principal
                    this.products.push(product);
                    this.filteredProducts = [...this.products];
                    
                    // Remover de la papelera
                    this.trashProducts.splice(index, 1);
                    
                    // Actualizar vistas
                    this.renderTrashProducts();
                    this.renderProducts();
                    this.updateTrashCount();
                    this.updateDebugInfo();
                    
                    console.log('Producto recuperado exitosamente');
                    alert(`Producto "${productName}" recuperado exitosamente.`);
                }
            }
            
            deleteProductPermanently(productId) {
                if (confirm('¿Estás seguro de que deseas eliminar este producto permanentemente? Esta acción no se puede deshacer.')) {
                    const index = this.trashProducts.findIndex(p => p.id === productId);
                    if (index !== -1) {
                        const productName = this.trashProducts[index].name;
                        this.trashProducts.splice(index, 1);
                        this.renderTrashProducts();
                        this.updateTrashCount();
                        this.updateDebugInfo();
                        console.log('Producto eliminado permanentemente');
                        alert(`Producto "${productName}" eliminado permanentemente.`);
                    }
                }
            }
            
            editProduct(productId) {
                console.log('editProduct() llamado con ID:', productId);
                alert('Función de edición no implementada en este test');
            }
            
            updateTrashCount() {
                if (this.elements.trashCount) {
                    this.elements.trashCount.textContent = this.trashProducts.length;
                }
            }
            
            updateDebugInfo() {
                document.getElementById('product-count').textContent = this.products.length;
                document.getElementById('trash-count').textContent = this.trashProducts.length;
                document.getElementById('admin-status').textContent = 'Inicializado';
            }
        }
        
        // Inicializar el panel de prueba
        let testAdminPanel;
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM cargado, inicializando TestAdminPanel...');
            testAdminPanel = new TestAdminPanel();
            window.testAdminPanel = testAdminPanel;
            console.log('TestAdminPanel inicializado:', testAdminPanel);
        });
    </script>
</body>
</html>
